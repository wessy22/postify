<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>ניהול פוסטים</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/he.js"></script>
    
    <style>
        /* תיקון Mixed Content - הסתרת אלמנטים שנטענים ב-HTTP */
        [src^="http://"], [href^="http://"] {
            display: none !important;
        }
        
        /* סגנונות בסיסיים לעמוד */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            line-height: 1.6;
            width: 100vw;
            min-height: 100vh;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

<script>
// תיקון Mixed Content באמצעות JavaScript
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 Starting advanced Mixed Content fixes...');
    
    // פונקציה לתיקון אלמנט יחיד
    function fixElement(element, attribute) {
        const originalValue = element[attribute];
        if (originalValue && originalValue.startsWith('http://')) {
            const newValue = originalValue.replace('http://', 'https://');
            element[attribute] = newValue;
            console.log(`✅ Fixed ${attribute}:`, originalValue, '→', newValue);
            return true;
        }
        return false;
    }
    
    // תיקון מיידי של אלמנטים קיימים
    function fixExistingElements() {
        let fixedCount = 0;
        
        // CSS links
        document.querySelectorAll('link[href^="http://"]').forEach(link => {
            if (fixElement(link, 'href')) fixedCount++;
        });
        
        // Scripts
        document.querySelectorAll('script[src^="http://"]').forEach(script => {
            if (fixElement(script, 'src')) fixedCount++;
        });
        
        // Images
        document.querySelectorAll('img[src^="http://"]').forEach(img => {
            if (fixElement(img, 'src')) fixedCount++;
        });
        
        // Other elements
        document.querySelectorAll('[src^="http://"], [href^="http://"]').forEach(element => {
            ['src', 'href'].forEach(attr => {
                if (element[attr]) fixElement(element, attr);
            });
        });
        
        if (fixedCount > 0) {
            console.log(`🎯 Fixed ${fixedCount} HTTP elements to HTTPS`);
        }
    }
    
    // הפעל תיקון ראשוני
    fixExistingElements();
    
    // תיקון רציף כל 3 שניות
    setInterval(fixExistingElements, 3000);
    
    // מאזין לשגיאות Mixed Content
    window.addEventListener('error', function(e) {
        if (e.target && e.target.src && e.target.src.startsWith('http://')) {
            console.warn('⚠️ Mixed Content blocked, attempting fix:', e.target.src);
            fixElement(e.target, 'src');
        }
    }, true);
    
    // טיפול במשאבי CSS שנטענים דינמית
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) { // Element node
                    if (node.tagName === 'LINK' && node.href && node.href.startsWith('http://')) {
                        fixElement(node, 'href');
                    }
                    if (node.tagName === 'SCRIPT' && node.src && node.src.startsWith('http://')) {
                        fixElement(node, 'src');
                    }
                }
            });
        });
    });
    
    observer.observe(document.head, { childList: true, subtree: true });
    observer.observe(document.body, { childList: true, subtree: true });
    
    console.log('✅ Advanced Mixed Content protection active');
});

function formatAIText(text) {
  let html = text
    .replace(/\r\n/g, '\n')
    .replace(/\n{2,}/g, '\n\n')
    .replace(/(^|\n)- /g, '$1• ')
    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
    .replace(/\n/g, '<br>');
  return `<div style="white-space:pre-line;font-size:1.13em;line-height:1.7;direction:rtl;text-align:right">${html}</div>`;
}

// פונקציה פשוטה לטיפול בנתיבי מדיה
function getMediaSrc(mediaPath) {
    if (!mediaPath) return '';
    
    console.log('🖼️ Processing media path:', mediaPath);
    
    // אם זה כבר URL מלא עם http/https
    if (mediaPath.startsWith('http')) {
        console.log('✅ Using full URL:', mediaPath);
        return mediaPath;
    }
    
    // אם זה מתחיל ב-/wp-content (נתיב מלא)
    if (mediaPath.startsWith('/wp-content')) {
        console.log('✅ Using wp-content path:', mediaPath);
        return mediaPath;
    }
    
    // במקרים אחרים, הוסף את הנתיב המלא
    const finalPath = `/wp-content/postify-api/${mediaPath}`;
    console.log('✅ Added full path:', mediaPath, '→', finalPath);
    return finalPath;
}
</script>
<div class="posts-container">
  <div style="display:flex;align-items:center;justify-content:space-between;margin:18px 0 22px 0;flex-wrap:wrap;gap:15px;">
    <button class="add-post-btn" id="add-post-btn" style="background: #0b2743; color: #fff; border: none; border-radius: 11px; padding: 9px 23px; font-size: 1.12em; font-weight: bold; box-shadow: 0 2px 8px #41d6c312;">➕ הוסף פוסט חדש</button>
    
    <div style="position:relative;">
      <button id="filter-toggle" style="background:#0b2743;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:8px;box-shadow:0 2px 8px rgba(11,39,67,0.2);">
        🔍 סינון פוסטים <span style="font-size:0.8em;">▼</span>
      </button>
      
      <div id="filter-dropdown" style="display:none;position:absolute;top:45px;left:0;background:#fff;border:1px solid #ddd;border-radius:8px;padding:15px;box-shadow:0 4px 20px rgba(0,0,0,0.1);z-index:1000;min-width:280px;">
        <div style="font-weight:bold;margin-bottom:12px;color:#333;border-bottom:1px solid #eee;padding-bottom:8px;">בחר סטטוסים להצגה:</div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:15px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;border-radius:5px;transition:background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
            <input type="checkbox" class="status-filter" value="active" checked style="transform:scale(1.1);"> 
            <span style="display:flex;align-items:center;gap:5px;">🟢 <strong>פעיל</strong></span>
          </label>
          
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;border-radius:5px;transition:background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
            <input type="checkbox" class="status-filter" value="paused" checked style="transform:scale(1.1);"> 
            <span style="display:flex;align-items:center;gap:5px;">⏸️ <strong>מושבת</strong></span>
          </label>
          
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;border-radius:5px;transition:background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
            <input type="checkbox" class="status-filter" value="scheduled" checked style="transform:scale(1.1);"> 
            <span style="display:flex;align-items:center;gap:5px;">⏰ <strong>מתוזמן</strong></span>
          </label>
          
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;border-radius:5px;transition:background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
            <input type="checkbox" class="status-filter" value="finished" checked style="transform:scale(1.1);"> 
            <span style="display:flex;align-items:center;gap:5px;">✅ <strong>הסתיים</strong></span>
          </label>
        </div>
        
        <div style="display:flex;gap:8px;border-top:1px solid #eee;padding-top:12px;">
          <button id="select-all-filters" style="background:#28a745;color:#fff;border:none;border-radius:5px;padding:6px 12px;font-size:0.85em;flex:1;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">✓ בחר הכל</button>
          <button id="clear-filters" style="background:#6c757d;color:#fff;border:none;border-radius:5px;padding:6px 12px;font-size:0.85em;flex:1;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">✗ נקה הכל</button>
        </div>
      </div>
    </div>
  </div>
  <div id="posts-area"></div>
</div>

<style>
  @media (max-width: 768px) {
    .posts-container > div:first-child {
      flex-direction: column !important;
      align-items: stretch !important;
      gap: 15px !important;
    }
    
    .post-card-collapsed > div {
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 8px !important;
    }
    
    .post-card-collapsed > div > div {
      width: 100% !important;
      max-width: none !important;
      white-space: normal !important;
    }
    
    #filter-dropdown {
      left: auto !important;
      right: 0 !important;
      min-width: 250px !important;
    }
  }
  
  @media (max-width: 480px) {
    #filter-dropdown {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      max-width: 90vw !important;
      max-height: 80vh !important;
      overflow-y: auto !important;
    }
  }
</style>

<script>
let hostname = "";
let collections = [];
let allPosts = [];

// צור פופאפ AI פעם אחת בלבד בהתחלה
(function createAiModalOnce(){
  if (document.getElementById("ai-upgrade-modal")) return;
  const modal = document.createElement("div");
  modal.id = "ai-upgrade-modal";
  modal.style.cssText = "display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;";
  modal.innerHTML = `
  <div id="ai-modal-box" style="position:relative;background:#fff;padding:20px;border-radius:13px;max-width:500px;max-height:80vh;overflow-y:auto;">
    <button id="ai-before-after-btn" style="position:absolute;top:12px;left:12px;z-index:2;display:none;background:#e6f0fa;border:none;border-radius:7px;padding:6px 13px;font-weight:bold;cursor:pointer;">לפני-אחרי</button>
    <div id="ai-modal-content" style="margin-top:40px;"></div>
    <div style="margin-top:18px;text-align:left;">
      <button id="ai-upgrade-apply" style="background:#0b2743;color:#fff;border:none;border-radius:7px;padding:7px 15px;margin-left:8px;">שדרג</button>
      <button id="ai-upgrade-cancel" style="background:#ccc;border:none;border-radius:7px;padding:7px 15px;">בטל</button>
    </div>
  </div>
  `;
  document.body.appendChild(modal);
})();

// צור פופאפ סטטוס מודרני ומקצועי
(function createStatusModalOnce(){
  if (document.getElementById("status-modal")) return;
  const modal = document.createElement("div");
  modal.id = "status-modal";
  modal.style.cssText = "display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(11,39,67,0.7);z-index:9999;backdrop-filter:blur(12px) saturate(180%) brightness(0.8);transition:all 0.4s ease;";
  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,251,255,0.9) 100%);
      backdrop-filter: blur(20px) saturate(120%);
      padding: 0;
      border-radius: 24px;
      max-width: 580px;
      margin: 40px auto 0 auto;
      box-shadow: 
        0 32px 64px rgba(11,39,67,0.2), 
        0 16px 32px rgba(11,39,67,0.1),
        inset 0 1px 0 rgba(255,255,255,0.6);
      position: relative;
      max-height: 85vh;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.4);
      transform-style: preserve-3d;
    ">
      <!-- Header -->
      <div style="
        background: linear-gradient(135deg, #0b2743 0%, #1a3a5c 100%);
        padding: 24px 32px;
        color: white;
        position: relative;
        border-radius: 24px 24px 0 0;
      ">
        <button id="close-status-modal" style="
          position: absolute;
          top: 16px;
          left: 16px;
          background: rgba(255,255,255,0.1);
          border: none;
          border-radius: 50%;
          width: 36px;
          height: 36px;
          color: white;
          font-size: 18px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.3s ease;
          backdrop-filter: blur(10px);
        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">×</button>
        
        <div style="text-align: center;">
          <div style="font-size: 32px; margin-bottom: 8px;">⏰</div>
          <h2 style="margin: 0; font-size: 1.4em; font-weight: 600;">תזמון פרסום פוסט</h2>
          <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 0.95em;">בחר כיצד ומתי הפוסט יתפרסם ברשתות החברתיות</p>
        </div>
      </div>

      <!-- Content -->
      <div style="padding: 32px; overflow-y: auto; max-height: calc(85vh - 220px); min-height: 300px;">
        
        <!-- Status Options -->
        <div style="display: grid; gap: 16px; margin-bottom: 24px;">
          
          <!-- Active Status -->
          <label class="status-option" data-status="active" style="
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #e0f2fe;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(34,197,94,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            <div style="
              background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
              border-radius: 50%;
              width: 48px;
              height: 48px;
              display: flex;
              align-items: center;
              justify-content: center;
              margin-left: 16px;
              box-shadow: 0 4px 12px rgba(34,197,94,0.3);
            ">
              <span style="font-size: 20px;">🚀</span>
            </div>
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; margin-bottom: 6px;">
                <input type="radio" name="status-choice" value="active" style="margin-left: 8px; transform: scale(1.2);">
                <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: #059669;">פעיל מיד</h3>
              </div>
              <p style="margin: 0; font-size: 0.9em; color: #065f46; opacity: 0.8;">הפוסט יתפרסם מיד לפי לוח הזמנים הרגיל של המערכת</p>
            </div>
          </label>

          <!-- Scheduled Status -->
          <label class="status-option" data-status="scheduled" style="
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
            border: 2px solid #fcd34d;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(245,158,11,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            <div style="
              background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
              border-radius: 50%;
              width: 48px;
              height: 48px;
              display: flex;
              align-items: center;
              justify-content: center;
              margin-left: 16px;
              box-shadow: 0 4px 12px rgba(245,158,11,0.3);
            ">
              <span style="font-size: 20px;">⏰</span>
            </div>
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; margin-bottom: 6px;">
                <input type="radio" name="status-choice" value="scheduled" style="margin-left: 8px; transform: scale(1.2);">
                <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: #d97706;">תזמון מותאם אישית</h3>
              </div>
              <p style="margin: 0; font-size: 0.9em; color: #92400e; opacity: 0.8;">קבע תאריכים וזמנים מדויקים לפרסום הפוסט</p>
            </div>
          </label>

          <!-- Paused Status -->
          <label class="status-option" data-status="paused" style="
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(107,114,128,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            <div style="
              background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
              border-radius: 50%;
              width: 48px;
              height: 48px;
              display: flex;
              align-items: center;
              justify-content: center;
              margin-left: 16px;
              box-shadow: 0 4px 12px rgba(107,114,128,0.3);
            ">
              <span style="font-size: 20px;">⏸️</span>
            </div>
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; margin-bottom: 6px;">
                <input type="radio" name="status-choice" value="paused" style="margin-left: 8px; transform: scale(1.2);">
                <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: #4b5563;">מושבת זמנית</h3>
              </div>
              <p style="margin: 0; font-size: 0.9em; color: #374151; opacity: 0.8;">הפוסט לא יתפרסם כלל עד שתשנה את הסטטוס</p>
            </div>
          </label>

        </div>

        <!-- Schedule Options -->
        <div id="schedule-options" style="display:none; margin-top: 24px;">
          <div style="
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
            border: 1px solid #fcd34d;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
          ">
            <h3 style="margin: 0 0 16px 0; color: #92400e; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 20px;">⚙️</span>
              הגדרות תזמון
            </h3>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #92400e;">סוג התזמון:</label>
              <select id="schedule-type-select" style="
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #fcd34d;
                border-radius: 12px;
                font-size: 1em;
                background: white;
                transition: all 0.3s ease;
              " onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 0 0 3px rgba(245,158,11,0.1)'" onblur="this.style.borderColor='#fcd34d'; this.style.boxShadow='none'">
                <option value="weekly">📅 שבועי - פרסום בימים קבועים בשבוע</option>
                <option value="monthly">🗓️ חודשי - פרסום באותו תאריך כל חודש</option>
                <option value="one-time">🎯 חד־פעמי - פרסום פעם אחת בתאריך מסוים</option>
              </select>
            </div>
            
            <div id="schedule-fields" style="margin-top: 16px;"></div>
          </div>
        </div>

      </div>

      <!-- Footer -->
      <div style="
        background: #f8fafc;
        padding: 20px 32px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: center;
        gap: 12px;
        border-radius: 0 0 24px 24px;
      ">
        <button id="status-cancel-btn" style="
          background: #f1f5f9;
          color: #475569;
          border: 2px solid #e2e8f0;
          border-radius: 12px;
          padding: 12px 24px;
          font-size: 1em;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          min-width: 120px;
        " class="ripple-effect" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">ביטול</button>
        
        <button id="status-apply-btn" style="
          background: linear-gradient(135deg, #0b2743 0%, #1a3a5c 100%);
          color: white;
          border: none;
          border-radius: 12px;
          padding: 12px 32px;
          font-size: 1em;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 12px rgba(11,39,67,0.3);
          min-width: 120px;
        " class="ripple-effect" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(11,39,67,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(11,39,67,0.3)'">
          <span style="margin-left: 8px;">✅</span>
          אישור
        </button>
      </div>

    </div>
  `;
  document.body.appendChild(modal);
  
  // Debug: בדוק שהכפתורים קיימים
  console.log('🔍 בדיקת כפתורים:', {
    applyBtn: modal.querySelector("#status-apply-btn"),
    cancelBtn: modal.querySelector("#status-cancel-btn"),
    closeBtn: modal.querySelector("#close-status-modal")
  });

  // הוסף סטיילים לאנימציות
  const style = document.createElement('style');
  style.textContent = `
    .status-option input[type="radio"]:checked {
      accent-color: currentColor;
    }
    .status-option[data-status="active"] input[type="radio"]:checked ~ * {
      color: #059669 !important;
    }
    .status-option[data-status="active"].selected {
      border-color: #22c55e !important;
      box-shadow: 0 0 0 3px rgba(34,197,94,0.1) !important;
      transform: translateY(-2px) !important;
    }
    .status-option[data-status="scheduled"].selected {
      border-color: #f59e0b !important;
      box-shadow: 0 0 0 3px rgba(245,158,11,0.1) !important;
      transform: translateY(-2px) !important;
    }
    .status-option[data-status="paused"].selected {
      border-color: #6b7280 !important;
      box-shadow: 0 0 0 3px rgba(107,114,128,0.1) !important;
      transform: translateY(-2px) !important;
    }
    
    /* אנימציות מתקדמות */
    @keyframes modalShow {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    @keyframes modalHide {
      from {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
      to {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
      }
    }
    
    @keyframes blurIn {
      from {
        backdrop-filter: blur(0px) saturate(100%) brightness(1);
        background: rgba(11,39,67,0);
      }
      to {
        backdrop-filter: blur(16px) saturate(180%) brightness(0.7);
        background: rgba(11,39,67,0.75);
      }
    }
    
    @keyframes blurOut {
      from {
        backdrop-filter: blur(16px) saturate(180%) brightness(0.7);
        background: rgba(11,39,67,0.75);
      }
      to {
        backdrop-filter: blur(0px) saturate(100%) brightness(1);
        background: rgba(11,39,67,0);
      }
    }
    
    #status-modal.show {
      animation: blurIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    #status-modal.show > div {
      animation: modalShow 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    #status-modal.hiding {
      animation: blurOut 0.4s ease-in;
    }
    
    #status-modal.hiding > div {
      animation: modalHide 0.3s ease-in;
    }
    
    /* אפקטי לחיצה לכפתורים */
    #status-apply-btn:active {
      transform: translateY(0px) scale(0.98) !important;
      box-shadow: 0 2px 8px rgba(11,39,67,0.3) !important;
    }
    
    #status-cancel-btn:active {
      transform: scale(0.98) !important;
    }
    
    #close-status-modal:active {
      transform: scale(0.9) !important;
    }
    
    /* אנימציה לשדות תזמון */
    #schedule-options {
      transition: all 0.4s ease;
    }
    
    #schedule-options.show {
      animation: slideDown 0.4s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
        max-height: 0;
      }
      to {
        opacity: 1;
        transform: translateY(0);
        max-height: 800px;
      }
    }
    
    /* אפקטי hover מעודנים */
    .status-option {
      position: relative;
      overflow: hidden;
    }
    
    .status-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, transparent 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .status-option:hover::before {
      opacity: 1;
    }
    
    /* אפקט ריפל לכפתורים */
    .ripple-effect {
      position: relative;
      overflow: hidden;
    }
    
    .ripple-effect::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }
    
    .ripple-effect:active::after {
      width: 200px;
      height: 200px;
    }
    
    /* Responsive Design למובייל */
    @media (max-width: 768px) {
      #status-modal > div {
        margin: 20px auto 0 auto !important;
        max-width: 95vw !important;
        max-height: 90vh !important;
      }
      
      #status-modal > div > div:first-child {
        padding: 20px 24px !important;
      }
      
      #status-modal > div > div:nth-child(2) {
        padding: 24px !important;
      }
      
      .status-option {
        padding: 16px !important;
      }
      
      .status-option > div:first-child {
        width: 40px !important;
        height: 40px !important;
        margin-left: 12px !important;
      }
      
      .status-option h3 {
        font-size: 1em !important;
      }
      
      .status-option p {
        font-size: 0.85em !important;
      }
      
      #status-modal > div > div:last-child {
        padding: 16px 24px !important;
        flex-direction: column !important;
        gap: 8px !important;
      }
      
      #status-apply-btn, #status-cancel-btn {
        min-width: 100% !important;
        margin: 0 !important;
      }
    }
    
    @media (max-width: 480px) {
      #status-modal > div {
        margin: 10px auto 0 auto !important;
        border-radius: 16px !important;
      }
      
      #status-modal > div > div:first-child {
        border-radius: 16px 16px 0 0 !important;
      }
      
      #status-modal > div > div:last-child {
        border-radius: 0 0 16px 16px !important;
      }
    }
    
    /* Glass Effect Enhancement */
    #status-modal > div {
      position: relative;
    }
    
    #status-modal > div::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        rgba(255,255,255,0.4) 0%,
        rgba(255,255,255,0.1) 50%,
        rgba(255,255,255,0.2) 100%);
      border-radius: 24px;
      pointer-events: none;
      z-index: 1;
    }
    
    #status-modal > div > * {
      position: relative;
      z-index: 2;
    }
    
    /* Enhanced Header Glass Effect */
    #status-modal > div > div:first-child {
      background: linear-gradient(135deg, 
        rgba(11,39,67,0.95) 0%, 
        rgba(26,58,92,0.9) 50%,
        rgba(11,39,67,0.85) 100%) !important;
      backdrop-filter: blur(15px) saturate(150%) !important;
      border-bottom: 1px solid rgba(255,255,255,0.1) !important;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.1) !important;
    }
    
    /* Enhanced Content Area */
    #status-modal > div > div:nth-child(2) {
      background: rgba(255,255,255,0.1) !important;
      backdrop-filter: blur(10px) !important;
    }
    
    /* Enhanced Footer */
    #status-modal > div > div:last-child {
      background: rgba(248,250,252,0.8) !important;
      backdrop-filter: blur(10px) saturate(110%) !important;
      border-top: 1px solid rgba(226,232,240,0.6) !important;
      position: relative !important;
      z-index: 100 !important;
      flex-shrink: 0 !important;
    }
    
    /* Force buttons to be visible */
    #status-apply-btn, #status-cancel-btn {
      display: inline-block !important;
      visibility: visible !important;
      z-index: 10 !important;
      position: relative !important;
    }
    
    /* Ensure modal structure stays fixed */
    #status-modal > div {
      display: flex !important;
      flex-direction: column !important;
      max-height: 85vh !important;
    }
    
    /* Content area that scrolls */
    #status-modal > div > div:nth-child(2) {
      flex: 1 !important;
      overflow-y: auto !important;
    }
  `;
  document.head.appendChild(style);

  // הוסף מאזינים לאפקטים ויזואליים
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.classList.add('hiding');
      modal.classList.remove('show');
      
      setTimeout(() => {
        modal.style.display = 'none';
        modal.classList.remove('hiding');
      }, 400);
    }
  });

  // עדכן אפקטים ויזואליים כאשר בוחרים אופציה
  modal.querySelectorAll('.status-option input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
      // הסר סלקשן מכל האופציות
      modal.querySelectorAll('.status-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      // הוסף סלקשן לאופציה שנבחרה
      if (this.checked) {
        this.closest('.status-option').classList.add('selected');
      }
    });
  });

})();

// טען את ה-hostname מהשרת ואז תמשיך
fetch('/wp-content/postify-api/get-hostname.php')
  .then(res => res.text())
  .then(h => {
    hostname = h.trim();
    console.log('hostname:', hostname);
    loadCollections();
  })
  .catch(err => {
    console.error('Error loading hostname:', err);
    loadCollections(); // נמשיך גם אם נכשל
  });

// טען אוספי קבוצות
function loadCollections() {
  fetch('/wp-content/postify-api/groups-data.php')
    .then(res => res.json())
    .then(cols => {
      collections = cols;
      loadPostsFromDB();
    })
    .catch(err => {
      console.error('Error loading collections:', err);
      collections = [];
      loadPostsFromDB();
    });
}

// טען את כל הפוסטים אחרי שה-collections נטענו
function loadPostsFromDB() {
  console.log('🔄 loadPostsFromDB נקראה - זה עלול למחוק תמונות מקומיות!');
  console.log('📊 allPosts לפני קריאה לשרת:', allPosts);
  
  fetch('/wp-content/postify-api/posts-data.php?hostname=' + encodeURIComponent(hostname))
    .then(res => res.json())
    .then(posts => {
      console.log('📥 Posts loaded from API:', posts);
      
      // בדיקה מפורטת של הפוסט עם הוידאו
      const videoPost = posts.find(p => p.id == 341);
      if (videoPost) {
        console.log('🎬 פוסט וידאו 341 מהשרת:', videoPost);
        console.log('📁 תמונות בפוסט וידאו מהשרת:', videoPost.images);
      }
      
      // שמירת הפוסטים הישנים לפני החלפה
      const oldPosts = [...allPosts];
      const oldVideoPost = oldPosts.find(p => p.id == 341);
      if (oldVideoPost) {
        console.log('🎬 פוסט וידאו 341 לפני החלפה:', oldVideoPost);
        console.log('📁 תמונות בפוסט וידאו לפני החלפה:', oldVideoPost.images);
      }
      
      console.log('⚠️ מחליף allPosts - תמונות מקומיות עלולות להיעלם!');
      
      // שמירת תמונות מקומיות לפני החלפה
      const localImages = {};
      allPosts.forEach(oldPost => {
        if (oldPost.images && oldPost.images.length > 0) {
          localImages[oldPost.id] = [...oldPost.images];
        }
      });
      
      allPosts = posts;
      
      // החזרת התמונות המקומיות לפוסטים שלא הוחזרו מהשרת
      allPosts.forEach(post => {
        if (localImages[post.id] && (!post.images || post.images.length === 0)) {
          console.log(`🔧 מחזיר תמונות מקומיות לפוסט ${post.id}:`, localImages[post.id]);
          post.images = localImages[post.id];
        }
      });
      
      // בדיקה אחרי החלפה
      const newVideoPost = allPosts.find(p => p.id == 341);
      if (newVideoPost) {
        console.log('🎬 פוסט וידאו 341 אחרי החלפה:', newVideoPost);
        console.log('📁 תמונות בפוסט וידאו אחרי החלפה:', newVideoPost.images);
      }
      
      renderPosts(posts);
    })
    .catch(err => {
      console.error('Error loading posts:', err);
      allPosts = [];
      renderPosts([]);
    });
}

// מצייר פוסטים
function renderPosts(posts) {
  const area = document.getElementById("posts-area");
  let html = '';
  posts.forEach(post => {
    const statusIcon = getStatusIcon(post.status || 'active');
    const scheduleInfo = getDetailedScheduleInfo(post);
    const shortText = escapeHtml((post.text || '').slice(0, 60));
    html += `
      <div class="post-card-collapsed" data-post-id="${post.id}" data-status="${post.status || 'active'}" onclick="openPostCard(${post.id})" style="position:relative;border:1px solid #ddd;margin:10px 0;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.2s;background:#fff;" onmouseover="this.style.background='#f8f9fa'; this.style.borderColor='#0b2743';" onmouseout="this.style.background='#fff'; this.style.borderColor='#ddd';">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:15px;">
          <div style="display:flex;align-items:center;gap:10px;flex:2;min-width:0;">
            ${statusIcon}
            <span class="card-title" style="font-weight:bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(post.title || 'ללא כותרת')}</span>
          </div>
          
          <div style="flex:2;min-width:0;padding:0 10px;">${scheduleInfo}</div>
          
          <button class="open-card-btn" onclick="event.stopPropagation(); openPostCard(${post.id})" style="background:#0b2743;color:#fff;border:none;border-radius:5px;padding:6px 12px;font-size:0.85em;white-space:nowrap;transition:background 0.2s;" onmouseover="this.style.background='#1a365d'" onmouseout="this.style.background='#0b2743'">ערוך</button>
        </div>
      </div>
      <div class="post-card-expanded" id="expand-post-${post.id}" style="display:none"></div>
    `;
  });
  area.innerHTML = html;
  
  // אתחל סינונים אחרי שהפוסטים נטענו
  setTimeout(() => {
    if (!window.statusFiltersInitialized) {
      initStatusFilters();
      window.statusFiltersInitialized = true;
    }
    applyStatusFilter();
  }, 100);
}

// פונקציה להצגת אייקון סטטוס
function getStatusIcon(status) {
  const icons = {
    active: '🟢',
    paused: '⏸️',
    scheduled: '⏰',
    finished: '✅'
  };
  return icons[status] || '🟢';
}

// פונקציה ליצירת תיאור מפורט של התזמון לתצוגה הראשית
function getDetailedScheduleInfo(post) {
  if (!post.status || post.status === 'active') {
    return '<span style="color:#28a745;font-size:0.85em;">פעיל - מתפרסם לפי הסדר</span>';
  }
  if (post.status === 'paused') {
    return '<span style="color:#6c757d;font-size:0.85em;">מושבת - לא מתפרסם</span>';
  }
  if (post.status === 'finished') {
    return '<span style="color:#dc3545;font-size:0.85em;">הסתיים</span>';
  }
  
  if (post.status === 'scheduled') {
    let scheduleText = '<span style="color:#0b2743;font-size:0.85em;">מתוזמן: ';
    
    if (post.schedule_type === 'weekly') {
      const days = (post.days_of_week || '').split(',').filter(Boolean);
      const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
      if (days.length) {
        scheduleText += 'שבועי (' + days.map(d => dayNames[parseInt(d)] || '').join(', ') + ')';
      } else {
        scheduleText += 'שבועי (לא נבחרו ימים)';
      }
    } else if (post.schedule_type === 'monthly') {
      if (post.monthly_date) {
        const israeliDate = formatDateToIsraeli(post.monthly_date);
        scheduleText += 'חודשי (ב-' + israeliDate + ' לחודש)';
      } else {
        scheduleText += 'חודשי (לא נקבע תאריך)';
      }
    } else if (post.schedule_type === 'one-time') {
      if (post.one_time_date) {
        const israeliDate = formatDateToIsraeli(post.one_time_date);
        scheduleText += 'חד פעמי (' + israeliDate + ')';
      } else {
        scheduleText += 'חד פעמי (לא נקבע תאריך)';
      }
    }
    
    // הוסף תאריכי התחלה וסיום אם קיימים
    let dateRange = [];
    if (post.start_date) dateRange.push('מ-' + post.start_date);
    if (post.end_date) dateRange.push('עד ' + post.end_date);
    if (dateRange.length > 0) {
      scheduleText += ' [' + dateRange.join(' ') + ']';
    }
    
    scheduleText += '</span>';
    return scheduleText;
  }
  
  return '<span style="color:#666;font-size:0.85em;">לא מוגדר</span>';
}

// בלחיצה – טוען HTML מלא לכרטיסיה, פותח, וסוגר אחרים
function openPostCard(postId) {
  const expandDiv = document.getElementById('expand-post-' + postId);

  // אם הכרטיס כבר פתוח – סגור אותו ותחזור
  if (expandDiv.style.display === 'block') {
    expandDiv.style.display = 'none';
    return;
  }

  // סגור את כל הכרטיסיות
  document.querySelectorAll('.post-card-expanded').forEach(el => el.style.display = 'none');

  expandDiv.style.display = 'block';

  // מצא את הפוסט מתוך allPosts
  const post = allPosts.find(p => p.id == postId);
  if (!post) {
    expandDiv.innerHTML = "לא נמצא פוסט";
    return;
  }

  expandDiv.innerHTML = buildPostCardHtml(post, collections);
  
  // עדכן את ה-dataset של הכרטיס עם נתוני הפוסט
  const postCard = expandDiv.querySelector('.post-card-expanded-inner');
  if (postCard) {
    postCard.dataset.status = post.status || 'active';
    postCard.dataset.schedule_type = post.schedule_type || '';
    postCard.dataset.days_of_week = post.days_of_week || '';
    postCard.dataset.monthly_date = post.monthly_date || '';
    postCard.dataset.one_time_date = post.one_time_date || '';
    postCard.dataset.repeat_mode = post.repeat_mode || 'unlimited';
    postCard.dataset.start_date = post.start_date || '';
    postCard.dataset.end_date = post.end_date || '';
    
    console.log('עדכון dataset של הכרטיס עם נתוני הפוסט:', {
      status: postCard.dataset.status,
      schedule_type: postCard.dataset.schedule_type,
      days_of_week: postCard.dataset.days_of_week,
      monthly_date: postCard.dataset.monthly_date,
      one_time_date: postCard.dataset.one_time_date
    });
  }
  
  initPostCardEvents(postCard);

  // התאם אוטומטית את גובה ה-textarea לתוכן
  setTimeout(() => {
    const textarea = expandDiv.querySelector('.post-textarea');
    if (textarea) {
      autoResizeTextarea(textarea);
    }
  }, 100);
}

function buildPostCardHtml(post, collections) {
  const statusLabels = {
    active: "פעיל",
    paused: "מושבת",
    scheduled: "מתוזמן",
    finished: "הסתיים"
  };
  const currentStatus = post.status || "active";
  let finishedLabel = '';
  if (post.status === 'finished') {
    finishedLabel = `<span class="finished-label" style="color:#b00;font-weight:bold;margin-right:8px;">(הסתיים)</span>`;
  }

  // פונקציה שמחזירה תקציר תזמון בשורה אחת
  function getScheduleSummary(post) {
    if (!post.status || post.status === 'active' || post.status === 'paused') return '';
    let parts = [];
    if (post.schedule_type === 'weekly') {
      const days = (post.days_of_week || '').split(',').filter(Boolean);
      const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
      if (days.length) {
        parts.push('שבועי (' + days.map(d => dayNames[parseInt(d)] || '').join(', ') + ')');
      } else {
        parts.push('שבועי');
      }
    } else if (post.schedule_type === 'monthly') {
      if (post.monthly_date) {
        const israeliDate = formatDateToIsraeli(post.monthly_date);
        parts.push('חודשי (' + israeliDate + ')');
      } else {
        parts.push('חודשי');
      }
    } else if (post.schedule_type === 'one-time' && post.one_time_date) {
      const israeliDate = formatDateToIsraeli(post.one_time_date);
      parts.push('חד פעמי: ' + israeliDate);
    }
    if (post.start_date) {
      const israeliStartDate = formatDateToIsraeli(post.start_date);
      parts.push('התחלה: ' + israeliStartDate);
    }
    if (post.end_date) {
      const israeliEndDate = formatDateToIsraeli(post.end_date);
      parts.push('סיום: ' + israeliEndDate);
    }
    return parts.join(' | ');
  }

  const scheduleSummary = getScheduleSummary(post);

  return `
    <div class="post-card-expanded-inner" data-post-id="${post.id}" style="border:1px solid #ddd;padding:20px;border-radius:8px;background:#f9f9f9;">
      <div style="display:flex;align-items:center;gap:18px;margin-bottom:15px;">
        <button type="button" class="post-status-btn" style="background:#e6f0fa;border:none;border-radius:7px;padding:8px 15px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:7px;" title="לחץ לשינוי סטטוס ותזמון הפוסט">
          ${getStatusIcon(currentStatus)} סטטוס: <span class="post-status-label">${statusLabels[currentStatus]}</span>
        </button>
        ${scheduleSummary ? `<span style=\"font-size:1em;color:#0b2743;background:#e6f0fa;padding:6px 13px;border-radius:7px;\">${escapeHtml(scheduleSummary)}</span>` : ''}
        ${finishedLabel}
      </div>
      
      <div style="margin-bottom:10px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">כותרת הפוסט:</label>
        <input type="text" class="post-title-input" value="${escapeHtml(post.title || '')}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:5px;" placeholder="הכנס כותרת קצרה ומעניינת לפוסט">
      </div>

      <div style="margin-bottom:15px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">תוכן הפוסט:</label>
        <textarea class="post-textarea" style="width:100%;min-height:120px;font-size:1.1em;padding:8px;border:1px solid #ddd;border-radius:5px;resize:vertical;" placeholder="כתב כאן את תוכן הפוסט...">${escapeHtml(post.text || '')}</textarea>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">העלאת תמונות ווידאו: <small style="font-weight:normal;color:#666;">ניתן לבחור תמונות ווידאו בו-זמנית. הקבצים יתווספו לפוסט ויוצגו ברשתות החברתיות</small></label>
        <input type="file" class="media-upload" accept="image/*,video/*" multiple style="margin-bottom:10px;">
        <div class="media-preview" style="display:flex;gap:10px;flex-wrap:wrap;">
          ${(post.images || []).map(img => {
            const isVideo = img.match(/\.(mp4|mov|avi|wmv|flv|webm)$/i);
            return `<div style="position:relative;width:90px;height:90px;overflow:hidden;border-radius:13px;background:#fff;box-shadow:0 2px 7px #0b27431a;">
              ${isVideo ? 
                `<video controls style="width:100%;height:100%;object-fit:cover;border-radius:12px;border:1px solid #ccc;display:block;background:#fafafa;" data-path="${img}">
                  <source src="/wp-content/postify-api/${img}" type="video/${img.split('.').pop()}">
                  הדפדפן שלך לא תומך בתגית וידאו.
                </video>` :
                `<img src="/wp-content/postify-api/${img}" data-path="${img}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;border:1px solid #ccc;display:block;background:#fafafa;">`
              }
              <span class="remove-media-btn" style="position:absolute;top:1px;right:1px;background:red;color:white;border-radius:50%;padding:2px 6px;cursor:pointer;font-weight:bold;font-size:12px;">×</span>
            </div>`;
          }).join("")}
        </div>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">בחר אוסף קבוצות: <small style="font-weight:normal;color:#666;">אוסף קבוצות קובע לאילו רשתות חברתיות הפוסט יתפרסם</small></label>
        <select class="group-collection-select" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:5px;">
          <option value="">בחר אוסף קבוצות...</option>
          ${collections.map(c =>
            `<option value="${c.id}" ${post.collection_id == c.id ? "selected" : ""}>${escapeHtml(c.name)}</option>`
          ).join("")}
        </select>
      </div>
      
      <div style="margin-bottom:15px;">

        ${(post.groups || []).map(url =>
          `<label style="display:block;margin-bottom:3px;"><input type="checkbox" name="groups[]" value="${url}" checked> ${escapeHtml(url)}</label>`
        ).join("")}
        ${(post.groups || []).length === 0 ? '' : ''}
      </div>
      
      <span class="save-status" style="display:block;margin-bottom:15px;font-weight:bold;"></span>
      
      <!-- כפתורי פעולות -->
      <div class="actions-row" style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="save-post-btn" style="background:#28a745;color:#fff;border:none;border-radius:5px;padding:8px 15px;" title="שמור את כל השינויים שביצעת בפוסט">💾 שמור</button>
        <button class="delete-post-btn" style="background:#dc3545;color:#fff;border:none;border-radius:5px;padding:8px 15px;" title="מחק את הפוסט לצמיתות (לא ניתן לשחזר)">🗑️ מחק</button>
        <button class="clone-post-btn" style="background:#17a2b8;color:#fff;border:none;border-radius:5px;padding:8px 15px;" title="צור עותק זהה של הפוסט עם אותו תוכן">📄 שכפל</button>
        <button class="ai-upgrade-btn" style="background:#6f42c1;color:#fff;border:none;border-radius:5px;padding:8px 15px;" title="שפר את הטקסט באמצעות בינה מלאכותית">🤖 שדרג בעזרת AI</button>
        <small style="color:#666;margin-right:15px;">השינויים נשמרים אוטומטית כשאתה מקליד</small>
      </div>
    </div>
  `;
}

// פונקציה שמחזירה שדות תזמון
function renderScheduleFields(post) {
  if (!post.status || post.status === 'active' || post.status === 'paused') {
    return '';
  }
  
  let html = '<div style="background:#fff;padding:15px;border:1px solid #ddd;border-radius:5px;">';
  html += '<div style="font-weight:bold;margin-bottom:10px;">הגדרות תזמון:</div>';
  
  if (post.schedule_type === 'weekly') {
    const days = (post.days_of_week || '').split(',').filter(Boolean);
    html += '<div style="margin-bottom:10px;">ימים נבחרים: ';
    const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
    html += days.map(d => dayNames[parseInt(d)] || '').join(',') || 'לא נבחרו ימים';
    html += '</div>';
  }
  
  if (post.schedule_type === 'monthly' && post.monthly_date) {
    const israeliDate = formatDateToIsraeli(post.monthly_date);
    html += `<div style="margin-bottom:10px;">תאריך חודשי: ${israeliDate}</div>`;
  }
  
  if (post.schedule_type === 'one-time' && post.one_time_date) {
    const israeliDate = formatDateToIsraeli(post.one_time_date);
    html += `<div style="margin-bottom:10px;">תאריך חד פעמי: ${israeliDate}</div>`;
  }
  
  if (post.start_date) {
    const israeliStartDate = formatDateToIsraeli(post.start_date);
    html += `<div style="margin-bottom:5px;">התחלה: ${israeliStartDate}</div>`;
  }
  
  if (post.end_date) {
    const israeliEndDate = formatDateToIsraeli(post.end_date);
    html += `<div style="margin-bottom:5px;">סיום: ${israeliEndDate}</div>`;
  }
  
  html += '</div>';
  return html;
}

// פונקציה שמגנה על הכנסת טקסט (נגד XSS)
function escapeHtml(str) {
  if (!str) return '';
  return str.toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// פונקציה להתאמת גובה textarea
function autoResizeTextarea(textarea) {
  textarea.style.height = "auto";
  textarea.style.height = (textarea.scrollHeight + 2) + "px";
}

// מתפעל את כל ההתנהגויות של כל כרטיס פוסט
function initPostCardEvents(card) {
  const statusBtn = card.querySelector('.post-status-btn');
  const statusLabel = card.querySelector('.post-status-label');
  const postId = card.dataset.postId;
  const textarea = card.querySelector(".post-textarea");
  const statusSpan = card.querySelector(".save-status");

  // פונקציה להתאמת גובה textarea ושמירה אוטומטית
  if (textarea) {
    autoResizeTextarea(textarea);
    textarea.addEventListener("input", function() {
      autoResizeTextarea(this);
      // שמירה אוטומטית אחרי עריכת טקסט
      clearTimeout(this.saveTimeout);
      this.saveTimeout = setTimeout(() => {
        console.log('שמירה אוטומטית אחרי עריכת טקסט...');
        autoSave(postId);
      }, 2000); // המתן 2 שניות אחרי שהמשתמש סיים להקליד
    });
  }

  // שמירה אוטומטית גם לכותרת
  const titleInput = card.querySelector(".post-title-input");
  if (titleInput) {
    titleInput.addEventListener("input", function() {
      // שמירה אוטומטית אחרי עריכת כותרת
      clearTimeout(this.saveTimeout);
      this.saveTimeout = setTimeout(() => {
        console.log('שמירה אוטומטית אחרי עריכת כותרת...');
        autoSave(postId);
      }, 2000);
    });
  }

  // שמירה אוטומטית לשינוי אוסף קבוצות
  const collectionSelect = card.querySelector(".group-collection-select");
  if (collectionSelect) {
    collectionSelect.addEventListener("change", function() {
      console.log('שמירה אוטומטית אחרי שינוי אוסף...');
      autoSave(postId);
    });
  }

  // פופאפ סטטוס
  if (statusBtn) {
    statusBtn.onclick = function(e) {
      e.stopPropagation();
      const modal = document.getElementById("status-modal");
      
      // הוסף אנימציה חלקה לפתיחה
      modal.style.display = "flex";
      modal.classList.add('show');
      
      // קבע ערך נוכחי מהכרטיס
      const currentStatus = card.dataset.status || 'active';
      
      console.log('פותח פופאפ סטטוס עם סטטוס נוכחי:', currentStatus);
      console.log('נתונים בכרטיס:', {
        status: card.dataset.status,
        schedule_type: card.dataset.schedule_type,
        days_of_week: card.dataset.days_of_week,
        monthly_date: card.dataset.monthly_date,
        one_time_date: card.dataset.one_time_date
      });
      
      modal.querySelectorAll('input[name="status-choice"]').forEach(r => {
        r.checked = (r.value === currentStatus);
      });
      
      // הצג אפשרויות תזמון אם נדרש
      const scheduleOptions = modal.querySelector("#schedule-options");
      if (currentStatus === 'scheduled') {
        scheduleOptions.style.display = "block";
        scheduleOptions.classList.add('show');
        const scheduleType = card.dataset.schedule_type || "weekly";
        modal.querySelector("#schedule-type-select").value = scheduleType;
        
        // מצא את הפוסט הנוכחי ב-allPosts
        const post = allPosts.find(p => p.id == postId) || {};
        
        // שלב נתונים מהכרטיס ומה-allPosts
        const combinedPost = {
          ...post,
          status: card.dataset.status || post.status || 'active',
          schedule_type: card.dataset.schedule_type || post.schedule_type || '',
          days_of_week: card.dataset.days_of_week || post.days_of_week || '',
          monthly_date: card.dataset.monthly_date || post.monthly_date || '',
          one_time_date: card.dataset.one_time_date || post.one_time_date || '',
          repeat_mode: card.dataset.repeat_mode || post.repeat_mode || 'unlimited',
          start_date: card.dataset.start_date || post.start_date || '',
          end_date: card.dataset.end_date || post.end_date || ''
        };
        
        console.log('נתונים משולבים לתצוגה:', combinedPost);
        showScheduleOptions(scheduleType, combinedPost);
      } else {
        scheduleOptions.classList.remove('show');
        scheduleOptions.style.display = "none";
      }
      
      // הצג/הסתר תזמון לפי בחירה
      modal.querySelectorAll('input[name="status-choice"]').forEach(radio => {
        radio.onchange = function() {
          if (this.value === "scheduled") {
            scheduleOptions.style.display = "block";
            scheduleOptions.classList.add('show');
            const scheduleType = modal.querySelector("#schedule-type-select").value || "weekly";
            
            // מצא את הפוסט הנוכחי
            const post = allPosts.find(p => p.id == postId) || {};
            const combinedPost = {
              ...post,
              status: card.dataset.status || post.status || 'active',
              schedule_type: card.dataset.schedule_type || post.schedule_type || scheduleType,
              days_of_week: card.dataset.days_of_week || post.days_of_week || '',
              monthly_date: card.dataset.monthly_date || post.monthly_date || '',
              one_time_date: card.dataset.one_time_date || post.one_time_date || '',
              repeat_mode: card.dataset.repeat_mode || post.repeat_mode || 'unlimited',
              start_date: card.dataset.start_date || post.start_date || '',
              end_date: card.dataset.end_date || post.end_date || ''
            };
            
            showScheduleOptions(scheduleType, combinedPost);
          } else {
            scheduleOptions.classList.remove('show');
            setTimeout(() => {
              scheduleOptions.style.display = "none";
            }, 200);
          }
        };
      });

      // סוג תזמון
      modal.querySelector("#schedule-type-select").onchange = function() {
        const post = allPosts.find(p => p.id == postId) || {};
        const combinedPost = {
          ...post,
          status: card.dataset.status || post.status || 'active',
          schedule_type: this.value,
          days_of_week: card.dataset.days_of_week || post.days_of_week || '',
          monthly_date: card.dataset.monthly_date || post.monthly_date || '',
          one_time_date: card.dataset.one_time_date || post.one_time_date || '',
          repeat_mode: card.dataset.repeat_mode || post.repeat_mode || 'unlimited',
          start_date: card.dataset.start_date || post.start_date || '',
          end_date: card.dataset.end_date || post.end_date || ''
        };
        showScheduleOptions(this.value, combinedPost);
      };

      // סגור עם אנימציה
      const closeModal = () => {
        modal.classList.add('hiding');
        modal.classList.remove('show');
        
        setTimeout(() => {
          modal.style.display = "none";
          modal.classList.remove('hiding');
        }, 400);
      };
      
      modal.querySelector("#close-status-modal").onclick = closeModal;
      
      // אישור
      const applyBtn = modal.querySelector("#status-apply-btn");
      const cancelBtn = modal.querySelector("#status-cancel-btn");
      
      console.log('🔗 קישור כפתורים:', {
        applyBtn: applyBtn,
        cancelBtn: cancelBtn,
        applyBtnExists: !!applyBtn,
        cancelBtnExists: !!cancelBtn
      });
      
      if (applyBtn) {
        applyBtn.onclick = function() {
          console.log('✅ לחיצה על כפתור אישור');
          saveStatusSettings(modal, card, postId);
        };
      } else {
        console.error('❌ כפתור אישור לא נמצא!');
      }
      
      // ביטול עם אנימציה
      if (cancelBtn) {
        cancelBtn.onclick = closeModal;
      } else {
        console.error('❌ כפתור ביטול לא נמצא!');
      }
    };
  }

  // פונקציה לשמירת הגדרות סטטוס עם בדיקת תאריכים
  function saveStatusSettings(modal, card, postId) {
    const selectedStatus = modal.querySelector('input[name="status-choice"]:checked')?.value || 'active';
    let scheduleData = { status: selectedStatus };
    
    console.log('שומר הגדרות סטטוס:', selectedStatus, 'לפוסט:', postId);
    
    // נקה נתוני תזמון קודמים כדי למנוע בעיות
    if (selectedStatus !== "scheduled") {
      console.log('מנקה נתוני תזמון כי הסטטוס אינו מתוזמן');
      scheduleData.schedule_type = '';
      scheduleData.days_of_week = '';
      scheduleData.monthly_date = '';
      scheduleData.one_time_date = '';
      scheduleData.repeat_mode = 'unlimited';
      scheduleData.start_date = '';
      scheduleData.end_date = '';
    } else {
      const scheduleType = modal.querySelector("#schedule-type-select").value;
      scheduleData.schedule_type = scheduleType;
      
      console.log('סוג תזמון:', scheduleType);
      
      // אסוף נתוני תזמון
      if (scheduleType === "weekly") {
        const daysCheckboxes = modal.querySelectorAll('.weekdays input:checked');
        const days = Array.from(daysCheckboxes).map(ch => parseInt(ch.value));
        console.log('ימי השבוע שנבחרו:', days, 'מתוך checkboxes:', daysCheckboxes.length);
        
        // בדיקת כפילות רק אם נבחרו ימים
        if (days.length > 0) {
          const startDate = modal.querySelector('.start-date-input')?.value || '';
          const endDate = modal.querySelector('.end-date-input')?.value || '';
          
          console.log('בודק כפילות עבור ימים:', days);
          if (!validateWeeklyDaysAvailability(days, postId, startDate, endDate)) {
            console.log('ימי שבוע נדחו - עוצר שמירה');
            return; // עצור שמירה
          }
        } else {
          console.log('לא נבחרו ימים בשבוע - ממשיך עם רשימה ריקה');
        }
        
        scheduleData.days_of_week = days.join(',');
        scheduleData.monthly_date = '';
        scheduleData.one_time_date = '';
      } else if (scheduleType === "monthly") {
        const monthlyDate = modal.querySelector('.monthly-date-input')?.value || '';
        console.log('תאריך חודשי שנבחר:', monthlyDate);
        if (monthlyDate) {
          // בדיקת כפילות לתאריך חודשי
          if (!validateDateAvailability(monthlyDate, postId, 'monthly')) {
            console.log('תאריך חודשי נדחה');
            return; // עצור שמירה
          }
        }
        scheduleData.monthly_date = monthlyDate;
        scheduleData.days_of_week = '';
        scheduleData.one_time_date = '';
      } else if (scheduleType === "one-time") {
        const oneTimeDate = modal.querySelector('.one-time-date-input')?.value || '';
        console.log('תאריך חד-פעמי שנבחר:', oneTimeDate);
        if (oneTimeDate) {
          // בדיקת כפילות לתאריך חד-פעמי
          if (!validateDateAvailability(oneTimeDate, postId, 'one-time')) {
            console.log('תאריך חד-פעמי נדחה');
            return; // עצור שמירה
          }
        }
        scheduleData.one_time_date = oneTimeDate;
        scheduleData.days_of_week = '';
        scheduleData.monthly_date = '';
      }
      
      scheduleData.repeat_mode = modal.querySelector('input[name="repeat-mode"]:checked')?.value || 'unlimited';
      scheduleData.start_date = modal.querySelector('.start-date-input')?.value || '';
      scheduleData.end_date = modal.querySelector('.end-date-input')?.value || '';
    }
    
    console.log('נתוני תזמון שיישמרו:', scheduleData);
    
    // עדכן UI
    const statusLabels = { active: "פעיל", paused: "מושבת", scheduled: "מתוזמן", finished: "הסתיים" };
    statusLabel.textContent = statusLabels[selectedStatus];
    
    // שמור ב-dataset של הכרטיס
    Object.keys(scheduleData).forEach(key => {
      card.dataset[key] = scheduleData[key] || '';
    });
    
    console.log('עדכון dataset הכרטיס:', Object.keys(scheduleData).map(key => `${key}: ${scheduleData[key]}`));
    
    // שמור לשרת עם עדכון לייב - תקן את הבעיה כאן
    const savePromise = autoSave(postId);
    if (savePromise && typeof savePromise.then === 'function') {
      savePromise.then(() => {
        // עדכון לייב של כל הפוסטים אחרי שינוי סטטוס
        console.log('שמירה הושלמה בהצלחה - מתחיל עדכון לייב אחרי שינוי סטטוס...');
        setTimeout(() => {
          refreshAllPosts();
        }, 500); // המתן חצי שנייה לוודא שהשמירה הושלמה
      }).catch(error => {
        console.error('שגיאה בשמירת הסטטוס:', error);
      });
    } else {
      // אם autoSave לא החזיר promise, פשוט רענן את הפוסטים
      console.log('autoSave לא החזיר promise, מרענן ישירות...');
      setTimeout(() => {
        refreshAllPosts();
      }, 500);
    }
    
    // סגור פופאפ עם אנימציה חלקה
    modal.classList.add('hiding');
    modal.classList.remove('show');
    
    setTimeout(() => {
      modal.style.display = "none";
      modal.classList.remove('hiding');
    }, 400);
    console.log('סגירת modal והשלמת שמירת סטטוס');
  }

  // פונקציה שמציגה שדות תזמון - התיקון הראשי כאן!
  function showScheduleOptions(type, post) {
    const fields = document.getElementById("schedule-fields");
    let html = "";

    // ודא שיש לנו ערכים תקינים
    const days = (post?.days_of_week || '').split(',').filter(Boolean);
    const repeatMode = post?.repeat_mode || 'unlimited';
    const startDate = post?.start_date || '';
    const endDate = post?.end_date || '';
    const monthlyDate = post?.monthly_date || '';
    const oneTimeDate = post?.one_time_date ? normalizeDate(post.one_time_date) : '';
    const normalizedStartDate = startDate ? normalizeDate(startDate) : '';
    const normalizedEndDate = endDate ? normalizeDate(endDate) : '';
    const normalizedMonthlyDate = monthlyDate ? normalizeDate(monthlyDate) : '';

    console.log('showScheduleOptions נקרא עם:', {
      type,
      post: post?.id,
      days,
      repeatMode,
      startDate: normalizedStartDate,
      endDate: normalizedEndDate,
      monthlyDate: normalizedMonthlyDate,
      oneTimeDate
    });

    // עבור שבועי - מציגים בחירת ימים (ללא שבת)
    if (type === "weekly") {
      html += `<div style="margin-bottom:10px;padding:10px;background:#fff3cd;border-radius:5px;color:#856404;">
        <strong>פרסום שבועי:</strong> הפוסט יתפרסם בימים שתבחר בכל שבוע
        <br><small>לדוגמה: אם תבחר "שני" ו"רביעי", הפוסט יתפרסם כל יום שני ורביעי</small>
      </div>`;
      html += `<div style="margin-bottom:10px;">
        <div style="font-weight:bold;margin-bottom:5px;">בחר ימים בשבוע:</div>
        <div class="weekdays">
          ${['ראשון','שני','שלישי','רביעי','חמישי','שישי'].map((d,i) =>
            `<label style="margin-left:10px;"><input type="checkbox" value="${i}" ${days.includes(String(i)) ? 'checked' : ''} onchange="validateWeeklySelection(this, ${postId})"> ${d}</label>`
          ).join('')}
        </div>
        <small style="color:#666;">ניתן לבחור מספר ימים. הפוסט יתפרסם בכל הימים שתבחר</small>
      </div>`;
    }

    // תזמון חודשי
    if (type === "monthly") {
      html += `<div style="margin-bottom:10px;padding:10px;background:#d1ecf1;border-radius:5px;color:#0c5460;">
        <strong>פרסום חודשי:</strong> הפוסט יתפרסם באותו תאריך בכל חודש
        <br><small>לדוגמה: אם תבחר 15/07/2025, הפוסט יתפרסם ב-15 של כל חודש</small>
      </div>`;
      html += `<div style="margin-bottom:10px;">
        <label>בחר תאריך לחזרה חודשית: 
          <input type="date" class="monthly-date-input" value="${normalizedMonthlyDate}" style="margin-right:5px;">
        </label>
        <br><small style="color:#666;">רק היום בחודש יקבע את התזמון (לא החודש והשנה)</small>
      </div>`;
    }

    // תזמון חד פעמי
    if (type === "one-time") {
      html += `<div style="margin-bottom:10px;padding:10px;background:#f8d7da;border-radius:5px;color:#721c24;">
        <strong>פרסום חד פעמי:</strong> הפוסט יתפרסם רק פעם אחת בתאריך שתבחר
        <br><small>לאחר הפרסום, הפוסט יעבור אוטומטית לסטטוס "הסתיים"</small>
      </div>`;
      html += `<div style="margin-bottom:10px;">
        <label>תאריך לפרסום חד פעמי: 
          <input type="date" class="one-time-date-input" value="${oneTimeDate}" style="margin-right:5px;">
        </label>
        <br><small style="color:#666;">בחר את התאריך המדויק בו תרצה שהפוסט יתפרסם</small>
      </div>`;
    }

    // חזרות (לא בחד פעמי)
    if (type !== "one-time") {
      html += `
        <div style="margin-bottom:10px;">
          <div style="font-weight:bold;margin-bottom:5px;">הגדרות תקופת פרסום:</div>
          <label style="display:block;margin-bottom:5px;">
            <input type="radio" name="repeat-mode" value="unlimited" ${repeatMode === 'unlimited' ? 'checked' : ''}> ללא הגבלת זמן
            <div style="font-size:0.85em;color:#666;margin-right:20px;">הפוסט יתפרסם לפי התזמון ללא הגבלת זמן</div>
          </label>
          <label style="display:block;margin-bottom:5px;">
            <input type="radio" name="repeat-mode" value="until-date" ${repeatMode === 'until-date' ? 'checked' : ''}> עד תאריך מוגדר
            <div style="font-size:0.85em;color:#666;margin-right:20px;">הפוסט יתפרסם רק עד תאריך שתקבע</div>
          </label>
          <div class="repeat-dates-area" style="margin-top:10px;"></div>
        </div>
      `;
    }

    fields.innerHTML = html;

    // הצגת שדות תאריכים
    if (type !== "one-time") {
      renderRepeatDatesArea(type, normalizedStartDate, normalizedEndDate);
      
      // מאזין לשינוי בחזרות
      fields.querySelectorAll('input[name="repeat-mode"]').forEach(radio => {
        radio.onchange = () => renderRepeatDatesArea(type, normalizedStartDate, normalizedEndDate);
      });
    }

    // הפעל Flatpickr על שדות התאריך החדשים
    setTimeout(enableFlatpickrOnDates, 100);
  }

  function renderRepeatDatesArea(type, startDate, endDate) {
    const area = document.getElementById("schedule-fields").querySelector('.repeat-dates-area');
    if (!area) return;
    
    const selected = document.querySelector('input[name="repeat-mode"]:checked')?.value || 'unlimited';
    
    // נורמליזציה של תאריכים
    const normalizedStartDate = startDate ? normalizeDate(startDate) : '';
    const normalizedEndDate = endDate ? normalizeDate(endDate) : '';
    
    if (selected === 'unlimited') {
      if (type === "monthly") {
        area.innerHTML = '<small style="color:#666;">הפוסט יתפרסם בכל חודש ללא הגבלת זמן</small>';
      } else {
        area.innerHTML = `<label>תאריך התחלה: <input type="date" class="start-date-input" value="${normalizedStartDate}"></label>
        <br><small style="color:#666;">מתי להתחיל את הפרסום השבועי (אם ריק - יתחיל מיד)</small>`;
      }
    } else {
      if (type === "monthly") {
        area.innerHTML = `<label>תאריך סיום: <input type="date" class="end-date-input" value="${normalizedEndDate}"></label>
        <br><small style="color:#666;">עד מתי להמשיך את הפרסום החודשי</small>`;
      } else {
        area.innerHTML = `
          <label style="display:block;margin-bottom:5px;">תאריך התחלה: <input type="date" class="start-date-input" value="${normalizedStartDate}"></label>
          <small style="color:#666;display:block;margin-bottom:8px;">מתי להתחיל את הפרסום השבועי</small>
          <label>תאריך סיום: <input type="date" class="end-date-input" value="${normalizedEndDate}"></label>
          <small style="color:#666;">עד מתי להמשיך את הפרסום השבועי</small>
        `;
      }
    }
    
    // הפעל Flatpickr על שדות חדשים
    setTimeout(enableFlatpickrOnDates, 100);
  }

  // פונקציה לשמירת פוסט עם בדיקת תאריכים ועדכון לייב
  function savePostWithValidation(postId) {
    const postCard = document.querySelector(`.post-card-expanded-inner[data-post-id="${postId}"]`);
    if (!postCard) {
      console.error('לא נמצא פוסט עם ID:', postId);
      return Promise.reject('פוסט לא נמצא');
    }
    
    // בדיקת תאריכים על בסיס הנתונים הנוכחיים בכרטיס
    const currentStatus = postCard.dataset.status || 'active';
    const currentScheduleType = postCard.dataset.schedule_type || '';
    
    if (currentStatus === 'scheduled') {
      if (currentScheduleType === 'one-time') {
        const oneTimeDate = postCard.dataset.one_time_date || '';
        if (oneTimeDate) {
          const normalizedDate = normalizeDate(oneTimeDate);
          if (normalizedDate && !validateDateAvailability(normalizedDate, postId, 'one-time')) {
            showDateErrorMessage(`התאריך ${oneTimeDate} כבר תפוס על ידי פוסט אחר!`);
            return Promise.reject('תאריך תפוס');
          }
        }
      }
      
      if (currentScheduleType === 'monthly') {
        const monthlyDate = postCard.dataset.monthly_date || '';
        if (monthlyDate) {
          const normalizedDate = normalizeDate(monthlyDate);
          if (normalizedDate && !validateDateAvailability(normalizedDate, postId, 'monthly')) {
            showDateErrorMessage(`התאריך החודשי ${monthlyDate} כבר תפוס על ידי פוסט אחר!`);
            return Promise.reject('תאריך תפוס');
          }
        }
      }
    }
    
    // שמירה ישירה
    return savePostDirectly(postId, postCard).then(() => {
      // עדכון לייב של כל הפוסטים אחרי שמירה מוצלחת
      console.log('שמירה הושלמה בהצלחה, מתחיל עדכון לייב...');
      setTimeout(() => {
        refreshAllPosts();
      }, 300);
    }).catch(error => {
      console.error('שגיאה בשמירת הפוסט:', error);
      throw error;
    });
  }
  
  // פונקציה לשמירה ישירה של פוסט
  function savePostDirectly(postId, postCard) {
    const statusSpan = postCard.querySelector('.save-status');
    if (statusSpan) statusSpan.textContent = "🕓 שומר...";
    
    const title = postCard.querySelector(".post-title-input").value;
    const text = postCard.querySelector(".post-textarea").value;
    const collectionId = postCard.querySelector(".group-collection-select").value;
    const images = Array.from(postCard.querySelectorAll(".media-preview img, .media-preview video")).map(el => el.dataset.path);
    const groups = Array.from(postCard.querySelectorAll('input[name="groups[]"]:checked')).map(input => input.value);

    console.log('🔍 שמירת פוסט ישירה - מדיה שנמצא:', images);

    // פונקציה להמרת תאריך מ-d/m/Y ל-YYYY-MM-DD
    function toMysqlDate(val) {
      if (!val) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
      const parts = val.split('/');
      if (parts.length === 3) {
        const [d, m, y] = parts;
        if (y && m && d) return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
      }
      return val;
    }

    const formData = new FormData();
    formData.append("id", postId);
    formData.append("title", title);
    formData.append("text", text);
    formData.append("collection_id", collectionId);
    formData.append("hostname", hostname);
    images.forEach(img => formData.append("images[]", img));
    groups.forEach(group => formData.append("groups[]", group));
    
    // הוסף שדות סטטוס ותזמון
    formData.append("status", postCard.dataset.status || 'active');
    // שלח schedule_type רק אם יש ערך חוקי או ברירת מחדל
    const validScheduleTypes = ['weekly','monthly','one-time'];
    let scheduleType = postCard.dataset.schedule_type;
    if (postCard.dataset.status === 'scheduled' && validScheduleTypes.includes(scheduleType)) {
      formData.append("schedule_type", scheduleType);
    } else if (postCard.dataset.status === 'scheduled') {
      formData.append("schedule_type", 'weekly'); // ברירת מחדל
    }
    formData.append("days_of_week", postCard.dataset.days_of_week || '');
    formData.append("days_of_month", postCard.dataset.days_of_month || '');
    // המרת תאריכים לפורמט MySQL
    if (postCard.dataset.one_time_date) formData.append("one_time_date", toMysqlDate(postCard.dataset.one_time_date));
    if (postCard.dataset.monthly_date) formData.append("monthly_date", toMysqlDate(postCard.dataset.monthly_date));
    formData.append("repeat_mode", postCard.dataset.repeat_mode || 'unlimited');
    if (postCard.dataset.start_date) formData.append("start_date", toMysqlDate(postCard.dataset.start_date));
    if (postCard.dataset.end_date) formData.append("end_date", toMysqlDate(postCard.dataset.end_date));
    
    console.log('Saving post data (savePostDirectly):');
    for (let pair of formData.entries()) {
      console.log(pair[0] + ': ' + pair[1]);
    }

    return fetch("/wp-content/postify-api/update-post.php", { method: "POST", body: formData })
      .then(res => res.json())
      .then(data => {
        console.log('Server response (savePostDirectly):', data);
        if (data.success) {
          if (statusSpan) statusSpan.textContent = "✅ נשמר";
          
          // עדכן את allPosts
          const post = allPosts.find(p => p.id == postId);
          if (post) {
            post.title = title;
            post.text = text;
            post.collection_id = collectionId;
            post.images = images;
            post.status = postCard.dataset.status || 'active';
            post.schedule_type = postCard.dataset.schedule_type || '';
            post.days_of_week = postCard.dataset.days_of_week || '';
            post.days_of_month = postCard.dataset.days_of_month || '';
            post.one_time_date = postCard.dataset.one_time_date || '';
            post.monthly_date = postCard.dataset.monthly_date || '';
            post.repeat_mode = postCard.dataset.repeat_mode || 'unlimited';
            post.start_date = postCard.dataset.start_date || '';
            post.end_date = postCard.dataset.end_date || '';
          }
          
          if (statusSpan) setTimeout(() => statusSpan.textContent = '', 3000);
          return data;
        } else {
          if (statusSpan) statusSpan.textContent = "❌ שגיאה: " + (data.message || data.error || 'לא ידוע');
          console.error('Save failed:', data);
          if (statusSpan) setTimeout(() => statusSpan.textContent = '', 3000);
          throw new Error(data.message || data.error || 'לא ידוע');
        }
      })
      .catch(err => {
        console.error('Save error:', err);
        if (statusSpan) statusSpan.textContent = "❌ שגיאה בשמירה";
        if (statusSpan) setTimeout(() => statusSpan.textContent = '', 3000);
        throw err;
      });
  }
  
  // פונקציה לעדכון לייב של כל הפוסטים
  function refreshAllPosts() {
    console.log('מעדכן את כל הפוסטים...');
    
    // רענן את allPosts מהשרת באמצעות ה-API הקיים
    fetch('/wp-content/postify-api/posts-data.php?hostname=' + encodeURIComponent(hostname))
      .then(response => response.json())
      .then(posts => {
        console.log('Posts refreshed from API:', posts);
        allPosts = posts;
        
        // עדכן את תצוגת הפוסטים
        renderPosts(posts);
        
        // הפעל מחדש את Flatpickr על כל השדות
        setTimeout(() => {
          refreshFlatpickrForAllPosts();
        }, 200);
        
        console.log('הפוסטים עודכנו בהצלחה');
      })
      .catch(error => {
        console.error('שגיאה בעדכון הפוסטים:', error);
      });
  }

  // עדכון כפתורי השמירה לשימוש בפונקציה המאמתת
  function updateSaveButtons() {
    const saveButtons = document.querySelectorAll('button[onclick*="savePost"]');
    
    saveButtons.forEach(button => {
      const onclickValue = button.getAttribute('onclick');
      if (onclickValue && onclickValue.includes('savePost(')) {
        const postIdMatch = onclickValue.match(/savePost\((\d+)\)/);
        if (postIdMatch) {
          const postId = postIdMatch[1];
          button.setAttribute('onclick', `savePostWithValidation(${postId})`);
        }
      }
    });
  }

  // הפעל עדכון כפתורים מדי פעם
  setInterval(updateSaveButtons, 2000);

  // העלאת מדיה (תמונות ווידאו)
  card.querySelector(".media-upload")?.addEventListener("change", function() {
    const files = Array.from(this.files);
    if (!files.length) return;
    
    files.forEach(file => {
      console.log('📤 Uploading file:', file.name, 'Type:', file.type);
      const fd = new FormData();
      fd.append("image", file); // השרת מקבל גם וידאו תחת השם "image"
      fetch("/wp-content/postify-api/upload-image.php", { method: "POST", body: fd })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const post = allPosts.find(p => p.id == postId);
            if (post) {
              post.images = post.images || [];
              post.images.push(data.path);
              console.log('🎬 מדיה נוסף לפוסט', postId, '- תמונות כעת:', post.images);
            }
            
            const wrapper = document.createElement("div");
            wrapper.style.cssText = "position:relative;width:90px;height:90px;overflow:hidden;border-radius:13px;background:#fff;box-shadow:0 2px 7px #0b27431a;";
            
            const isVideo = data.path.match(/\.(mp4|mov|avi|wmv|flv|webm)$/i);
            wrapper.innerHTML = `
              ${isVideo ? 
                `<video controls style="width:100%;height:100%;object-fit:cover;border-radius:12px;border:1px solid #ccc;display:block;background:#fafafa;" data-path="${data.path}">
                  <source src="/wp-content/postify-api/${data.path}" type="video/${data.path.split('.').pop()}">
                  הדפדפן שלך לא תומך בתגית וידאו.
                </video>` :
                `<img src="/wp-content/postify-api/${data.path}" data-path="${data.path}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;border:1px solid #ccc;display:block;background:#fafafa;">`
              }
              <span class="remove-btn" style="position:absolute;top:1px;right:1px;background:red;color:white;border-radius:50%;padding:2px 6px;cursor:pointer;font-weight:bold;font-size:12px;">×</span>
            `;
            
            card.querySelector(".media-preview").appendChild(wrapper);
            wrapper.querySelector(".remove-btn").onclick = function() {
              if (post) {
                post.images = post.images.filter(img => img !== data.path);
              }
              wrapper.remove();
              autoSave(postId);
            };
            
            // ⚡ שמור מיידית אחרי העלאה כדי לוודא שהמדיה נשמר בשרת
            console.log('💾 שומר מדיה מיידית בשרת...');
            autoSave(postId).then(() => {
              console.log('✅ מדיה נשמר בשרת בהצלחה');
            }).catch(err => {
              console.error('❌ שגיאה בשמירת מדיה:', err);
            });
          }
        })
        .catch(err => console.error('Upload error:', err));
    });
    this.value = "";
  });

  // כפתורי פעולות
  card.querySelector(".save-post-btn")?.addEventListener('click', function() {
    // שימוש בפונקציה עם בדיקת תאריכים ועדכון לייב
    savePostWithValidation(postId);
  });

  card.querySelector(".delete-post-btn")?.addEventListener('click', function() {
    if (!confirm("האם למחוק את הפוסט?")) return;
    
    const fd = new FormData();
    fd.append("id", postId);
    fetch("/wp-content/postify-api/delete-post.php", { method: "POST", body: fd })
      .then(() => {
        const expandedCard = card.closest('.post-card-expanded');
        if (expandedCard) expandedCard.remove();
        
        const collapsedCard = document.querySelector(`.post-card-collapsed[data-post-id="${postId}"]`);
        if (collapsedCard) collapsedCard.remove();
        
        allPosts = allPosts.filter(p => p.id != postId);
      })
      .catch(err => console.error('Delete error:', err));
  });

  card.querySelector(".clone-post-btn")?.addEventListener('click', function() {
    const fd = new FormData();
    fd.append("id", postId);
    fetch("/wp-content/postify-api/clone-post.php", { method: "POST", body: fd })
      .then(res => res.json())
      .then(() => loadPostsFromDB())
      .catch(err => console.error('Clone error:', err));
  });

  // AI upgrade
  card.querySelector(".ai-upgrade-btn")?.addEventListener("click", async function(e) {
    e.stopPropagation();
    const modal = document.getElementById("ai-upgrade-modal");
    modal.style.display = "flex";
    const modalContent = modal.querySelector("#ai-modal-content");
    const beforeAfterBtn = modal.querySelector("#ai-before-after-btn");
    
    modalContent.innerHTML = "⏳ משדרג טקסט...";
    beforeAfterBtn.style.display = "none";

    try {
      const formData = new FormData();
      formData.append("text", textarea.value);
      const res = await fetch("/wp-content/postify-api/ai-upgrade.php", { method: "POST", body: formData });
      const data = await res.json();

      const originalText = textarea.value;
      const upgradedText = data.upgraded || "❌ שגיאה בשדרוג";

      let showingOriginal = false;
      modalContent.innerHTML = formatAIText(upgradedText);
      beforeAfterBtn.style.display = "inline-block";
      beforeAfterBtn.textContent = "לפני-אחרי";

      beforeAfterBtn.onclick = function() {
        showingOriginal = !showingOriginal;
        modalContent.innerHTML = formatAIText(showingOriginal ? originalText : upgradedText);
        beforeAfterBtn.textContent = showingOriginal ? "הצג אחרי" : "לפני-אחרי";
      };

      modal.querySelector("#ai-upgrade-cancel").onclick = () => { modal.style.display = "none"; };
      modal.querySelector("#ai-upgrade-apply").onclick = () => {
        if (upgradedText && upgradedText !== "❌ שגיאה בשדרוג") {
          textarea.value = upgradedText;
          modal.style.display = "none";
          textarea.dispatchEvent(new Event("input"));
          autoResizeTextarea(textarea);
        } else {
          modal.style.display = "none";
        }
      };
      
    } catch (e) {
      console.error('AI upgrade error:', e);
      modalContent.innerHTML = "❌ שגיאה בשדרוג";
    }
  });

  // מחיקת מדיה קיימת
  card.querySelectorAll(".remove-media-btn").forEach(btn => {
    btn.onclick = function() {
      const mediaElement = this.parentElement.querySelector('img, video');
      const mediaPath = mediaElement.dataset.path;
      const post = allPosts.find(p => p.id == postId);
      if (post) {
        post.images = post.images.filter(img => img !== mediaPath);
      }
      this.parentElement.remove();
      autoSave(postId);
    };
  });
}

// פונקציית שמירה אוטומטית גלובלית
function autoSave(postId) {
  console.log('autoSave נקראה עם postId:', postId);
  
  // מצא את הכרטיס
  const card = document.querySelector(`.post-card-expanded-inner[data-post-id="${postId}"]`);
  if (!card) {
    console.error('לא נמצא כרטיס עם postId:', postId);
    return Promise.reject('לא נמצא כרטיס');
  }
  
  const statusSpan = card.querySelector('.save-status');
  if (statusSpan) statusSpan.textContent = "🕓 שומר...";
  
  const title = card.querySelector(".post-title-input").value;
  const text = card.querySelector(".post-textarea").value;
  const collectionId = card.querySelector(".group-collection-select").value;
  const images = Array.from(card.querySelectorAll(".media-preview img, .media-preview video")).map(el => el.dataset.path);
  const groups = Array.from(card.querySelectorAll('input[name="groups[]"]:checked')).map(input => input.value);

  console.log('🔍 שמירת פוסט - מדיה שנמצא:', images);

  // פונקציה להמרת תאריך מ-d/m/Y ל-YYYY-MM-DD
  function toMysqlDate(val) {
    if (!val) return '';
    if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
    const parts = val.split('/');
    if (parts.length === 3) {
      const [d, m, y] = parts;
      if (y && m && d) return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    }
    return val;
  }

  const formData = new FormData();
  formData.append("id", postId);
  formData.append("title", title);
  formData.append("text", text);
  formData.append("collection_id", collectionId);
  formData.append("hostname", hostname);
  images.forEach(img => formData.append("images[]", img));
  groups.forEach(group => formData.append("groups[]", group));

  // הוסף שדות סטטוס ותזמון
  formData.append("status", card.dataset.status || 'active');
  const validScheduleTypes = ['weekly','monthly','one-time'];
  let scheduleType = card.dataset.schedule_type;
  if (card.dataset.status === 'scheduled' && validScheduleTypes.includes(scheduleType)) {
    formData.append("schedule_type", scheduleType);
  } else if (card.dataset.status === 'scheduled') {
    formData.append("schedule_type", 'weekly');
  }
  formData.append("days_of_week", card.dataset.days_of_week || '');
  formData.append("days_of_month", card.dataset.days_of_month || '');
  if (card.dataset.one_time_date) formData.append("one_time_date", toMysqlDate(card.dataset.one_time_date));
  if (card.dataset.monthly_date) formData.append("monthly_date", toMysqlDate(card.dataset.monthly_date));
  formData.append("repeat_mode", card.dataset.repeat_mode || 'unlimited');
  if (card.dataset.start_date) formData.append("start_date", toMysqlDate(card.dataset.start_date));
  if (card.dataset.end_date) formData.append("end_date", toMysqlDate(card.dataset.end_date));
  
  console.log('Saving post data (autoSave):');
  for (let pair of formData.entries()) {
    console.log(pair[0] + ': ' + pair[1]);
  }
  
  return fetch("/wp-content/postify-api/update-post.php", { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
      console.log('Server response (autoSave):', data);
      if (data.success) {
        if (statusSpan) statusSpan.textContent = "✅ נשמר";
        
        // עדכן את allPosts - שמור מדיה קיימת ואל תחליף אותה
        const post = allPosts.find(p => p.id == postId);
        if (post) {
          post.title = title;
          post.text = text;
          post.collection_id = collectionId;
          // ⚠️ חשוב: שמור מדיה רק אם יש חדשה, אחרת השאר את הקיימת
          if (images && images.length > 0) {
            post.images = images;
            console.log('📝 עדכון מדיה בפוסט:', post.id, 'מדיה חדשה:', images);
          } else {
            console.log('📝 לא נמצאה מדיה חדשה - משאיר את הקיימת בפוסט:', post.id);
          }
          // אל תעדכן images אם זה ריק - זה עלול למחוק מדיה שהועלתה זה עתה
          post.status = card.dataset.status || 'active';
          post.schedule_type = card.dataset.schedule_type || '';
          post.days_of_week = card.dataset.days_of_week || '';
          post.days_of_month = card.dataset.days_of_month || '';
          post.one_time_date = card.dataset.one_time_date || '';
          post.monthly_date = card.dataset.monthly_date || '';
          post.repeat_mode = card.dataset.repeat_mode || 'unlimited';
          post.start_date = card.dataset.start_date || '';
          post.end_date = card.dataset.end_date || '';
          
          console.log('📝 עדכון פוסט ב-allPosts:', post.id, 'מדיה סופית:', post.images);
        }
        
        // רענן Flatpickr לכל הפוסטים
        refreshFlatpickrForAllPosts();
        
        if (statusSpan) setTimeout(() => statusSpan.textContent = '', 3000);
        return data;
      } else {
        if (statusSpan) statusSpan.textContent = "❌ שגיאה: " + (data.message || data.error || 'לא ידוע');
        console.error('Save failed:', data);
        if (statusSpan) setTimeout(() => statusSpan.textContent = '', 3000);
        throw new Error(data.message || data.error || 'לא ידוע');
      }
    })
    .catch(err => {
      console.error('Save error:', err);
      if (statusSpan) statusSpan.textContent = "❌ שגיאה בשמירה";
      if (statusSpan) setTimeout(() => statusSpan.textContent = '', 3000);
      throw err;
    });
}

// הוסף פונקציה גלובלית למחיקת פוסט מהכרטיסיה הסגורה
window.deleteCollapsedPost = function(postId, btn) {
  if (!confirm("האם למחוק את הפוסט?")) return;
  
  const fd = new FormData();
  fd.append("id", postId);
  fetch("/wp-content/postify-api/delete-post.php", { method: "POST", body: fd })
    .then(() => {
      const card = btn.closest('.post-card-collapsed');
      if (card) card.remove();
      
      allPosts = allPosts.filter(p => p.id != postId);
      
      const expanded = document.getElementById('expand-post-' + postId);
      if (expanded) expanded.remove();
    })
    .catch(err => console.error('Delete error:', err));
};

// כפתור הוספת פוסט חדש
document.getElementById("add-post-btn").onclick = function() {
  fetch("/wp-content/postify-api/add-post.php", { method: "POST" })
    .then(res => res.json())
    .then(() => loadPostsFromDB())
    .catch(err => console.error('Add post error:', err));
};

// הפעל את Flatpickr על כל input[type="date"]
function enableFlatpickrOnDates() {
  const dateInputs = document.querySelectorAll('input[type="date"]:not(.flatpickr-input)');
  
  dateInputs.forEach(input => {
    const postCard = input.closest('.post-card-expanded-inner');
    if (!postCard) return;
    
    const postId = postCard.dataset.postId;
    
    // זיהוי סוג התזמון לפי השדה
    let scheduleType = 'one-time';
    if (input.classList.contains('monthly-date-input')) {
      scheduleType = 'monthly';
    } else if (input.classList.contains('one-time-date-input')) {
      scheduleType = 'one-time';
    } else if (input.classList.contains('start-date-input')) {
      scheduleType = 'weekly';
    } else if (input.classList.contains('end-date-input')) {
      scheduleType = 'weekly';
    }
    
    flatpickr(input, {
      dateFormat: "d/m/Y",
      locale: {
        firstDayOfWeek: 1
      },
      minDate: "today",
      disable: function(date) {
        // בדיקה לכל שדות התאריך
        if (scheduleType !== 'one-time' && scheduleType !== 'monthly' && scheduleType !== 'weekly') return false;
        
        // המר תאריך לפורמט תקני
        const dateStr = date.getFullYear() + '-' + 
          String(date.getMonth() + 1).padStart(2, '0') + '-' + 
          String(date.getDate()).padStart(2, '0');
        
        // בדיקה ישירה אם יש התנגשות עם פוסטים אחרים
        const isConflicted = isDateConflicted(dateStr, postId, scheduleType);
        console.log(`📅 Flatpickr בודק תאריך ${dateStr}: ${isConflicted ? 'חסום' : 'זמין'}`);
        return isConflicted;
      },
      onChange: function(selectedDates, dateStr, instance) {
        if (selectedDates.length === 0) return;
        
        console.log('תאריך נבחר:', dateStr, 'סוג:', scheduleType, 'פוסט:', postId);
        
        // בדיקה נוספת בעת בחירת התאריך
        if (!validateDateAvailability(dateStr, postId, scheduleType)) {
          console.log('תאריך נדחה - מנקה בחירה');
          instance.clear();
          return;
        }
        
        // עדכן את הנתונים בכרטיס
        if (scheduleType === 'one-time') {
          postCard.dataset.one_time_date = dateStr;
        } else if (scheduleType === 'monthly') {
          postCard.dataset.monthly_date = dateStr;
        } else if (scheduleType === 'weekly') {
          // לתאריכי התחלה וסיום בשבועי
          if (input.classList.contains('start-date-input')) {
            postCard.dataset.start_date = dateStr;
          } else if (input.classList.contains('end-date-input')) {
            postCard.dataset.end_date = dateStr;
          }
        }
        
        console.log('תאריך אושר - מעדכן Flatpickr אחרים');
        // עדכן מיידית את כל הפוסטים האחרים
        setTimeout(() => {
          refreshFlatpickrForAllPosts();
        }, 100);
      }
    });
  });
}

// הפעל Flatpickr מדי פעם על שדות חדשים
setInterval(enableFlatpickrOnDates, 1000);

// פונקציות לניהול תאריכים תפוסים - מורחב לכל סוגי התזמון ולכפילויות
function getOccupiedDates(excludePostId = null) {
  console.log('מחפש תאריכים תפוסים, מתעלם מפוסט:', excludePostId);
  console.log('כל הפוסטים:', allPosts);
  
  const occupiedDates = new Set();
  const currentDate = new Date();
  
  allPosts.forEach(post => {
    console.log(`בודק פוסט ${post.id}:`, post);
    
    if (excludePostId && post.id == excludePostId) {
      console.log(`דולג על פוסט ${post.id} (נוכחי)`);
      return; // דלג על הפוסט הנוכחי
    }
    
    if (post.status !== 'scheduled') {
      console.log(`דולג על פוסט ${post.id} - לא מתפרסם (${post.status})`);
      return; // רק פוסטים מתוזמנים
    }
    
    console.log(`פוסט ${post.id} מתוזמן:`, post.schedule_type);
    
    // תזמון חד-פעמי
    if (post.schedule_type === 'one-time' && post.one_time_date) {
      const normalizedDate = normalizeDate(post.one_time_date);
      console.log(`פוסט ${post.id} חד-פעמי:`, post.one_time_date, '->', normalizedDate);
      if (normalizedDate) occupiedDates.add(normalizedDate);
    }
    
    // תזמון חודשי - כולל כפילויות באותו יום בחודש
    if (post.schedule_type === 'monthly' && post.monthly_date) {
      const normalizedDate = normalizeDate(post.monthly_date);
      console.log(`פוסט ${post.id} חודשי:`, post.monthly_date, '->', normalizedDate);
      if (normalizedDate) {
        const baseDate = new Date(normalizedDate);
        if (!isNaN(baseDate.getTime())) {
          const targetDay = baseDate.getDate();
          
          // הוסף תאריכים לשנה הקרובה עבור אותו יום בחודש
          for (let i = 0; i < 12; i++) {
            const monthlyDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + i, targetDay);
            if (monthlyDate >= currentDate) { // רק תאריכים עתידיים
              const formattedDate = monthlyDate.getFullYear() + '-' + 
                String(monthlyDate.getMonth() + 1).padStart(2, '0') + '-' + 
                String(monthlyDate.getDate()).padStart(2, '0');
              occupiedDates.add(formattedDate);
              console.log(`הוסף תאריך חודשי: ${formattedDate}`);
            }
          }
        }
      }
    }
    
    // תזמון שבועי - כולל כפילויות באותם ימים
    if (post.schedule_type === 'weekly' && post.days_of_week) {
      const daysOfWeek = post.days_of_week.split(',').filter(Boolean).map(d => parseInt(d));
      console.log(`פוסט ${post.id} שבועי - ימים:`, daysOfWeek);
      
      // חישוב תאריכים שבועיים לשנה הקרובה
      const startDate = post.start_date ? new Date(normalizeDate(post.start_date)) : currentDate;
      const endDate = post.end_date ? new Date(normalizeDate(post.end_date)) : new Date(currentDate.getTime() + 365 * 24 * 60 * 60 * 1000);
      
      let checkDate = new Date(Math.max(startDate.getTime(), currentDate.getTime())); // התחל מהיום או מתאריך ההתחלה
      while (checkDate <= endDate) {
        const dayOfWeek = checkDate.getDay();
        if (daysOfWeek.includes(dayOfWeek)) {
          const formattedDate = checkDate.getFullYear() + '-' + 
            String(checkDate.getMonth() + 1).padStart(2, '0') + '-' + 
            String(checkDate.getDate()).padStart(2, '0');
          occupiedDates.add(formattedDate);
          console.log(`הוסף תאריך שבועי: ${formattedDate}`);
        }
        checkDate.setDate(checkDate.getDate() + 1);
      }
    }
  });
  
  const result = Array.from(occupiedDates);
  console.log('תאריכים תפוסים סה"כ:', result);
  return result;
}

// פונקציה מדויקת לבדיקת התנגשות תאריכים
function isDateConflicted(targetDate, excludePostId, currentScheduleType) {
  console.log('🔍 בודק התנגשות עבור תאריך:', targetDate, 'פוסט נוכחי:', excludePostId, 'סוג:', currentScheduleType);
  
  const normalizedTarget = normalizeDate(targetDate);
  if (!normalizedTarget) {
    console.log('❌ תאריך לא תקין');
    return false;
  }
  
  const targetDateObj = new Date(normalizedTarget);
  const targetDay = targetDateObj.getDay(); // יום בשבוע (0-6)
  const targetDayOfMonth = targetDateObj.getDate(); // יום בחודש (1-31)
  
  console.log('📅 מנותח תאריך:', normalizedTarget, 'יום בשבוע:', targetDay, 'יום בחודש:', targetDayOfMonth);
  
  // בדיקה מול כל הפוסטים הקיימים
  for (const post of allPosts) {
    if (post.id == excludePostId || post.status !== 'scheduled') {
      continue; // דלג על הפוסט הנוכחי או לא מתוזמנים
    }
    
    console.log(`🔍 בודק פוסט ${post.id} (${post.schedule_type}):`, post.title || 'ללא שם');
    
    // בדיקה מול פוסט חד-פעמי
    if (post.schedule_type === 'one-time' && post.one_time_date) {
      const postDate = normalizeDate(post.one_time_date);
      if (postDate === normalizedTarget) {
        console.log(`⚠️ התנגשות עם פוסט חד-פעמי ${post.id} בתאריך ${postDate}`);
        return true;
      }
    }
    
    // בדיקה מול פוסט חודשי
    if (post.schedule_type === 'monthly' && post.monthly_date) {
      const postDate = normalizeDate(post.monthly_date);
      if (postDate) {
        const postDayOfMonth = new Date(postDate).getDate();
        
        // התנגשות אם זה אותו יום בחודש
        if (postDayOfMonth === targetDayOfMonth) {
          console.log(`⚠️ התנגשות עם פוסט חודשי ${post.id} - יום ${postDayOfMonth} בחודש`);
          return true;
        }
      }
    }
    
    // בדיקה מול פוסט שבועי
    if (post.schedule_type === 'weekly' && post.days_of_week) {
      const daysOfWeek = post.days_of_week.split(',').filter(Boolean).map(d => parseInt(d));
      const targetDay = new Date(normalizedTarget).getDay();
      if (daysOfWeek.includes(targetDay)) {
        // בדוק אם התאריך נמצא בטווח התזמון השבועי
        const currentDate = new Date();
        const startDate = post.start_date ? new Date(normalizeDate(post.start_date)) : currentDate;
        const endDate = post.end_date ? new Date(normalizeDate(post.end_date)) : new Date(currentDate.getTime() + 365 * 24 * 60 * 60 * 1000);
        
        if (targetDateObj >= startDate && targetDateObj <= endDate) {
          console.log(`⚠️ התנגשות עם פוסט שבועי ${post.id} - יום ${targetDay} בשבוע`);
          return true;
        }
      }
    }
  }
  
  console.log('✅ אין התנגשות - תאריך זמין');
  return false;
}

function normalizeDate(dateStr) {
  if (!dateStr) return null;
  
  // אם כבר בפורמט YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
    return dateStr;
  }
  
  // אם בפורמט d/m/Y
  const parts = dateStr.split('/');
  if (parts.length === 3) {
    const [d, m, y] = parts;
    if (y && m && d) {
      return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    }
  }
  
  return null;
}

// פונקציה להמרת תאריך לפורמט ישראלי (dd/mm/yyyy)
function formatDateToIsraeli(dateStr) {
  if (!dateStr) return '';
  
  let date;
  
  // אם כבר בפורמט ישראלי
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
    return dateStr;
  }
  
  // אם בפורמט YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
    const [year, month, day] = dateStr.split('-');
    return `${parseInt(day)}/${parseInt(month)}/${year}`;
  }
  
  // נסה לפרש כתאריך רגיל
  date = new Date(dateStr);
  if (!isNaN(date.getTime())) {
    const day = date.getDate();
    const month = date.getMonth() + 1;
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }
  
  return dateStr; // החזר כמו שזה אם לא הצלחנו לפרש
}

// פונקציה להמרת יום בשבוע למספר לשם ישראלי
function getDayNameInHebrew(dayNumber) {
  const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
  return dayNames[dayNumber] || '';
}

function showDateErrorMessage(message) {
  // הסר הודעה קודמת אם קיימת
  const existingError = document.querySelector('.date-error-message');
  if (existingError) existingError.remove();
  
  // צור הודעת שגיאה חדשה
  const errorDiv = document.createElement('div');
  errorDiv.className = 'date-error-message';
  errorDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #dc3545;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    z-index: 10000;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    max-width: 400px;
    white-space: pre-line;
    line-height: 1.4;
  `;
  errorDiv.textContent = message;
  document.body.appendChild(errorDiv);
  
  // הסר אחרי 6 שניות (יותר זמן להודעות ארוכות)
  setTimeout(() => {
    if (errorDiv.parentNode) {
      errorDiv.parentNode.removeChild(errorDiv);
    }
  }, 6000);
}

function validateDateAvailability(selectedDate, currentPostId, scheduleType) {
  console.log('בודק זמינות תאריך:', selectedDate, 'פוסט:', currentPostId, 'סוג:', scheduleType);
  
  const normalizedDate = normalizeDate(selectedDate);
  if (!normalizedDate) {
    console.log('תאריך לא תקין');
    return true;
  }
  
  // השתמש בפונקציה המדויקת לבדיקת התנגשות
  const isConflicted = isDateConflicted(normalizedDate, currentPostId, scheduleType);
  
  if (isConflicted) {
    // גלה מה סוג הפוסט המתנגש
    const conflictType = getConflictType(normalizedDate, currentPostId);
    
    // הודעת שגיאה מותאמת לפי סוג התזמון
    let errorMessage;
    if (scheduleType === 'one-time') {
      const israeliDate = formatDateToIsraeli(selectedDate);
      errorMessage = `התאריך ${israeliDate} כבר תפוס על ידי פוסט ${conflictType}!`;
    } else if (scheduleType === 'monthly') {
      const selectedDay = new Date(normalizedDate).getDate();
      errorMessage = `יום ${selectedDay} בחודש כבר תפוס על ידי פוסט ${conflictType}!`;
    } else if (scheduleType === 'weekly') {
      const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
      const selectedDayName = dayNames[new Date(normalizedDate).getDay()];
      errorMessage = `יום ${selectedDayName} כבר תפוס על ידי פוסט ${conflictType}!`;
    } else {
      const israeliDate = formatDateToIsraeli(selectedDate);
      errorMessage = `התאריך ${israeliDate} כבר תפוס על ידי פוסט ${conflictType}!`;
    }
    
    showDateErrorMessage(errorMessage);
    return false;
  }
  
  return true;
}

// פונקציה לזיהוי סוג הפוסט המתנגש
function getConflictType(targetDate, excludePostId) {
  const normalizedTarget = normalizeDate(targetDate);
  
  for (const post of allPosts) {
    if (post.id == excludePostId || post.status !== 'scheduled') continue;
    
    if (post.schedule_type === 'one-time' && post.one_time_date) {
      const postDate = normalizeDate(post.one_time_date);
      if (postDate === normalizedTarget) {
        return 'חד-פעמי';
      }
    }
    
    if (post.schedule_type === 'monthly' && post.monthly_date) {
      const postDate = normalizeDate(post.monthly_date);
      if (postDate && new Date(postDate).getDate() === new Date(normalizedTarget).getDate()) {
        return 'חודשי';
      }
    }
    
    if (post.schedule_type === 'weekly' && post.days_of_week) {
      const daysOfWeek = post.days_of_week.split(',').filter(Boolean).map(d => parseInt(d));
      const targetDay = new Date(normalizedTarget).getDay();
      if (daysOfWeek.includes(targetDay)) {
        // בדיקה אם התאריך נופל בטווח התזמון השבועי
        const currentDate = new Date();
        const startDate = post.start_date ? new Date(normalizeDate(post.start_date)) : currentDate;
        const endDate = post.end_date ? new Date(normalizeDate(post.end_date)) : new Date(currentDate.getTime() + 365 * 24 * 60 * 60 * 1000);
        
        if (targetDateObj >= startDate && targetDateObj <= endDate) {
          return 'שבועי';
        }
      }
    }
  }
  
  return 'אחר';
}

// פונקציה נוספת לבדיקת התנגשות בין ימי שבוע
function validateWeeklyDaysAvailability(selectedDays, currentPostId, startDate, endDate) {
  console.log('בודק זמינות ימי שבוע:', selectedDays, 'פוסט:', currentPostId);
  
  if (!selectedDays || selectedDays.length === 0) {
    console.log('אין ימים נבחרים - מאשר אוטומטית');
    return true; // אין ימים נבחרים, אין בעיה
  }
  
  // בדיקה ישירה מול כל הפוסטים השבועיים האחרים
  const conflicts = [];
  
  allPosts.forEach(post => {
    if (currentPostId && post.id == currentPostId) return; // דלג על הפוסט הנוכחי
    if (post.status !== 'scheduled' || post.schedule_type !== 'weekly') return;
    
    if (post.days_of_week) {
      const otherDays = post.days_of_week.split(',').filter(Boolean).map(d => parseInt(d));
      console.log(`פוסט ${post.id} שבועי עם ימים:`, otherDays);
      
      // בדיקה אם יש חפיפה בימי השבוע
      const overlap = selectedDays.filter(day => otherDays.includes(day));
      if (overlap.length > 0) {
        const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
        const conflictDayNames = overlap.map(d => dayNames[d]).join(', ');
        conflicts.push(`פוסט "${post.title || 'ללא שם'}" כבר משתמש בימים: ${conflictDayNames}`);
        console.log(`התנגשות נמצאה עם פוסט ${post.id} בימים:`, overlap);
      }
    }
  });
  
  // בדיקה מול פוסטים מסוגים אחרים באמצעות הפונקציה המדויקת
  const currentDate = new Date();
  const checkStartDate = startDate ? new Date(normalizeDate(startDate)) : currentDate;
  const checkEndDate = endDate ? new Date(normalizeDate(endDate)) : new Date(currentDate.getTime() + 90 * 24 * 60 * 60 * 1000); // 3 חודשים
  
  let checkDate = new Date(checkStartDate);
  const dateConflicts = [];
  
  while (checkDate <= checkEndDate && dateConflicts.length < 5) { // בודק רק 5 התנגשויות ראשונות
    const dayOfWeek = checkDate.getDay();
    if (selectedDays.includes(dayOfWeek)) {
      const formattedDate = checkDate.getFullYear() + '-' + 
        String(checkDate.getMonth() + 1).padStart(2, '0') + '-' + 
        String(checkDate.getDate()).padStart(2, '0');
      
      // השתמש בפונקציה המדויקת לבדיקת התנגשות
      if (isDateConflicted(formattedDate, currentPostId, 'weekly')) {
        dateConflicts.push(formattedDate);
      }
    }
    checkDate.setDate(checkDate.getDate() + 1);
  }
  
  // הכנת הודעת שגיאה
  if (conflicts.length > 0 || dateConflicts.length > 0) {
    let errorMessage = '';
    
    if (conflicts.length > 0) {
      errorMessage += conflicts.join('\n');
    }
    
    if (dateConflicts.length > 0) {
      if (errorMessage) errorMessage += '\n\n';
      const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
      const selectedDayNames = selectedDays.map(d => dayNames[d]).join(', ');
      const conflictDatesFormatted = dateConflicts.map(date => {
        const d = new Date(date);
        return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
      }).join(', ');
      
      errorMessage += `הימים ${selectedDayNames} מתנגשים עם פוסטים אחרים בתאריכים: ${conflictDatesFormatted}`;
    }
    
    showDateErrorMessage(errorMessage);
    return false;
  }
  
  return true;
}

// פונקציה גלובלית לבדיקת בחירת ימי שבוע
window.validateWeeklySelection = function(checkbox, postId) {
  console.log('בודק בחירת יום שבוע:', checkbox.value, 'פוסט:', postId, 'מסומן:', checkbox.checked);
  
  if (!checkbox.checked) return; // אם בוטל הסימון, אין בעיה
  
  const selectedDay = parseInt(checkbox.value);
  const modal = document.getElementById("status-modal");
  const startDateInput = modal.querySelector('.start-date-input');
  const endDateInput = modal.querySelector('.end-date-input');
  
  // קבל תאריכי התחלה וסיום
  const startDate = startDateInput ? startDateInput.value : '';
  const endDate = endDateInput ? endDateInput.value : '';
  
  // בדיקה אם היום שנבחר מתנגש עם פוסטים אחרים
  if (!validateSingleWeeklyDay(selectedDay, postId, startDate, endDate)) {
    checkbox.checked = false; // בטל את הבחירה
    return;
  }
};

// פונקציה לבדיקת יום בודד בתזמון שבועי
function validateSingleWeeklyDay(dayOfWeek, currentPostId, startDate, endDate) {
  console.log('בודק יום שבוע:', dayOfWeek, 'פוסט:', currentPostId);
  
  // חישוב תאריכים עתידיים לפי היום שנבחר
  const currentDate = new Date();
  const checkStartDate = startDate ? new Date(normalizeDate(startDate)) : currentDate;
  const checkEndDate = endDate ? new Date(normalizeDate(endDate)) : new Date(currentDate.getTime() + 365 * 24 * 60 * 60 * 1000);
  
  let checkDate = new Date(checkStartDate);
  const conflicts = [];
  
  while (checkDate <= checkEndDate && conflicts.length < 3) { // בודק רק 3 התנגשויות ראשונות
    if (checkDate.getDay() === dayOfWeek) {
      const formattedDate = checkDate.getFullYear() + '-' + 
        String(checkDate.getMonth() + 1).padStart(2, '0') + '-' + 
        String(checkDate.getDate()).padStart(2, '0');
      
      // השתמש בפונקציה המדויקת לבדיקת התנגשות
      if (isDateConflicted(formattedDate, currentPostId, 'weekly')) {
        conflicts.push(formattedDate);
      }
    }
    checkDate.setDate(checkDate.getDate() + 1);
  }
  
  if (conflicts.length > 0) {
    const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
    const conflictDatesFormatted = conflicts.map(date => {
      const d = new Date(date);
      return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
    }).join(', ');
    
    showDateErrorMessage(`יום ${dayNames[dayOfWeek]} מתנגש עם פוסטים אחרים בתאריכים: ${conflictDatesFormatted}`);
    return false;
  }
  
  return true;
}

// פונקציה לרענון Flatpickr בכל הפוסטים
  function refreshFlatpickrForAllPosts() {
    console.log('🔄 מרענן Flatpickr לכל הפוסטים...');
    console.log('📊 מצב allPosts לפני רענון:', allPosts.map(p => ({id: p.id, images: p.images})));
    
    // הסר כל instances קיימים של Flatpickr
    document.querySelectorAll('.flatpickr-input').forEach(input => {
      if (input._flatpickr) {
        input._flatpickr.destroy();
      }
    });
    
    // הפעל מחדש Flatpickr על כל השדות
    setTimeout(() => {
      enableFlatpickrOnDates();
    }, 50);
  }

// פונקציות סינון לפי סטטוס
function applyStatusFilter() {
  const selectedStatuses = Array.from(document.querySelectorAll('.status-filter:checked')).map(cb => cb.value);
  const allCards = document.querySelectorAll('.post-card-collapsed');
  
  allCards.forEach(card => {
    const cardStatus = card.getAttribute('data-status') || 'active';
    if (selectedStatuses.includes(cardStatus)) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
      // סגור את הכרטיס המפורט אם הוא פתוח
      const expandedCard = document.getElementById('expand-post-' + card.getAttribute('data-post-id'));
      if (expandedCard) {
        expandedCard.style.display = 'none';
      }
    }
  });
}

function initStatusFilters() {
  console.log('Initializing status filters...');
  
  // הוסף event listeners לכל checkbox של הסינון
  const checkboxes = document.querySelectorAll('.status-filter');
  console.log('Found checkboxes:', checkboxes.length);
  
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', applyStatusFilter);
  });
  
  // כפתור "נקה הכל"
  const clearBtn = document.getElementById('clear-filters');
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      document.querySelectorAll('.status-filter').forEach(cb => cb.checked = false);
      applyStatusFilter();
    });
  }
  
  // כפתור "בחר הכל"
  const selectAllBtn = document.getElementById('select-all-filters');
  if (selectAllBtn) {
    selectAllBtn.addEventListener('click', () => {
      document.querySelectorAll('.status-filter').forEach(cb => cb.checked = true);
      applyStatusFilter();
    });
  }
  
  // פונקציונליות פתיחה/סגירה של תפריט הסינון
  const filterToggle = document.getElementById('filter-toggle');
  const filterDropdown = document.getElementById('filter-dropdown');
  
  console.log('Filter toggle found:', !!filterToggle);
  console.log('Filter dropdown found:', !!filterDropdown);
  
  if (filterToggle && filterDropdown) {
    filterToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      const isVisible = filterDropdown.style.display === 'block';
      filterDropdown.style.display = isVisible ? 'none' : 'block';
      
      console.log('Toggle clicked, dropdown display:', filterDropdown.style.display);
      
      // שנה את החץ
      const arrow = filterToggle.querySelector('span');
      if (arrow) {
        arrow.textContent = isVisible ? '▼' : '▲';
      }
    });
    
    // סגור את התפריט כשלוחצים מחוץ לו
    document.addEventListener('click', (e) => {
      if (!filterToggle.contains(e.target) && !filterDropdown.contains(e.target)) {
        filterDropdown.style.display = 'none';
        const arrow = filterToggle.querySelector('span');
        if (arrow) {
          arrow.textContent = '▼';
        }
      }
    });
  }
  
  // הפעל סינון ראשוני
  applyStatusFilter();
}

// הפעל את פונקציות הסינון אחרי טעינת הדף
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM Content Loaded - initializing filters');
  setTimeout(() => {
    if (!window.statusFiltersInitialized) {
      initStatusFilters();
      window.statusFiltersInitialized = true;
    }
  }, 100);
});
</script>

</body>
</html>