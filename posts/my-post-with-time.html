<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>× ×™×”×•×œ ×¤×•×¡×˜×™×</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/he.js"></script>
    
    <style>
        /* ×ª×™×§×•×Ÿ Mixed Content - ×”×¡×ª×¨×ª ××œ×× ×˜×™× ×©× ×˜×¢× ×™× ×‘-HTTP */
        [src^="http://"], [href^="http://"] {
            display: none !important;
        }
        
        /* ×¡×’× ×•× ×•×ª ×‘×¡×™×¡×™×™× ×œ×¢××•×“ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            line-height: 1.6;
            width: 100vw;
            min-height: 100vh;
            box-sizing: border-box;
        }
        
        /* ×¢×™×¦×•×‘ ×©×“×” ×©×¢×ª ×”×¤×¨×¡×•× */
        .publish-time-input {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .publish-time-input:focus {
            border-color: #0b2743;
            box-shadow: 0 0 0 3px rgba(11, 39, 67, 0.1);
            outline: none;
        }
        
        .publish-time-input:hover {
            border-color: #0b2743;
        }
    </style>
</head>
<body>

<script>
// ×ª×™×§×•×Ÿ Mixed Content ×‘×××¦×¢×•×ª JavaScript
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ”§ Starting advanced Mixed Content fixes...');
    
    // ×¤×•× ×§×¦×™×” ×œ×ª×™×§×•×Ÿ ××œ×× ×˜ ×™×—×™×“
    function fixElement(element, attribute) {
        const originalValue = element[attribute];
        if (originalValue && originalValue.startsWith('http://')) {
            const newValue = originalValue.replace('http://', 'https://');
            element[attribute] = newValue;
            console.log(`âœ… Fixed ${attribute}:`, originalValue, 'â†’', newValue);
            return true;
        }
        return false;
    }
    
    // ×ª×™×§×•×Ÿ ××™×™×“×™ ×©×œ ××œ×× ×˜×™× ×§×™×™××™×
    function fixExistingElements() {
        let fixedCount = 0;
        
        // CSS links
        document.querySelectorAll('link[href^="http://"]').forEach(link => {
            if (fixElement(link, 'href')) fixedCount++;
        });
        
        // Scripts
        document.querySelectorAll('script[src^="http://"]').forEach(script => {
            if (fixElement(script, 'src')) fixedCount++;
        });
        
        // Images
        document.querySelectorAll('img[src^="http://"]').forEach(img => {
            if (fixElement(img, 'src')) fixedCount++;
        });
        
        // Other elements
        document.querySelectorAll('[src^="http://"], [href^="http://"]').forEach(element => {
            ['src', 'href'].forEach(attr => {
                if (element[attr]) fixElement(element, attr);
            });
        });
        
        if (fixedCount > 0) {
            console.log(`ğŸ¯ Fixed ${fixedCount} HTTP elements to HTTPS`);
        }
    }
    
    // ×”×¤×¢×œ ×ª×™×§×•×Ÿ ×¨××©×•× ×™
    fixExistingElements();
    
    // ×ª×™×§×•×Ÿ ×¨×¦×™×£ ×›×œ 3 ×©× ×™×•×ª
    setInterval(fixExistingElements, 3000);
    
    // ×××–×™×Ÿ ×œ×©×’×™××•×ª Mixed Content
    window.addEventListener('error', function(e) {
        if (e.target && e.target.src && e.target.src.startsWith('http://')) {
            console.warn('âš ï¸ Mixed Content blocked, attempting fix:', e.target.src);
            fixElement(e.target, 'src');
        }
    }, true);
    
    // ×˜×™×¤×•×œ ×‘××©××‘×™ CSS ×©× ×˜×¢× ×™× ×“×™× ××™×ª
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) { // Element node
                    if (node.tagName === 'LINK' && node.href && node.href.startsWith('http://')) {
                        fixElement(node, 'href');
                    }
                    if (node.tagName === 'SCRIPT' && node.src && node.src.startsWith('http://')) {
                        fixElement(node, 'src');
                    }
                }
            });
        });
    });
    
    observer.observe(document.head, { childList: true, subtree: true });
    observer.observe(document.body, { childList: true, subtree: true });
    
    console.log('âœ… Advanced Mixed Content protection active');
});

function formatAIText(text) {
  let html = text
    .replace(/\r\n/g, '\n')
    .replace(/\n{2,}/g, '\n\n')
    .replace(/(^|\n)- /g, '$1â€¢ ')
    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
    .replace(/\n/g, '<br>');
  return `<div style="white-space:pre-line;font-size:1.13em;line-height:1.7;direction:rtl;text-align:right">${html}</div>`;
}

// ×¤×•× ×§×¦×™×” ×¤×©×•×˜×” ×œ×˜×™×¤×•×œ ×‘× ×ª×™×‘×™ ××“×™×”
function getMediaSrc(mediaPath) {
    if (!mediaPath) return '';
    
    console.log('ğŸ–¼ï¸ Processing media path:', mediaPath);
    
    // ×× ×–×” ×›×‘×¨ URL ××œ× ×¢× http/https
    if (mediaPath.startsWith('http')) {
        console.log('âœ… Using full URL:', mediaPath);
        return mediaPath;
    }
    
    // ×× ×–×” ××ª×—×™×œ ×‘-/wp-content (× ×ª×™×‘ ××œ×)
    if (mediaPath.startsWith('/wp-content')) {
        console.log('âœ… Using wp-content path:', mediaPath);
        return mediaPath;
    }
    
    // ×‘××§×¨×™× ××—×¨×™×, ×”×•×¡×£ ××ª ×”× ×ª×™×‘ ×”××œ×
    const finalPath = `/wp-content/postify-api/${mediaPath}`;
    console.log('âœ… Added full path:', mediaPath, 'â†’', finalPath);
    return finalPath;
}
</script>
<div class="posts-container">
  <div style="display:flex;align-items:center;justify-content:space-between;margin:18px 0 22px 0;flex-wrap:wrap;gap:15px;">
    <div style="display:flex;align-items:center;gap:15px;">
      <button class="add-post-btn" id="add-post-btn" style="background: #0b2743; color: #fff; border: none; border-radius: 11px; padding: 9px 23px; font-size: 1.12em; font-weight: bold; box-shadow: 0 2px 8px #41d6c312;">â• ×”×•×¡×£ ×¤×•×¡×˜ ×—×“×©</button>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <div style="position:relative;">
        <button id="filter-toggle" style="background:#0b2743;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:8px;box-shadow:0 2px 8px rgba(11,39,67,0.2);">
          ğŸ” ×¡×™× ×•×Ÿ ×¤×•×¡×˜×™× <span style="font-size:0.8em;">â–¼</span>
        </button>
        <div id="filter-dropdown" style="display:none;position:absolute;top:45px;left:0;background:#fff;border:1px solid #ddd;border-radius:8px;padding:15px;box-shadow:0 4px 20px rgba(0,0,0,0.1);z-index:1000;min-width:280px;">
          <div style="font-weight:bold;margin-bottom:12px;color:#333;border-bottom:1px solid #eee;padding-bottom:8px;">×‘×—×¨ ×¡×˜×˜×•×¡×™× ×œ×”×¦×’×”:</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:15px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;border-radius:5px;transition:background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" class="status-filter" value="active" checked style="transform:scale(1.1);"> 
              <span style="display:flex;align-items:center;gap:5px;">ğŸŸ¢ <strong>×¤×¢×™×œ</strong></span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;border-radius:5px;transition:background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" class="status-filter" value="paused" checked style="transform:scale(1.1);"> 
              <span style="display:flex;align-items:center;gap:5px;">â¸ï¸ <strong>××•×©×‘×ª</strong></span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;border-radius:5px;transition:background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" class="status-filter" value="scheduled" checked style="transform:scale(1.1);"> 
              <span style="display:flex;align-items:center;gap:5px;">â° <strong>××ª×•×–××Ÿ</strong></span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;border-radius:5px;transition:background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" class="status-filter" value="finished" checked style="transform:scale(1.1);"> 
              <span style="display:flex;align-items:center;gap:5px;">âœ… <strong>×”×¡×ª×™×™×</strong></span>
            </label>
          </div>
          <div style="display:flex;gap:8px;border-top:1px solid #eee;padding-top:12px;">
            <button id="select-all-filters" style="background:#28a745;color:#fff;border:none;border-radius:5px;padding:6px 12px;font-size:0.85em;flex:1;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">âœ“ ×‘×—×¨ ×”×›×œ</button>
            <button id="clear-filters" style="background:#6c757d;color:#fff;border:none;border-radius:5px;padding:6px 12px;font-size:0.85em;flex:1;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">âœ— × ×§×” ×”×›×œ</button>
          </div>
        </div>
      </div>
      <div style="position:relative;">
        <button id="settings-toggle" style="background:#28a745;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:8px;box-shadow:0 2px 8px rgba(40,167,69,0.2);">
          âš™ï¸ ×”×’×“×¨×•×ª ×”×¤×¨×¡×•× <span style="font-size:0.8em;">â–¼</span>
        </button>
        <div id="settings-dropdown" style="display:none;position:absolute;top:45px;left:0;background:#fff;border:1px solid #ddd;border-radius:8px;padding:20px;box-shadow:0 4px 20px rgba(0,0,0,0.1);z-index:1000;min-width:350px;">
          <div style="font-weight:bold;margin-bottom:15px;color:#333;border-bottom:1px solid #eee;padding-bottom:8px;font-size:1.1em;">âš™ï¸ ×”×’×“×¨×•×ª ×¤×¨×¡×•×</div>
          <div style="display:grid;gap:18px;">
            <div>
              <label style="display:block;font-weight:bold;margin-bottom:8px;color:#555;">
                ×›××” ×¤×•×¡×˜×™× ×œ×¤×¨×¡× ×‘×™×•×
                <span style="cursor:help;color:#007bff;margin-right:5px;" title="××¡×¤×¨ ×”×¤×•×¡×˜×™× ×”×©×•× ×™× ×©×™×¤×•×¨×¡××• ×‘×™×•× ××—×“ (×œ× ××¡×¤×¨ ×”×¤×¨×¡×•××™× ×”×›×•×œ×œ, ××œ× ××¡×¤×¨ ×”×¤×•×¡×˜×™×/× ×›×¡×™×/××©×¨×•×ª/×›×¨×˜×™×¡×™×•×ª ×©×•× ×™× ×©×™×¤×•×¨×¡××•).\n×”×”××œ×¦×”: ×œ×¤×¨×¡× ×¤×•×¡×˜ ××—×“ ×‘×™×•× ×‘×›××” ×©×™×•×ª×¨ ×§×‘×•×¦×•×ª, ××š × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×›××” ×¤×•×¡×˜×™× ×©×ª×¨×¦×•.">â„¹ï¸</span>
              </label>
              <input type="number" id="max-posts-per-day" min="1" max="50" value="5" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:5px;font-size:1em;">
              <small style="color:#666;font-size:0.85em;display:block;margin-top:4px;">×‘×¨×™×¨×ª ××—×“×œ: 1 ×¤×•×¡×˜ ×‘×™×•×</small>
            </div>
            <div>
              <label style="display:block;font-weight:bold;margin-bottom:8px;color:#555;">
                ××§×¡×™××•× ×¤×¨×¡×•××™× ×‘×™×•×
                <span style="cursor:help;color:#007bff;margin-right:5px;" title="×××—×¨ ×•×œ×›×œ ×œ×§×•×— ×™×© ×”×’×‘×œ×” ×©×•× ×” ×‘×¤×™×™×¡×‘×•×§ ×œ×’×‘×™ ××¡×¤×¨ ×”×¤×¨×¡×•××™× ×”×™×•××™×™×, ×”×”××œ×¦×” ×”×™× ×œ×”×™×•×ª ×‘×™×Ÿ 30-50 ×¤×¨×¡×•××™× ×™×•××™×™×.\n×œ× ××©× ×” ×›××” ×¤×•×¡×˜×™× ××ª×¤×¨×¡××™× â€“ ×”××¢×¨×›×ª ×ª×’×‘×™×œ ×‘×¦×•×¨×” ×”×’×™×•× ×™×ª.">â„¹ï¸</span>
              </label>
              <input type="number" id="max-publications-per-day" min="1" max="100" value="15" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:5px;font-size:1em;">
              <small style="color:#666;font-size:0.85em;display:block;margin-top:4px;">×‘×¨×™×¨×ª ××—×“×œ: 50 ×¤×¨×¡×•××™× ×‘×¡×”"×› ×œ×™×•× (×œ×›×œ ×”×¤×•×¡×˜×™× ×™×—×“)</small>
            </div>
          </div>
          <div style="display:flex;gap:10px;border-top:1px solid #eee;padding-top:15px;margin-top:18px;">
            <button id="save-settings" style="background:#007bff;color:#fff;border:none;border-radius:5px;padding:10px 20px;font-size:0.9em;flex:1;cursor:pointer;font-weight:bold;transition:background 0.2s;" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">ğŸ’¾ ×©××•×¨ ×”×’×“×¨×•×ª</button>
            <button id="cancel-settings" style="background:#6c757d;color:#fff;border:none;border-radius:5px;padding:10px 20px;font-size:0.9em;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">âŒ ×‘×™×˜×•×œ</button>
          </div>
          <div style="margin-top:12px;padding:8px;background:#f8f9fa;border-radius:5px;font-size:0.8em;color:#666;border-right:3px solid #007bff;">
            <strong>ğŸ’¡ ×˜×™×¤:</strong> ×”×©×™× ×•×™×™× ×™×›× ×¡×• ×œ×ª×•×§×£ ×‘×”×¤×¢×œ×” ×”×‘××” ×©×œ ×”××¢×¨×›×ª
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="posts-area"></div>
</div>

<style>
  @media (max-width: 768px) {
    .posts-container > div:first-child {
      flex-direction: column !important;
      align-items: stretch !important;
      gap: 15px !important;
    }
    
    .post-card-collapsed > div {
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 8px !important;
    }
    
    .post-card-collapsed > div > div {
      width: 100% !important;
      max-width: none !important;
      white-space: normal !important;
    }
    
    #filter-dropdown {
      left: auto !important;
      right: 0 !important;
      min-width: 250px !important;
    }
  }
  
  @media (max-width: 480px) {
    #filter-dropdown {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      max-width: 90vw !important;
      max-height: 80vh !important;
      overflow-y: auto !important;
    }
  }
</style>

<script>
let hostname = "";
let collections = [];
let allPosts = [];

// ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª ××–×”×” ×”×¤×•×¡×˜ ×”× ×•×›×—×™ ×©× ×¢×¨×š
function getCurrentEditingPostId() {
    // ×—×¤×© ××ª ×”×˜××‘ ×”×¤×¢×™×œ
    const activeTab = document.querySelector('.tab-content.active');
    if (activeTab) {
        const postId = activeTab.id.replace('tab-', '');
        if (postId && postId !== 'new' && postId !== 'collections') {
            return postId;
        }
    }
    
    // ×—×¤×© ××•×“××œ ×¤×ª×•×—
    const openModal = document.querySelector('.modal[style*="display: block"], .modal.show');
    if (openModal) {
        const modalId = openModal.id;
        if (modalId && modalId.startsWith('editModal-')) {
            return modalId.replace('editModal-', '');
        }
    }
    
    return null;
}

// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×ª×–××•×Ÿ Google Cloud ×›×©××©×ª× ×” ×©×¢×ª ×¤×¨×¡×•×
async function updateScheduleAfterTimeChange(postId = null) {
    try {
        console.log('ğŸ”„ ××¢×“×›×Ÿ ×ª×–××•×Ÿ Google Cloud ×¢×§×‘ ×©×™× ×•×™ ×‘×©×¢×ª ×¤×¨×¡×•×...');
        console.log('ğŸ·ï¸ Hostname ×©×‘×©×™××•×©:', hostname);
        console.log('ğŸ“ Post ID:', postId);
        
        // ×× ×œ× ×¡×•×¤×§ postId, × ×¡×” ×œ××¦×•× ××•×ª×• ××”×§×•× ×˜×§×¡×˜
        if (!postId) {
            // ×—×¤×© ××ª ×”×¤×•×¡×˜ ×”×¤×¢×™×œ ××• ×”×©×ª××© ×‘-bulk ×¢×‘×•×¨ ×›×œ ×”×¤×•×¡×˜×™×
            postId = getCurrentEditingPostId() || 'bulk_update';
        }
        
        const response = await fetch('/wp-content/postify-api/update-schedule-trigger.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'update_schedule',
                hostname: hostname, // ×”×©×ª××© ×‘-hostname ×©× ×˜×¢×Ÿ ××”×©×¨×ª
                postId: postId,
                publishTime: 'auto'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log('âœ… ×ª×–××•×Ÿ Google Cloud ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”:', result.message);
            
            // ×”×¦×’ ×”×•×“×¢×” ×§×¦×¨×” ×œ××©×ª××©
            const notification = document.createElement('div');
            notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#4CAF50;color:white;padding:10px;border-radius:5px;z-index:9999;';
            notification.textContent = 'âœ… ×”×ª×–××•×Ÿ ×¢×•×“×›×Ÿ ×‘×¢× ×Ÿ';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        } else {
            console.warn('âš ï¸ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×ª×–××•×Ÿ:', result.message);
            
            // ×”×¦×’ ×”×•×“×¢×ª ×©×’×™××”
            const notification = document.createElement('div');
            notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#f44336;color:white;padding:10px;border-radius:5px;z-index:9999;';
            notification.textContent = 'âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×ª×–××•×Ÿ';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }
        
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘×§×¨×™××” ×œ×¢×“×›×•×Ÿ ×ª×–××•×Ÿ:', error.message);
        
        // ×”×¦×’ ×”×•×“×¢×ª ×©×’×™××”
        const notification = document.createElement('div');
        notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#f44336;color:white;padding:10px;border-radius:5px;z-index:9999;';
        notification.textContent = 'âŒ ×©×’×™××” ×‘×¨×©×ª';
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    }
}

// ×¤×•× ×§×¦×™×” ×œ×—×™×œ×•×¥ ×©× ×”××•×ª×’ ××”×§×™×©×•×¨ ×”××§×•×¨×™
function extractBrandFromUrl(url) {
    try {
        // × ×•×¡×£ https:// ×× ××™×Ÿ
        const fullUrl = url.startsWith('http') ? url : 'https://' + url;
        const urlObj = new URL(fullUrl);
        const hostname = urlObj.hostname;
        
        // ×”×¡×¨ www. ×× ×§×™×™×
        const domain = hostname.replace(/^www\./, '');
        
        // ×§×— ××ª ×”×—×œ×§ ×”×¨××©×•×Ÿ ×©×œ ×”×“×•××™×™×Ÿ (×œ×¤× ×™ ×”× ×§×•×“×” ×”×¨××©×•× ×”)
        const brandName = domain.split('.')[0];
        
        console.log('ğŸ·ï¸ ×—×™×œ×•×¥ ××•×ª×’:', url, 'â†’', brandName);
        return brandName.toLowerCase();
    } catch (e) {
        console.warn('âŒ ×©×’×™××” ×‘×—×™×œ×•×¥ ××•×ª×’:', e);
        return 'link'; // ×‘×¨×™×¨×ª ××—×“×œ
    }
}

// ×¤×•× ×§×¦×™×” ×œ×§×™×¦×•×¨ ×§×™×©×•×¨×™× ×¢× ××•×ª×’ ×“×™× ×××™ ××”×§×™×©×•×¨ ×”××§×•×¨×™
async function shortenUrl(longUrl) {
    console.log('ğŸ”— ×× ×¡×” ×œ×§×¦×¨ ×§×™×©×•×¨:', longUrl);
    
    // ×—×œ×¥ ××ª ×©× ×”××•×ª×’ ××”×§×™×©×•×¨ ×”××§×•×¨×™
    const brandName = extractBrandFromUrl(longUrl);
    
    // 1. × ×¡×” TinyURL ×¢× alias ×”××›×™×œ ××ª ×©× ×”××•×ª×’ (×”×›×™ ×˜×•×‘ ×œ××•×ª×’)
    try {
        console.log('ğŸ”„ ×× ×¡×” TinyURL ×¢× ××•×ª×’ ×“×™× ×××™:', brandName);
        const randomId = Math.random().toString(36).substring(2, 6);
        const alias = `${brandName}-${randomId}`;
        console.log('ğŸ¯ ×× ×¡×” alias:', alias);
        
        const tinyUrl = `https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}&alias=${alias}`;
        const response = await fetch(tinyUrl, { timeout: 5000 });
        
        if (response.ok) {
            const shortUrl = await response.text();
            console.log('ğŸ“¥ ×ª×©×•×‘×” ×-TinyURL ×¢× alias:', shortUrl);
            if (shortUrl && shortUrl.includes(brandName) && !shortUrl.includes('Error') && !shortUrl.includes('already')) {
                console.log('âœ… ×§×™×¦×•×¨ ×”×¦×œ×™×— ×¢× TinyURL + ××•×ª×’ ×“×™× ×××™:', shortUrl);
                return shortUrl.trim();
            } else {
                console.warn('âš ï¸ TinyURL alias × ×›×©×œ ××• ×œ× ×–××™×Ÿ:', shortUrl);
            }
        } else {
            console.warn('âš ï¸ TinyURL alias - ×ª×©×•×‘×” ×œ× ×ª×§×™× ×”:', response.status);
        }
    } catch (e) {
        console.warn('âš ï¸ TinyURL ×¢× ××•×ª×’ ×“×™× ×××™ × ×›×©×œ:', e.message);
    }
    
    // 2. × ×¡×” Rebrandly ×¢× slashtag ×”××›×™×œ ××ª ×©× ×”××•×ª×’ (×××™×Ÿ ×™×•×ª×¨)
    try {
        console.log('ğŸ”„ ×× ×¡×” Rebrandly ×¢× ××•×ª×’ ×“×™× ×××™:', brandName);
        const randomId = Math.random().toString(36).substring(2, 4);
        const slashtag = `${brandName}${randomId}`;
        console.log('ğŸ¯ ×× ×¡×” slashtag:', slashtag);
        
        const rebrandlyUrl = 'https://api.rebrandly.com/v1/links';
        const response = await fetch(rebrandlyUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                "destination": longUrl,
                "slashtag": slashtag
            }),
            timeout: 5000
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('ğŸ“¥ ×ª×©×•×‘×” ×-Rebrandly:', data);
            if (data.shortUrl && data.shortUrl.includes(brandName)) {
                console.log('âœ… ×§×™×¦×•×¨ ×”×¦×œ×™×— ×¢× Rebrandly + ××•×ª×’ ×“×™× ×××™:', data.shortUrl);
                return data.shortUrl;
            } else {
                console.warn('âš ï¸ Rebrandly - ×œ× ××›×™×œ ××•×ª×’ ××• ×©×’×™××”:', data);
            }
        } else {
            console.warn('âš ï¸ Rebrandly - ×ª×©×•×‘×” ×œ× ×ª×§×™× ×”:', response.status);
        }
    } catch (e) {
        console.warn('âš ï¸ Rebrandly ×¢× ××•×ª×’ ×“×™× ×××™ × ×›×©×œ:', e.message);
    }
    
    // 3. × ×¡×” is.gd (×œ×œ× ××•×ª×’ ××‘×œ ×××™×Ÿ)
    try {
        console.log('ğŸ”„ ×× ×¡×” is.gd ×¢× JSONP ×•××•×ª×’ ×“×™× ×××™...');
        const isGdUrl = `https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}&callback=handleShortUrl`;
        
        // ×™×¦×™×¨×ª JSONP request
        const result = await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const callbackName = 'handleShortUrl_' + Date.now();
            
            window[callbackName] = function(data) {
                document.head.removeChild(script);
                delete window[callbackName];
                resolve(data);
            };
            
            script.src = isGdUrl.replace('handleShortUrl', callbackName);
            script.onerror = () => {
                document.head.removeChild(script);
                delete window[callbackName];
                reject(new Error('JSONP failed'));
            };
            
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (window[callbackName]) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('JSONP timeout'));
                }
            }, 5000);
        });
        
        console.log('ğŸ“¥ ×ª×©×•×‘×” ×-is.gd JSONP:', result);
        if (result.shorturl && result.shorturl.startsWith('https://is.gd/')) {
            console.log('âœ… ×§×™×¦×•×¨ ×”×¦×œ×™×— ×¢× is.gd JSONP (×œ×œ× ××•×ª×’):', result.shorturl);
            return result.shorturl;
        }
    } catch (e) {
        console.warn('âš ï¸ is.gd JSONP × ×›×©×œ:', e.message);
    }
    
    // 4. × ×¡×” TinyURL ×¨×’×™×œ ×›×’×™×‘×•×™ ××—×¨×•×Ÿ (×œ×œ× ××•×ª×’)
    try {
        console.log('ğŸ”„ ×× ×¡×” TinyURL ×¨×’×™×œ (×’×™×‘×•×™ ××—×¨×•×Ÿ)...');
        const tinyUrl = 'https://tinyurl.com/api-create.php?url=' + encodeURIComponent(longUrl);
        const response = await fetch(tinyUrl, { timeout: 5000 });
        
        if (response.ok) {
            const shortUrl = await response.text();
            console.log('ğŸ“¥ ×ª×©×•×‘×” ×-TinyURL ×¨×’×™×œ:', shortUrl);
            if (shortUrl && shortUrl.startsWith('https://tinyurl.com/') && !shortUrl.includes('Error') && shortUrl.trim().length > 20) {
                console.log('âœ… ×§×™×¦×•×¨ ×”×¦×œ×™×— ×¢× TinyURL ×¨×’×™×œ (×’×™×‘×•×™):', shortUrl);
                return shortUrl.trim();
            }
        }
    } catch (e) {
        console.warn('âš ï¸ TinyURL ×¨×’×™×œ × ×›×©×œ:', e.message);
    }
    
    // 4. × ×¡×” TinyURL ×›×’×™×‘×•×™ ××—×¨×•×Ÿ (×¢× ×˜×™×¤×•×œ ×˜×•×‘ ×™×•×ª×¨ ×‘×©×’×™××•×ª)
    try {
        console.log('ğŸ”„ ×× ×¡×” TinyURL (×’×™×‘×•×™ ××—×¨×•×Ÿ)...');
        const tinyUrl = 'https://tinyurl.com/api-create.php?url=' + encodeURIComponent(longUrl);
        const response = await fetch(tinyUrl, { timeout: 5000 });
        
        if (response.ok) {
            const shortUrl = await response.text();
            console.log('ğŸ“¥ ×ª×©×•×‘×” ×-TinyURL:', shortUrl);
            if (shortUrl && shortUrl.startsWith('https://tinyurl.com/') && !shortUrl.includes('Error') && shortUrl.trim().length > 20) {
                console.log('âœ… ×§×™×¦×•×¨ ×”×¦×œ×™×— ×¢× TinyURL (×’×™×‘×•×™):', shortUrl);
                return shortUrl.trim();
            }
        }
    } catch (e) {
        console.warn('âš ï¸ TinyURL × ×›×©×œ:', e.message);
    }
    
    // ×× ×”×›×œ × ×›×©×œ, ×”×—×–×¨ ××ª ×”×§×™×©×•×¨ ×”××§×•×¨×™
    console.log('â†©ï¸ ××—×–×™×¨ ×§×™×©×•×¨ ××§×•×¨×™ (×›×œ ×”×©×™×¨×•×ª×™× × ×›×©×œ×•):', longUrl);
    return longUrl;
}

// ×¤×•× ×§×¦×™×” ×œ×¡×¨×•×§ ×˜×§×¡×˜, ×œ××¦×•× ×œ×™× ×§×™× (×›×•×œ×œ www) ×•×œ×§×¦×¨ ××•×ª× (××¡×™× ×›×¨×•× ×™×ª)
async function autoShortenLinks(text) {
    console.log('ğŸ” ××ª×—×™×œ ×œ×—×¤×© ×§×™×©×•×¨×™× ×‘×˜×§×¡×˜:', text);
    // ×ª×‘× ×™×ª ××•×¨×—×‘×ª: http/https ×•×’× www
    const pattern = /((https?:\/\/|www\.)[^\s]+)/g;
    const urls = [...text.matchAll(pattern)].map(m => m[0]);
    console.log('ğŸ¯ × ××¦××• ×§×™×©×•×¨×™×:', urls);
    let shortMap = {};
    for (const url of urls) {
        let urlForApi = url;
        if (url.startsWith('www.')) {
            urlForApi = 'https://' + url; // ×©×™××•×© ×‘-https ×‘××§×•× http
        }
        console.log('ğŸ”„ ××¢×‘×“ ×§×™×©×•×¨:', url, 'â†’', urlForApi);
        if (!shortMap[url]) {
            shortMap[url] = await shortenUrl(urlForApi);
        }
    }
    console.log('ğŸ“‹ ××¤×ª ×§×™×¦×•×¨×™×:', shortMap);
    const result = text.replace(pattern, url => shortMap[url] || url);
    console.log('ğŸ“ ×˜×§×¡×˜ ××—×¨×™ ×§×™×¦×•×¨:', result);
    return result;
}

// ×¦×•×¨ ×¤×•×¤××¤ AI ×¤×¢× ××—×ª ×‘×œ×‘×“ ×‘×”×ª×—×œ×”
(function createAiModalOnce(){
  if (document.getElementById("ai-upgrade-modal")) return;
  const modal = document.createElement("div");
  modal.id = "ai-upgrade-modal";
  modal.style.cssText = "display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;";
  modal.innerHTML = `
  <div id="ai-modal-box" style="position:relative;background:#fff;padding:20px;border-radius:13px;max-width:500px;max-height:80vh;overflow-y:auto;">
    <button id="ai-before-after-btn" style="position:absolute;top:12px;left:12px;z-index:2;display:none;background:#e6f0fa;border:none;border-radius:7px;padding:6px 13px;font-weight:bold;cursor:pointer;">×œ×¤× ×™-××—×¨×™</button>
    <div id="ai-modal-content" style="margin-top:40px;"></div>
    <div style="margin-top:18px;text-align:left;">
      <button id="ai-upgrade-apply" style="background:#0b2743;color:#fff;border:none;border-radius:7px;padding:7px 15px;margin-left:8px;">×©×“×¨×’</button>
      <button id="ai-upgrade-cancel" style="background:#ccc;border:none;border-radius:7px;padding:7px 15px;">×‘×˜×œ</button>
    </div>
  </div>
  `;
  document.body.appendChild(modal);
})();

// ×¦×•×¨ ×¤×•×¤××¤ ×¡×˜×˜×•×¡ ××•×“×¨× ×™ ×•××§×¦×•×¢×™
(function createStatusModalOnce(){
  if (document.getElementById("status-modal")) return;
  const modal = document.createElement("div");
  modal.id = "status-modal";
  modal.style.cssText = "display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(11,39,67,0.7);z-index:9999;backdrop-filter:blur(12px) saturate(180%) brightness(0.8);transition:all 0.4s ease;";
  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,251,255,0.9) 100%);
      backdrop-filter: blur(20px) saturate(120%);
      padding: 0;
      border-radius: 24px;
      max-width: 580px;
      margin: 40px auto 0 auto;
      box-shadow: 
        0 32px 64px rgba(11,39,67,0.2), 
        0 16px 32px rgba(11,39,67,0.1),
        inset 0 1px 0 rgba(255,255,255,0.6);
      position: relative;
      max-height: 85vh;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.4);
      transform-style: preserve-3d;
    ">
      <!-- Header -->
      <div style="
        background: linear-gradient(135deg, #0b2743 0%, #1a3a5c 100%);
        padding: 24px 32px;
        color: white;
        position: relative;
        border-radius: 24px 24px 0 0;
      ">
        <button id="close-status-modal" style="
          position: absolute;
          top: 16px;
          left: 16px;
          background: rgba(255,255,255,0.1);
          border: none;
          border-radius: 50%;
          width: 36px;
          height: 36px;
          color: white;
          font-size: 18px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.3s ease;
          backdrop-filter: blur(10px);
        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">Ã—</button>
        
        <div style="text-align: center;">
          <div style="font-size: 32px; margin-bottom: 8px;">â°</div>
          <h2 style="margin: 0; font-size: 1.4em; font-weight: 600;">×ª×–××•×Ÿ ×¤×¨×¡×•× ×¤×•×¡×˜</h2>
          <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 0.95em;">×‘×—×¨ ×›×™×¦×“ ×•××ª×™ ×”×¤×•×¡×˜ ×™×ª×¤×¨×¡× ×‘×¨×©×ª×•×ª ×”×—×‘×¨×ª×™×•×ª</p>
        </div>
      </div>

      <!-- Content -->
      <div style="padding: 32px; overflow-y: auto; max-height: calc(85vh - 220px); min-height: 300px;">
        
        <!-- Status Options -->
        <div style="display: grid; gap: 16px; margin-bottom: 24px;">
          
          <!-- Active Status -->
          <label class="status-option" data-status="active" style="
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #e0f2fe;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(34,197,94,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            <div style="
              background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
              border-radius: 50%;
              width: 48px;
              height: 48px;
              display: flex;
              align-items: center;
              justify-content: center;
              margin-left: 16px;
              box-shadow: 0 4px 12px rgba(34,197,94,0.3);
            ">
              <span style="font-size: 20px;">ğŸš€</span>
            </div>
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; margin-bottom: 6px;">
                <input type="radio" name="status-choice" value="active" style="margin-left: 8px; transform: scale(1.2);">
                <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: #059669;">×¤×¢×™×œ ××™×“</h3>
              </div>
              <p style="margin: 0; font-size: 0.9em; color: #065f46; opacity: 0.8;">×”×¤×•×¡×˜ ×™×ª×¤×¨×¡× ××™×“ ×œ×¤×™ ×œ×•×— ×”×–×× ×™× ×”×¨×’×™×œ ×©×œ ×”××¢×¨×›×ª</p>
            </div>
          </label>

          <!-- Scheduled Status -->
          <label class="status-option" data-status="scheduled" style="
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
            border: 2px solid #fcd34d;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(245,158,11,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            <div style="
              background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
              border-radius: 50%;
              width: 48px;
              height: 48px;
              display: flex;
              align-items: center;
              justify-content: center;
              margin-left: 16px;
              box-shadow: 0 4px 12px rgba(245,158,11,0.3);
            ">
              <span style="font-size: 20px;">â°</span>
            </div>
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; margin-bottom: 6px;">
                <input type="radio" name="status-choice" value="scheduled" style="margin-left: 8px; transform: scale(1.2);">
                <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: #d97706;">×ª×–××•×Ÿ ××•×ª×× ××™×©×™×ª</h3>
              </div>
              <p style="margin: 0; font-size: 0.9em; color: #92400e; opacity: 0.8;">×§×‘×¢ ×ª××¨×™×›×™× ×•×–×× ×™× ××“×•×™×§×™× ×œ×¤×¨×¡×•× ×”×¤×•×¡×˜</p>
            </div>
          </label>

          <!-- Paused Status -->
          <label class="status-option" data-status="paused" style="
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(107,114,128,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            <div style="
              background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
              border-radius: 50%;
              width: 48px;
              height: 48px;
              display: flex;
              align-items: center;
              justify-content: center;
              margin-left: 16px;
              box-shadow: 0 4px 12px rgba(107,114,128,0.3);
            ">
              <span style="font-size: 20px;">â¸ï¸</span>
            </div>
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; margin-bottom: 6px;">
                <input type="radio" name="status-choice" value="paused" style="margin-left: 8px; transform: scale(1.2);">
                <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: #4b5563;">××•×©×‘×ª ×–×× ×™×ª</h3>
              </div>
              <p style="margin: 0; font-size: 0.9em; color: #374151; opacity: 0.8;">×”×¤×•×¡×˜ ×œ× ×™×ª×¤×¨×¡× ×›×œ×œ ×¢×“ ×©×ª×©× ×” ××ª ×”×¡×˜×˜×•×¡</p>
            </div>
          </label>

        </div>

        <!-- Schedule Options -->
        <div id="schedule-options" style="display:none; margin-top: 24px;">
          <div style="
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
            border: 1px solid #fcd34d;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
          ">
            <h3 style="margin: 0 0 16px 0; color: #92400e; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 20px;">âš™ï¸</span>
              ×”×’×“×¨×•×ª ×ª×–××•×Ÿ
            </h3>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #92400e;">×¡×•×’ ×”×ª×–××•×Ÿ:</label>
              <select id="schedule-type-select" style="
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #fcd34d;
                border-radius: 12px;
                font-size: 1em;
                background: white;
                transition: all 0.3s ease;
              " onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 0 0 3px rgba(245,158,11,0.1)'" onblur="this.style.borderColor='#fcd34d'; this.style.boxShadow='none'">
                <option value="weekly">ğŸ“… ×©×‘×•×¢×™ - ×¤×¨×¡×•× ×‘×™××™× ×§×‘×•×¢×™× ×‘×©×‘×•×¢</option>
                <option value="monthly">ğŸ—“ï¸ ×—×•×“×©×™ - ×¤×¨×¡×•× ×‘××•×ª×• ×ª××¨×™×š ×›×œ ×—×•×“×©</option>
                <option value="one-time">ğŸ¯ ×—×“Ö¾×¤×¢××™ - ×¤×¨×¡×•× ×¤×¢× ××—×ª ×‘×ª××¨×™×š ××¡×•×™×</option>
              </select>
            </div>
            
            <div id="schedule-fields" style="margin-top: 16px;"></div>
          </div>
        </div>

      </div>

      <!-- Footer -->
      <div style="
        background: #f8fafc;
        padding: 20px 32px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: center;
        gap: 12px;
        border-radius: 0 0 24px 24px;
      ">
        <button id="status-cancel-btn" style="
          background: #f1f5f9;
          color: #475569;
          border: 2px solid #e2e8f0;
          border-radius: 12px;
          padding: 12px 24px;
          font-size: 1em;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          min-width: 120px;
        " class="ripple-effect" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">×‘×™×˜×•×œ</button>
        
        <button id="status-apply-btn" style="
          background: linear-gradient(135deg, #0b2743 0%, #1a3a5c 100%);
          color: white;
          border: none;
          border-radius: 12px;
          padding: 12px 32px;
          font-size: 1em;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 12px rgba(11,39,67,0.3);
          min-width: 120px;
        " class="ripple-effect" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(11,39,67,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(11,39,67,0.3)'">
          <span style="margin-left: 8px;">âœ…</span>
          ××™×©×•×¨
        </button>
      </div>

    </div>
  `;
  document.body.appendChild(modal);
  
  // Debug: ×‘×“×•×§ ×©×”×›×¤×ª×•×¨×™× ×§×™×™××™×
  console.log('ğŸ” ×‘×“×™×§×ª ×›×¤×ª×•×¨×™×:', {
    applyBtn: modal.querySelector("#status-apply-btn"),
    cancelBtn: modal.querySelector("#status-cancel-btn"),
    closeBtn: modal.querySelector("#close-status-modal")
  });

  // ×”×•×¡×£ ×¡×˜×™×™×œ×™× ×œ×× ×™××¦×™×•×ª
  const style = document.createElement('style');
  style.textContent = `
    .status-option input[type="radio"]:checked {
      accent-color: currentColor;
    }
    .status-option[data-status="active"] input[type="radio"]:checked ~ * {
      color: #059669 !important;
    }
    .status-option[data-status="active"].selected {
      border-color: #22c55e !important;
      box-shadow: 0 0 0 3px rgba(34,197,94,0.1) !important;
      transform: translateY(-2px) !important;
    }
    .status-option[data-status="scheduled"].selected {
      border-color: #f59e0b !important;
      box-shadow: 0 0 0 3px rgba(245,158,11,0.1) !important;
      transform: translateY(-2px) !important;
    }
    .status-option[data-status="paused"].selected {
      border-color: #6b7280 !important;
      box-shadow: 0 0 0 3px rgba(107,114,128,0.1) !important;
      transform: translateY(-2px) !important;
    }
    
    /* ×× ×™××¦×™×•×ª ××ª×§×“××•×ª */
    @keyframes modalShow {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    @keyframes modalHide {
      from {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
      to {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
      }
    }
    
    @keyframes blurIn {
      from {
        backdrop-filter: blur(0px) saturate(100%) brightness(1);
        background: rgba(11,39,67,0);
      }
      to {
        backdrop-filter: blur(16px) saturate(180%) brightness(0.7);
        background: rgba(11,39,67,0.75);
      }
    }
    
    @keyframes blurOut {
      from {
        backdrop-filter: blur(16px) saturate(180%) brightness(0.7);
        background: rgba(11,39,67,0.75);
      }
      to {
        backdrop-filter: blur(0px) saturate(100%) brightness(1);
        background: rgba(11,39,67,0);
      }
    }
    
    #status-modal.show {
      animation: blurIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    #status-modal.show > div {
      animation: modalShow 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    #status-modal.hiding {
      animation: blurOut 0.4s ease-in;
    }
    
    #status-modal.hiding > div {
      animation: modalHide 0.3s ease-in;
    }
    
    /* ××¤×§×˜×™ ×œ×—×™×¦×” ×œ×›×¤×ª×•×¨×™× */
    #status-apply-btn:active {
      transform: translateY(0px) scale(0.98) !important;
      box-shadow: 0 2px 8px rgba(11,39,67,0.3) !important;
    }
    
    #status-cancel-btn:active {
      transform: scale(0.98) !important;
    }
    
    #close-status-modal:active {
      transform: scale(0.9) !important;
    }
    
    /* ×¡×˜×™×™×œ×™× ×’ ×œ×”×’×“×¨×•×ª ×¤×¨×¡×•× */
    #settings-toggle:hover {
      background: #218838 !important;
      transform: translateY(-1px);
    }
    
    #settings-dropdown input[type="number"] {
      direction: ltr;
    }
    
    #settings-dropdown input[type="number"]:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
    #save-settings:active, #cancel-settings:active {
      transform: scale(0.98);
    }
    
    /* ×˜×™×¤×˜×•×œ×™× ××—×•×“×¨×™× */
    [title] {
      position: relative;
    }
    
    [title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.8em;
      white-space: nowrap;
      z-index: 1001;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    [title]:hover::before {
      content: '';
      position: absolute;
      bottom: 115%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: #333;
      z-index: 1001;
    }
    
    /* ×× ×™××¦×™×” ×œ×©×“×•×ª ×ª×–××•×Ÿ */
    #schedule-options {
      transition: all 0.4s ease;
    }
    
    #schedule-options.show {
      animation: slideDown 0.4s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
        max-height: 0;
      }
      to {
        opacity: 1;
        transform: translateY(0);
        max-height: 800px;
      }
    }
    
    /* ××¤×§×˜×™ hover ××¢×•×“× ×™× */
    .status-option {
      position: relative;
      overflow: hidden;
    }
    
    .status-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, transparent 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .status-option:hover::before {
      opacity: 1;
    }
    
    /* ××¤×§×˜ ×¨×™×¤×œ ×œ×›×¤×ª×•×¨×™× */
    .ripple-effect {
      position: relative;
      overflow: hidden;
    }
    
    .ripple-effect::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }
    
    .ripple-effect:active::after {
      width: 200px;
      height: 200px;
    }
    
    /* Responsive Design ×œ××•×‘×™×™×œ */
    @media (max-width: 768px) {
      #status-modal > div {
        margin: 20px auto 0 auto !important;
        max-width: 95vw !important;
        max-height: 90vh !important;
      }
      
      #status-modal > div > div:first-child {
        padding: 20px 24px !important;
      }
      
      #status-modal > div > div:nth-child(2) {
        padding: 24px !important;
      }
      
      .status-option {
        padding: 16px !important;
      }
      
      .status-option > div:first-child {
        width: 40px !important;
        height: 40px !important;
        margin-left: 12px !important;
      }
      
      .status-option h3 {
        font-size: 1em !important;
      }
      
      .status-option p {
        font-size: 0.85em !important;
      }
      
      #status-modal > div > div:last-child {
        padding: 16px 24px !important;
        flex-direction: column !important;
        gap: 8px !important;
      }
      
      #status-apply-btn, #status-cancel-btn {
        min-width: 100% !important;
        margin: 0 !important;
      }
    }
    
    @media (max-width: 480px) {
      #status-modal > div {
        margin: 10px auto 0 auto !important;
        border-radius: 16px !important;
      }
      
      #status-modal > div > div:first-child {
        border-radius: 16px 16px 0 0 !important;
      }
      
      #status-modal > div > div:last-child {
        border-radius: 0 0 16px 16px !important;
      }
    }
    
    /* Glass Effect Enhancement */
    #status-modal > div {
      position: relative;
    }
    
    #status-modal > div::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        rgba(255,255,255,0.4) 0%,
        rgba(255,255,255,0.1) 50%,
        rgba(255,255,255,0.2) 100%);
      border-radius: 24px;
      pointer-events: none;
      z-index: 1;
    }
    
    #status-modal > div > * {
      position: relative;
      z-index: 2;
    }
    
    /* Enhanced Header Glass Effect */
    #status-modal > div > div:first-child {
      background: linear-gradient(135deg, 
        rgba(11,39,67,0.95) 0%, 
        rgba(26,58,92,0.9) 50%,
        rgba(11,39,67,0.85) 100%) !important;
      backdrop-filter: blur(15px) saturate(150%) !important;
      border-bottom: 1px solid rgba(255,255,255,0.1) !important;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.1) !important;
    }
    
    /* Enhanced Content Area */
    #status-modal > div > div:nth-child(2) {
      background: rgba(255,255,255,0.1) !important;
      backdrop-filter: blur(10px) !important;
    }
    
    /* Enhanced Footer */
    #status-modal > div > div:last-child {
      background: rgba(248,250,252,0.8) !important;
      backdrop-filter: blur(10px) saturate(110%) !important;
      border-top: 1px solid rgba(226,232,240,0.6) !important;
      position: relative !important;
      z-index: 100 !important;
      flex-shrink: 0 !important;
    }
    
    /* Force buttons to be visible */
    #status-apply-btn, #status-cancel-btn {
      display: inline-block !important;
      visibility: visible !important;
      z-index: 10 !important;
      position: relative !important;
    }
    
    /* Ensure modal structure stays fixed */
    #status-modal > div {
      display: flex !important;
      flex-direction: column !important;
      max-height: 85vh !important;
    }
    
    /* Content area that scrolls */
    #status-modal > div > div:nth-child(2) {
      flex: 1 !important;
      overflow-y: auto !important;
    }
  `;
  document.head.appendChild(style);

  // ×”×•×¡×£ ×××–×™× ×™× ×œ××¤×§×˜×™× ×•×™×–×•××œ×™×™×
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.classList.add('hiding');
      modal.classList.remove('show');
      
      setTimeout(() => {
        modal.style.display = 'none';
        modal.classList.remove('hiding');
      }, 400);
    }
  });

  // ×¢×“×›×Ÿ ××¤×§×˜×™× ×•×™×–×•××œ×™×™× ×›××©×¨ ×‘×•×—×¨×™× ××•×¤×¦×™×”
  modal.querySelectorAll('.status-option input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
      // ×”×¡×¨ ×¡×œ×§×©×Ÿ ××›×œ ×”××•×¤×¦×™×•×ª
      modal.querySelectorAll('.status-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      // ×”×•×¡×£ ×¡×œ×§×©×Ÿ ×œ××•×¤×¦×™×” ×©× ×‘×—×¨×”
      if (this.checked) {
        this.closest('.status-option').classList.add('selected');
      }
    });
  });

})();

// ×˜×¢×Ÿ ××ª ×”-hostname ××”×©×¨×ª ×•××– ×ª××©×™×š
fetch('/wp-content/postify-api/get-hostname.php')
  .then(res => res.text())
  .then(h => {
    hostname = h.trim();
    console.log('hostname:', hostname);
    loadCollections();
  })
  .catch(err => {
    console.error('Error loading hostname:', err);
    loadCollections(); // × ××©×™×š ×’× ×× × ×›×©×œ
  });

// ×˜×¢×Ÿ ××•×¡×¤×™ ×§×‘×•×¦×•×ª
function loadCollections() {
  fetch('/wp-content/postify-api/groups-data.php')
    .then(res => res.json())
    .then(cols => {
      collections = cols;
      loadPostsFromDB();
    })
    .catch(err => {
      console.error('Error loading collections:', err);
      collections = [];
      loadPostsFromDB();
    });
}

// ×˜×¢×Ÿ ××ª ×›×œ ×”×¤×•×¡×˜×™× ××—×¨×™ ×©×”-collections × ×˜×¢× ×•
function loadPostsFromDB() {
  console.log('ğŸ”„ loadPostsFromDB × ×§×¨××” - ×–×” ×¢×œ×•×œ ×œ××—×•×§ ×ª××•× ×•×ª ××§×•××™×•×ª!');
  console.log('ğŸ“Š allPosts ×œ×¤× ×™ ×§×¨×™××” ×œ×©×¨×ª:', allPosts);
  
  fetch('/wp-content/postify-api/posts-data.php?hostname=' + encodeURIComponent(hostname))
    .then(res => res.json())
    .then(posts => {
      console.log('ğŸ“¥ Posts loaded from API:', posts);
      
      // ×‘×“×™×§×” ××¤×•×¨×˜×ª ×©×œ ×”×¤×•×¡×˜ ×¢× ×”×•×™×“××•
      const videoPost = posts.find(p => p.id == 341);
      if (videoPost) {
        console.log('ğŸ¬ ×¤×•×¡×˜ ×•×™×“××• 341 ××”×©×¨×ª:', videoPost);
        console.log('ğŸ“ ×ª××•× ×•×ª ×‘×¤×•×¡×˜ ×•×™×“××• ××”×©×¨×ª:', videoPost.images);
      }
      
      // ×©××™×¨×ª ×”×¤×•×¡×˜×™× ×”×™×©× ×™× ×œ×¤× ×™ ×”×—×œ×¤×”
      const oldPosts = [...allPosts];
      const oldVideoPost = oldPosts.find(p => p.id == 341);
      if (oldVideoPost) {
        console.log('ğŸ¬ ×¤×•×¡×˜ ×•×™×“××• 341 ×œ×¤× ×™ ×”×—×œ×¤×”:', oldVideoPost);
        console.log('ğŸ“ ×ª××•× ×•×ª ×‘×¤×•×¡×˜ ×•×™×“××• ×œ×¤× ×™ ×”×—×œ×¤×”:', oldVideoPost.images);
      }
      
      console.log('âš ï¸ ××—×œ×™×£ allPosts - ×ª××•× ×•×ª ××§×•××™×•×ª ×¢×œ×•×œ×•×ª ×œ×”×™×¢×œ×!');
      
      // ×©××™×¨×ª ×ª××•× ×•×ª ××§×•××™×•×ª ×œ×¤× ×™ ×”×—×œ×¤×”
      const localImages = {};
      allPosts.forEach(oldPost => {
        if (oldPost.images && oldPost.images.length > 0) {
          localImages[oldPost.id] = [...oldPost.images];
        }
      });
      
      allPosts = posts;
      
      // ×”×—×–×¨×ª ×”×ª××•× ×•×ª ×”××§×•××™×•×ª ×œ×¤×•×¡×˜×™× ×©×œ× ×”×•×—×–×¨×• ××”×©×¨×ª
      allPosts.forEach(post => {
        if (localImages[post.id] && (!post.images || post.images.length === 0)) {
          console.log(`ğŸ”§ ××—×–×™×¨ ×ª××•× ×•×ª ××§×•××™×•×ª ×œ×¤×•×¡×˜ ${post.id}:`, localImages[post.id]);
          post.images = localImages[post.id];
        }
      });
      
      // ×‘×“×™×§×” ××—×¨×™ ×”×—×œ×¤×”
      const newVideoPost = allPosts.find(p => p.id == 341);
      if (newVideoPost) {
        console.log('ğŸ¬ ×¤×•×¡×˜ ×•×™×“××• 341 ××—×¨×™ ×”×—×œ×¤×”:', newVideoPost);
        console.log('ğŸ“ ×ª××•× ×•×ª ×‘×¤×•×¡×˜ ×•×™×“××• ××—×¨×™ ×”×—×œ×¤×”:', newVideoPost.images);
      }
      
      renderPosts(posts);
    })
    .catch(err => {
      console.error('Error loading posts:', err);
      allPosts = [];
      renderPosts([]);
    });
}

// ××¦×™×™×¨ ×¤×•×¡×˜×™×

async function renderPosts(posts) {
  const area = document.getElementById("posts-area");
  
  // ×©×œ×‘ 1: ×”×¦×’ ××ª ×›×œ ×”×¤×•×¡×˜×™× ××™×“ ×‘×œ×™ ×œ×—×›×•×ª ×œ×§×™×¦×•×¨ ×§×™×©×•×¨×™×
  let html = '';
  for (const post of posts) {
    const statusIcon = getStatusIcon(post.status || 'active');
    const scheduleInfo = getDetailedScheduleInfo(post);
    // ×”×¦×’ ×ª×—×™×œ×” ××ª ×”×˜×§×¡×˜ ×”××§×•×¨×™ (××”×™×¨)
    let shortText = post.text || '';
    shortText = escapeHtml(shortText.slice(0, 60));
    html += `
      <div class="post-card-collapsed" data-post-id="${post.id}" data-status="${post.status || 'active'}" onclick="openPostCard(${post.id})" style="position:relative;border:1px solid #ddd;margin:10px 0;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.2s;background:#fff;" onmouseover="this.style.background='#f8f9fa'; this.style.borderColor='#0b2743';" onmouseout="this.style.background='#fff'; this.style.borderColor='#ddd';">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:15px;">
          <div style="display:flex;align-items:center;gap:10px;flex:2;min-width:0;">
            ${statusIcon}
            <span class="card-title" style="font-weight:bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(post.title || '×œ×œ× ×›×•×ª×¨×ª')}</span>
          </div>
          <div style="flex:2;min-width:0;padding:0 10px;" id="schedule-info-${post.id}">${scheduleInfo}</div>
          <button class="open-card-btn" onclick="event.stopPropagation(); openPostCard(${post.id})" style="background:#0b2743;color:#fff;border:none;border-radius:5px;padding:6px 12px;font-size:0.85em;white-space:nowrap;transition:background 0.2s;" onmouseover="this.style.background='#1a365d'" onmouseout="this.style.background='#0b2743'">×¢×¨×•×š</button>
        </div>
      </div>
      <div class="post-card-expanded" id="expand-post-${post.id}" style="display:none"></div>
    `;
  }
  
  // ×”×¦×’ ××ª ×”×¤×•×¡×˜×™× ××™×“!
  area.innerHTML = html;
  
  // ××ª×—×œ ×¡×™× ×•× ×™× ××™×“
  setTimeout(() => {
    if (!window.statusFiltersInitialized) {
      initStatusFilters();
      window.statusFiltersInitialized = true;
    }
    applyStatusFilter();
  }, 100);
  
  // ×©×œ×‘ 2: ×¢×›×©×™×• ×¢×‘×•×“ ×¢×œ ×§×™×¦×•×¨ ×”×§×™×©×•×¨×™× ×‘×¨×§×¢ (×œ× ×—×•×¡×)
  setTimeout(async () => {
    console.log('ğŸ”— ××ª×—×™×œ ×§×™×¦×•×¨ ×§×™×©×•×¨×™× ×‘×¨×§×¢...');
    for (const post of posts) {
      try {
        if (post.text) {
          const originalText = post.text;
          const shortenedText = await autoShortenLinks(originalText);
          if (shortenedText !== originalText) {
            // ×¢×“×›×Ÿ ××ª ×”×˜×§×¡×˜ ×‘×¤×•×¡×˜
            post.text = shortenedText;
            console.log(`âœ… ×¢×•×“×›×Ÿ ×§×™×¦×•×¨ ×§×™×©×•×¨×™× ×œ×¤×•×¡×˜ ${post.id}`);
          }
        }
      } catch (error) {
        console.warn(`âš ï¸ ×©×’×™××” ×‘×§×™×¦×•×¨ ×§×™×©×•×¨×™× ×œ×¤×•×¡×˜ ${post.id}:`, error);
      }
    }
    console.log('ğŸ‰ ×¡×™×•× ×§×™×¦×•×¨ ×§×™×©×•×¨×™× ×‘×¨×§×¢');
  }, 200); // ×”×ª×—×œ ××—×¨×™ 200ms
}

// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ××™×™×§×•×Ÿ ×¡×˜×˜×•×¡
function getStatusIcon(status) {
  const icons = {
    active: 'ğŸŸ¢',
    paused: 'â¸ï¸',
    scheduled: 'â°',
    finished: 'âœ…'
  };
  return icons[status] || 'ğŸŸ¢';
}

// ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”×ª×–××•×Ÿ ×œ×ª×¦×•×’×” ×”×¨××©×™×ª
function getDetailedScheduleInfo(post) {
  const publishTime = post.publish_time || '09:00';
  // ×”×¦×’ ×¨×§ ×©×¢×•×ª ×•×“×§×•×ª ×œ×œ× ×©× ×™×•×ª
  const timeFormatted = publishTime.substring(0, 5);
  const timeDisplay = `<span style="background:#f8f9fa;color:#0b2743;padding:2px 6px;border-radius:6px;font-weight:600;font-size:0.8em;border:1px solid #e9ecef;">ğŸ•’ ${timeFormatted}</span>`;
  
  if (!post.status || post.status === 'active') {
    return `<div style="display:flex;align-items:center;justify-content:space-between;width:100%;"><span style="color:#28a745;font-size:0.85em;">×¤×¢×™×œ - ××ª×¤×¨×¡× ×œ×¤×™ ×”×¡×“×¨</span>${timeDisplay}</div>`;
  }
  if (post.status === 'paused') {
    return `<div style="display:flex;align-items:center;justify-content:space-between;width:100%;"><span style="color:#6c757d;font-size:0.85em;">××•×©×‘×ª - ×œ× ××ª×¤×¨×¡×</span>${timeDisplay}</div>`;
  }
  if (post.status === 'finished') {
    return `<div style="display:flex;align-items:center;justify-content:space-between;width:100%;"><span style="color:#dc3545;font-size:0.85em;">×”×¡×ª×™×™×</span>${timeDisplay}</div>`;
  }
  
  if (post.status === 'scheduled') {
    let scheduleText = `<span style="color:#0b2743;font-size:0.85em;">××ª×•×–××Ÿ: `;
    
    if (post.schedule_type === 'weekly') {
      const days = (post.days_of_week || '').split(',').filter(Boolean);
      const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
      if (days.length) {
        scheduleText += '×©×‘×•×¢×™ (' + days.map(d => dayNames[parseInt(d)] || '').join(', ') + ')';
      } else {
        scheduleText += '×©×‘×•×¢×™ (×œ× × ×‘×—×¨×• ×™××™×)';
      }
    } else if (post.schedule_type === 'monthly') {
      if (post.monthly_date) {
        const israeliDate = formatDateToIsraeli(post.monthly_date);
        scheduleText += '×—×•×“×©×™ (×‘-' + israeliDate + ' ×œ×—×•×“×©)';
      } else {
        scheduleText += '×—×•×“×©×™ (×œ× × ×§×‘×¢ ×ª××¨×™×š)';
      }
    } else if (post.schedule_type === 'one-time') {
      if (post.one_time_date) {
        const israeliDate = formatDateToIsraeli(post.one_time_date);
        scheduleText += '×—×“ ×¤×¢××™ (' + israeliDate + ')';
      } else {
        scheduleText += '×—×“ ×¤×¢××™ (×œ× × ×§×‘×¢ ×ª××¨×™×š)';
      }
    }
    
    // ×”×•×¡×£ ×ª××¨×™×›×™ ×”×ª×—×œ×” ×•×¡×™×•× ×× ×§×™×™××™×
    let dateRange = [];
    if (post.start_date) dateRange.push('×-' + post.start_date);
    if (post.end_date) dateRange.push('×¢×“ ' + post.end_date);
    if (dateRange.length > 0) {
      scheduleText += ' [' + dateRange.join(' ') + ']';
    }
    
    scheduleText += `</span>`;
    return `<div style="display:flex;align-items:center;justify-content:space-between;width:100%;">${scheduleText}${timeDisplay}</div>`;
  }
  
  return `<div style="display:flex;align-items:center;justify-content:space-between;width:100%;"><span style="color:#666;font-size:0.85em;">×œ× ××•×’×“×¨</span>${timeDisplay}</div>`;
}

// ×‘×œ×—×™×¦×” â€“ ×˜×•×¢×Ÿ HTML ××œ× ×œ×›×¨×˜×™×¡×™×”, ×¤×•×ª×—, ×•×¡×•×’×¨ ××—×¨×™×
async function openPostCard(postId) {
  const expandDiv = document.getElementById('expand-post-' + postId);

  // ×× ×”×›×¨×˜×™×¡ ×›×‘×¨ ×¤×ª×•×— â€“ ×¡×’×•×¨ ××•×ª×• ×•×ª×—×–×•×¨
  if (expandDiv.style.display === 'block') {
    expandDiv.style.display = 'none';
    return;
  }

  // ×¡×’×•×¨ ××ª ×›×œ ×”×›×¨×˜×™×¡×™×•×ª
  document.querySelectorAll('.post-card-expanded').forEach(el => el.style.display = 'none');

  expandDiv.style.display = 'block';

  // ××¦× ××ª ×”×¤×•×¡×˜ ××ª×•×š allPosts
  const post = allPosts.find(p => p.id == postId);
  if (!post) {
    expandDiv.innerHTML = "×œ× × ××¦× ×¤×•×¡×˜";
    return;
  }

  // ×”×¦×’ ××ª ×”×›×¨×˜×™×¡ ××™×“ ×‘×œ×™ ×œ×—×›×•×ª ×œ×§×™×¦×•×¨ ×§×™×©×•×¨×™×
  expandDiv.innerHTML = buildPostCardHtml(post, collections);
  
  // ×¢×“×›×Ÿ ××ª ×”-dataset ×©×œ ×”×›×¨×˜×™×¡ ×¢× × ×ª×•× ×™ ×”×¤×•×¡×˜
  const postCard = expandDiv.querySelector('.post-card-expanded-inner');
  if (postCard) {
    postCard.dataset.status = post.status || 'active';
    postCard.dataset.schedule_type = post.schedule_type || '';
    postCard.dataset.days_of_week = post.days_of_week || '';
    postCard.dataset.monthly_date = post.monthly_date || '';
    postCard.dataset.one_time_date = post.one_time_date || '';
    postCard.dataset.repeat_mode = post.repeat_mode || 'unlimited';
    postCard.dataset.start_date = post.start_date || '';
    postCard.dataset.end_date = post.end_date || '';
  }
  
  // ×”×¤×¢×œ ××ª ×”××™×¨×•×¢×™× ×©×œ ×”×›×¨×˜×™×¡
  initPostCardEvents(postCard);
  
  // ×¢×›×©×™×• ×¢×‘×•×“ ×¢×œ ×§×™×¦×•×¨ ×§×™×©×•×¨×™× ×‘×¨×§×¢ (×œ× ×—×•×¡×)
  setTimeout(async () => {
    if (post.text) {
      console.log(`ğŸ”— ××ª×—×™×œ ×§×™×¦×•×¨ ×§×™×©×•×¨×™× ×‘×¨×§×¢ ×œ×¤×•×¡×˜ ${postId}...`);
      try {
        const originalText = post.text;
        const shortenedText = await autoShortenLinks(originalText);
        if (shortenedText !== originalText) {
          post.text = shortenedText;
          
          // ×¢×“×›×Ÿ ××ª ×”×ª×¦×•×’×” ×¢× ×”×˜×§×¡×˜ ×”××§×•×¦×¨
          const currentExpandDiv = document.getElementById('expand-post-' + postId);
          if (currentExpandDiv && currentExpandDiv.style.display === 'block') {
            currentExpandDiv.innerHTML = buildPostCardHtml(post, collections);
            // ×”×ª×§×Ÿ ××—×“×© ××ª ×”-dataset
            const updatedPostCard = currentExpandDiv.querySelector('.post-card-expanded-inner');
            if (updatedPostCard) {
              updatedPostCard.dataset.status = post.status || 'active';
              updatedPostCard.dataset.schedule_type = post.schedule_type || '';
              updatedPostCard.dataset.days_of_week = post.days_of_week || '';
              updatedPostCard.dataset.monthly_date = post.monthly_date || '';
              updatedPostCard.dataset.one_time_date = post.one_time_date || '';
              updatedPostCard.dataset.repeat_mode = post.repeat_mode || 'unlimited';
              updatedPostCard.dataset.start_date = post.start_date || '';
              updatedPostCard.dataset.end_date = post.end_date || '';
              
              // ×”×¤×¢×œ ××—×“×© ××ª ×”××™×¨×•×¢×™×
              initPostCardEvents(updatedPostCard);
            }
            console.log(`âœ… ×¢×•×“×›×Ÿ ×§×™×¦×•×¨ ×§×™×©×•×¨×™× ×‘×›×¨×˜×™×¡ ×¤×•×¡×˜ ${postId}`);
          }
        }
      } catch (error) {
        console.warn(`âš ï¸ ×©×’×™××” ×‘×§×™×¦×•×¨ ×§×™×©×•×¨×™× ×œ×¤×•×¡×˜ ${postId}:`, error);
      }
    }
  }, 300); // ×”×ª×—×œ ××—×¨×™ 300ms

  // ×”×ª×× ××•×˜×•××˜×™×ª ××ª ×’×•×‘×” ×”-textarea ×œ×ª×•×›×Ÿ
  setTimeout(() => {
    const textarea = expandDiv.querySelector('.post-textarea');
    if (textarea) {
      autoResizeTextarea(textarea);
    }
  }, 100);
}

function buildPostCardHtml(post, collections) {
  const statusLabels = {
    active: "×¤×¢×™×œ",
    paused: "××•×©×‘×ª",
    scheduled: "××ª×•×–××Ÿ",
    finished: "×”×¡×ª×™×™×"
  };
  const currentStatus = post.status || "active";
  let finishedLabel = '';
  if (post.status === 'finished') {
    finishedLabel = `<span class="finished-label" style="color:#b00;font-weight:bold;margin-right:8px;">(×”×¡×ª×™×™×)</span>`;
  }

  // ×¤×•× ×§×¦×™×” ×©××—×–×™×¨×” ×ª×§×¦×™×¨ ×ª×–××•×Ÿ ×‘×©×•×¨×” ××—×ª
  function getScheduleSummary(post) {
    if (!post.status || post.status === 'active' || post.status === 'paused') return '';
    let parts = [];
    if (post.schedule_type === 'weekly') {
      const days = (post.days_of_week || '').split(',').filter(Boolean);
      const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
      if (days.length) {
        parts.push('×©×‘×•×¢×™ (' + days.map(d => dayNames[parseInt(d)] || '').join(', ') + ')');
      } else {
        parts.push('×©×‘×•×¢×™');
      }
    } else if (post.schedule_type === 'monthly') {
      if (post.monthly_date) {
        const israeliDate = formatDateToIsraeli(post.monthly_date);
        parts.push('×—×•×“×©×™ (' + israeliDate + ')');
      } else {
        parts.push('×—×•×“×©×™');
      }
    } else if (post.schedule_type === 'one-time' && post.one_time_date) {
      const israeliDate = formatDateToIsraeli(post.one_time_date);
      parts.push('×—×“ ×¤×¢××™: ' + israeliDate);
    }
    if (post.start_date) {
      const israeliStartDate = formatDateToIsraeli(post.start_date);
      parts.push('×”×ª×—×œ×”: ' + israeliStartDate);
    }
    if (post.end_date) {
      const israeliEndDate = formatDateToIsraeli(post.end_date);
      parts.push('×¡×™×•×: ' + israeliEndDate);
    }
    return parts.join(' | ');
  }

  const scheduleSummary = getScheduleSummary(post);

  return `
    <div class="post-card-expanded-inner" data-post-id="${post.id}" style="border:1px solid #ddd;padding:20px;border-radius:8px;background:#f9f9f9;">
      <div style="display:flex;align-items:center;gap:18px;margin-bottom:15px;">
        <button type="button" class="post-status-btn" style="background:#e6f0fa;border:none;border-radius:7px;padding:8px 15px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:7px;" title="×œ×—×¥ ×œ×©×™× ×•×™ ×¡×˜×˜×•×¡ ×•×ª×–××•×Ÿ ×”×¤×•×¡×˜">
          ${getStatusIcon(currentStatus)} ×¡×˜×˜×•×¡: <span class="post-status-label">${statusLabels[currentStatus]}</span>
        </button>
        ${scheduleSummary ? `<span style=\"font-size:1em;color:#0b2743;background:#e6f0fa;padding:6px 13px;border-radius:7px;\">${escapeHtml(scheduleSummary)}</span>` : ''}
        ${finishedLabel}
      </div>
      
      <div style="margin-bottom:10px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">×›×•×ª×¨×ª ×”×¤×•×¡×˜:</label>
        <input type="text" class="post-title-input" value="${escapeHtml(post.title || '')}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:5px;" placeholder="×”×›× ×¡ ×›×•×ª×¨×ª ×§×¦×¨×” ×•××¢× ×™×™× ×ª ×œ×¤×•×¡×˜">
      </div>

      <div style="margin-bottom:15px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">×ª×•×›×Ÿ ×”×¤×•×¡×˜:</label>
        <textarea class="post-textarea" style="width:100%;min-height:120px;font-size:1.1em;padding:8px;border:1px solid #ddd;border-radius:5px;resize:vertical;" placeholder="×›×ª×‘ ×›××Ÿ ××ª ×ª×•×›×Ÿ ×”×¤×•×¡×˜...">${escapeHtml(post.text || '')}</textarea>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">×”×¢×œ××ª ×ª××•× ×•×ª ×•×•×™×“××•: <small style="font-weight:normal;color:#666;">× ×™×ª×Ÿ ×œ×‘×—×•×¨ ×ª××•× ×•×ª ×•×•×™×“××• ×‘×•-×–×× ×™×ª. ×”×§×‘×¦×™× ×™×ª×•×•×¡×¤×• ×œ×¤×•×¡×˜ ×•×™×•×¦×’×• ×‘×¨×©×ª×•×ª ×”×—×‘×¨×ª×™×•×ª</small></label>
        <input type="file" class="media-upload" accept="image/*,video/*" multiple style="margin-bottom:10px;">
        <div class="media-preview" style="display:flex;gap:10px;flex-wrap:wrap;">
          ${(post.images || []).map(img => {
            const isVideo = img.match(/\.(mp4|mov|avi|wmv|flv|webm)$/i);
            return `<div style="position:relative;width:90px;height:90px;overflow:hidden;border-radius:13px;background:#fff;box-shadow:0 2px 7px #0b27431a;">
              ${isVideo ? 
                `<video controls style="width:100%;height:100%;object-fit:cover;border-radius:12px;border:1px solid #ccc;display:block;background:#fafafa;" data-path="${img}">
                  <source src="/wp-content/postify-api/${img}" type="video/${img.split('.').pop()}">
                  ×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×ª×’×™×ª ×•×™×“××•.
                </video>` :
                `<img src="/wp-content/postify-api/${img}" data-path="${img}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;border:1px solid #ccc;display:block;background:#fafafa;">`
              }
              <span class="remove-media-btn" style="position:absolute;top:1px;right:1px;background:red;color:white;border-radius:50%;padding:2px 6px;cursor:pointer;font-weight:bold;font-size:12px;">Ã—</span>
            </div>`;
          }).join("")}
        </div>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">×©×¢×ª ×¤×¨×¡×•×: <small style="font-weight:normal;color:#666;">×‘×—×¨ ××ª ×”×©×¢×” ×‘×” ×ª×¨×¦×” ×©×”×¤×•×¡×˜ ×™×ª×¤×¨×¡×</small></label>
        <input type="time" class="publish-time-input" value="${post.publish_time || '09:00'}" style="width:200px;padding:8px;border:1px solid #ddd;border-radius:5px;font-size:1.1em;" title="×‘×—×¨ ×©×¢×ª ×¤×¨×¡×•×">
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">×‘×—×¨ ××•×¡×£ ×§×‘×•×¦×•×ª: <small style="font-weight:normal;color:#666;">××•×¡×£ ×§×‘×•×¦×•×ª ×§×•×‘×¢ ×œ××™×œ×• ×¨×©×ª×•×ª ×—×‘×¨×ª×™×•×ª ×”×¤×•×¡×˜ ×™×ª×¤×¨×¡×</small></label>
        <select class="group-collection-select" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:5px;">
          <option value="">×‘×—×¨ ××•×¡×£ ×§×‘×•×¦×•×ª...</option>
          ${collections.map(c =>
            `<option value="${c.id}" ${post.collection_id == c.id ? "selected" : ""}>${escapeHtml(c.name)}</option>`
          ).join("")}
        </select>
      </div>
      
      <div style="margin-bottom:15px;">

        ${(post.groups || []).map(url =>
          `<label style="display:block;margin-bottom:3px;"><input type="checkbox" name="groups[]" value="${url}" checked> ${escapeHtml(url)}</label>`
        ).join("")}
        ${(post.groups || []).length === 0 ? '' : ''}
      </div>
      
      <span class="save-status" style="display:block;margin-bottom:15px;font-weight:bold;"></span>
      
      <!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×•×ª -->
      <div class="actions-row" style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="save-post-btn" style="background:#28a745;color:#fff;border:none;border-radius:5px;padding:8px 15px;" title="×©××•×¨ ××ª ×›×œ ×”×©×™× ×•×™×™× ×©×‘×™×¦×¢×ª ×‘×¤×•×¡×˜">ğŸ’¾ ×©××•×¨</button>
        <button class="delete-post-btn" style="background:#dc3545;color:#fff;border:none;border-radius:5px;padding:8px 15px;" title="××—×§ ××ª ×”×¤×•×¡×˜ ×œ×¦××™×ª×•×ª (×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨)">ğŸ—‘ï¸ ××—×§</button>
        <button class="clone-post-btn" style="background:#17a2b8;color:#fff;border:none;border-radius:5px;padding:8px 15px;" title="×¦×•×¨ ×¢×•×ª×§ ×–×”×” ×©×œ ×”×¤×•×¡×˜ ×¢× ××•×ª×• ×ª×•×›×Ÿ">ğŸ“„ ×©×›×¤×œ</button>
        <button class="ai-upgrade-btn" style="background:#6f42c1;color:#fff;border:none;border-radius:5px;padding:8px 15px;" title="×©×¤×¨ ××ª ×”×˜×§×¡×˜ ×‘×××¦×¢×•×ª ×‘×™× ×” ××œ××›×•×ª×™×ª">ğŸ¤– ×©×“×¨×’ ×‘×¢×–×¨×ª AI</button>
        <small style="color:#666;margin-right:15px;">×”×©×™× ×•×™×™× × ×©××¨×™× ××•×˜×•××˜×™×ª ×›×©××ª×” ××§×œ×™×“</small>
      </div>
    </div>
  `;
}

// ×¤×•× ×§×¦×™×” ×©××—×–×™×¨×” ×©×“×•×ª ×ª×–××•×Ÿ
function renderScheduleFields(post) {
  if (!post.status || post.status === 'active' || post.status === 'paused') {
    return '';
  }
  
  let html = '<div style="background:#fff;padding:15px;border:1px solid #ddd;border-radius:5px;">';
  html += '<div style="font-weight:bold;margin-bottom:10px;">×”×’×“×¨×•×ª ×ª×–××•×Ÿ:</div>';
  
  if (post.schedule_type === 'weekly') {
    const days = (post.days_of_week || '').split(',').filter(Boolean);
    html += '<div style="margin-bottom:10px;">×™××™× × ×‘×—×¨×™×: ';
    const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
    html += days.map(d => dayNames[parseInt(d)] || '').join(',') || '×œ× × ×‘×—×¨×• ×™××™×';
    html += '</div>';
  }
  
  if (post.schedule_type === 'monthly' && post.monthly_date) {
    const israeliDate = formatDateToIsraeli(post.monthly_date);
    html += `<div style="margin-bottom:10px;">×ª××¨×™×š ×—×•×“×©×™: ${israeliDate}</div>`;
  }
  
  if (post.schedule_type === 'one-time' && post.one_time_date) {
    const israeliDate = formatDateToIsraeli(post.one_time_date);
    html += `<div style="margin-bottom:10px;">×ª××¨×™×š ×—×“ ×¤×¢××™: ${israeliDate}</div>`;
  }
  
  if (post.start_date) {
    const israeliStartDate = formatDateToIsraeli(post.start_date);
    html += `<div style="margin-bottom:5px;">×”×ª×—×œ×”: ${israeliStartDate}</div>`;
  }
  
  if (post.end_date) {
    const israeliEndDate = formatDateToIsraeli(post.end_date);
    html += `<div style="margin-bottom:5px;">×¡×™×•×: ${israeliEndDate}</div>`;
  }
  
  html += '</div>';
  return html;
}

// ×¤×•× ×§×¦×™×” ×©××’× ×” ×¢×œ ×”×›× ×¡×ª ×˜×§×¡×˜ (× ×’×“ XSS)
function escapeHtml(str) {
  if (!str) return '';
  return str.toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// ×¤×•× ×§×¦×™×” ×œ×”×ª×××ª ×’×•×‘×” textarea
function autoResizeTextarea(textarea) {
  textarea.style.height = "auto";
  textarea.style.height = (textarea.scrollHeight + 2) + "px";
}

// ××ª×¤×¢×œ ××ª ×›×œ ×”×”×ª× ×”×’×•×™×•×ª ×©×œ ×›×œ ×›×¨×˜×™×¡ ×¤×•×¡×˜
function initPostCardEvents(card) {
  const statusBtn = card.querySelector('.post-status-btn');
  const statusLabel = card.querySelector('.post-status-label');
  const postId = card.dataset.postId;
  const textarea = card.querySelector(".post-textarea");
  const statusSpan = card.querySelector(".save-status");

  // ×¤×•× ×§×¦×™×” ×œ×”×ª×××ª ×’×•×‘×” textarea ×•×©××™×¨×” ××•×˜×•××˜×™×ª
  if (textarea) {
    autoResizeTextarea(textarea);
    textarea.addEventListener("input", function() {
      autoResizeTextarea(this);
      // ×©××™×¨×” ××•×˜×•××˜×™×ª ××—×¨×™ ×¢×¨×™×›×ª ×˜×§×¡×˜
      clearTimeout(this.saveTimeout);
      this.saveTimeout = setTimeout(() => {
        console.log('×©××™×¨×” ××•×˜×•××˜×™×ª ××—×¨×™ ×¢×¨×™×›×ª ×˜×§×¡×˜...');
        autoSave(postId);
      }, 2000); // ×”××ª×Ÿ 2 ×©× ×™×•×ª ××—×¨×™ ×©×”××©×ª××© ×¡×™×™× ×œ×”×§×œ×™×“
    });
    
    // ×§×™×¦×•×¨ ×§×™×©×•×¨×™× ××•×˜×•××˜×™ ×‘×–××Ÿ ×××ª
    textarea.addEventListener("blur", async function() {
      const originalText = this.value;
      const shortenedText = await autoShortenLinks(originalText);
      if (shortenedText !== originalText) {
        this.value = shortenedText;
        autoResizeTextarea(this);
        // ×©××•×¨ ××ª ×”×©×™× ×•×™
        setTimeout(() => autoSave(postId), 500);
      }
    });
  }

  // ×©××™×¨×” ××•×˜×•××˜×™×ª ×’× ×œ×›×•×ª×¨×ª
  const titleInput = card.querySelector(".post-title-input");
  if (titleInput) {
    titleInput.addEventListener("input", function() {
      // ×©××™×¨×” ××•×˜×•××˜×™×ª ××—×¨×™ ×¢×¨×™×›×ª ×›×•×ª×¨×ª
      clearTimeout(this.saveTimeout);
      this.saveTimeout = setTimeout(() => {
        console.log('×©××™×¨×” ××•×˜×•××˜×™×ª ××—×¨×™ ×¢×¨×™×›×ª ×›×•×ª×¨×ª...');
        autoSave(postId);
      }, 2000);
    });
  }

  // ×©××™×¨×” ××•×˜×•××˜×™×ª ×œ×©×™× ×•×™ ××•×¡×£ ×§×‘×•×¦×•×ª
  const collectionSelect = card.querySelector(".group-collection-select");
  if (collectionSelect) {
    collectionSelect.addEventListener("change", function() {
      console.log('×©××™×¨×” ××•×˜×•××˜×™×ª ××—×¨×™ ×©×™× ×•×™ ××•×¡×£...');
      autoSave(postId);
    });
  }

  // ×©××™×¨×” ××•×˜×•××˜×™×ª ×œ×©×™× ×•×™ ×©×¢×ª ×¤×¨×¡×•×
  const publishTimeInput = card.querySelector(".publish-time-input");
  if (publishTimeInput) {
    publishTimeInput.addEventListener("change", function() {
      console.log('×©××™×¨×” ××•×˜×•××˜×™×ª ××—×¨×™ ×©×™× ×•×™ ×©×¢×ª ×¤×¨×¡×•×...');
      
      // ×•××œ×™×“×¦×™×” ×©×œ ×”×©×¢×”
      const selectedTime = this.value;
      const hour = parseInt(selectedTime.split(':')[0]);
      
      const statusSpan = card.querySelector('.save-status');
      if (statusSpan) {
        if (hour < 6) {
          statusSpan.innerHTML = `âš ï¸ ×©×¢×” ××•×§×“××ª (${selectedTime}) - ××•××œ×¥ ×-06:00`;
          statusSpan.style.color = '#dc3545';
        } else if (hour > 22) {
          statusSpan.innerHTML = `âš ï¸ ×©×¢×” ×××•×—×¨×ª (${selectedTime}) - ××•××œ×¥ ×¢×“ 22:00`;
          statusSpan.style.color = '#dc3545';
        } else {
          statusSpan.innerHTML = `â° ×©×¢×ª ×¤×¨×¡×•× ×¢×•×“×›× ×” ×œ-${selectedTime}`;
          statusSpan.style.color = '#0b2743';
        }
        
        setTimeout(() => {
          statusSpan.innerHTML = '';
        }, 4000);
      }
      
      autoSave(postId);
    });
  }

  // ×¤×•×¤××¤ ×¡×˜×˜×•×¡
  if (statusBtn) {
    statusBtn.onclick = function(e) {
      e.stopPropagation();
      const modal = document.getElementById("status-modal");
      
      // ×”×•×¡×£ ×× ×™××¦×™×” ×—×œ×§×” ×œ×¤×ª×™×—×”
      modal.style.display = "flex";
      modal.classList.add('show');
      
      // ×§×‘×¢ ×¢×¨×š × ×•×›×—×™ ××”×›×¨×˜×™×¡
      const currentStatus = card.dataset.status || 'active';
      
      console.log('×¤×•×ª×— ×¤×•×¤××¤ ×¡×˜×˜×•×¡ ×¢× ×¡×˜×˜×•×¡ × ×•×›×—×™:', currentStatus);
      console.log('× ×ª×•× ×™× ×‘×›×¨×˜×™×¡:', {
        status: card.dataset.status,
        schedule_type: card.dataset.schedule_type,
        days_of_week: card.dataset.days_of_week,
        monthly_date: card.dataset.monthly_date,
        one_time_date: card.dataset.one_time_date
      });
      
      modal.querySelectorAll('input[name="status-choice"]').forEach(r => {
        r.checked = (r.value === currentStatus);
      });
      
      // ×”×¦×’ ××¤×©×¨×•×™×•×ª ×ª×–××•×Ÿ ×× × ×“×¨×©
      const scheduleOptions = modal.querySelector("#schedule-options");
      if (currentStatus === 'scheduled') {
        scheduleOptions.style.display = "block";
        scheduleOptions.classList.add('show');
        const scheduleType = card.dataset.schedule_type || "weekly";
        modal.querySelector("#schedule-type-select").value = scheduleType;
        
        // ××¦× ××ª ×”×¤×•×¡×˜ ×”× ×•×›×—×™ ×‘-allPosts
        const post = allPosts.find(p => p.id == postId) || {};
        
        // ×©×œ×‘ × ×ª×•× ×™× ××”×›×¨×˜×™×¡ ×•××”-allPosts
        const combinedPost = {
          ...post,
          status: card.dataset.status || post.status || 'active',
          schedule_type: card.dataset.schedule_type || post.schedule_type || '',
          days_of_week: card.dataset.days_of_week || post.days_of_week || '',
          monthly_date: card.dataset.monthly_date || post.monthly_date || '',
          one_time_date: card.dataset.one_time_date || post.one_time_date || '',
          repeat_mode: card.dataset.repeat_mode || post.repeat_mode || 'unlimited',
          start_date: card.dataset.start_date || post.start_date || '',
          end_date: card.dataset.end_date || post.end_date || ''
        };
        
        console.log('× ×ª×•× ×™× ××©×•×œ×‘×™× ×œ×ª×¦×•×’×”:', combinedPost);
        showScheduleOptions(scheduleType, combinedPost);
      } else {
        scheduleOptions.classList.remove('show');
        scheduleOptions.style.display = "none";
      }
      
      // ×”×¦×’/×”×¡×ª×¨ ×ª×–××•×Ÿ ×œ×¤×™ ×‘×—×™×¨×”
      modal.querySelectorAll('input[name="status-choice"]').forEach(radio => {
        radio.onchange = function() {
          if (this.value === "scheduled") {
            scheduleOptions.style.display = "block";
            scheduleOptions.classList.add('show');
            const scheduleType = modal.querySelector("#schedule-type-select").value || "weekly";
            
            // ××¦× ××ª ×”×¤×•×¡×˜ ×”× ×•×›×—×™
            const post = allPosts.find(p => p.id == postId) || {};
            const combinedPost = {
              ...post,
              status: card.dataset.status || post.status || 'active',
              schedule_type: card.dataset.schedule_type || post.schedule_type || scheduleType,
              days_of_week: card.dataset.days_of_week || post.days_of_week || '',
              monthly_date: card.dataset.monthly_date || post.monthly_date || '',
              one_time_date: card.dataset.one_time_date || post.one_time_date || '',
              repeat_mode: card.dataset.repeat_mode || post.repeat_mode || 'unlimited',
              start_date: card.dataset.start_date || post.start_date || '',
              end_date: card.dataset.end_date || post.end_date || ''
            };
            
            showScheduleOptions(scheduleType, combinedPost);
          } else {
            scheduleOptions.classList.remove('show');
            setTimeout(() => {
              scheduleOptions.style.display = "none";
            }, 200);
          }
        };
      });

      // ×¡×•×’ ×ª×–××•×Ÿ
      modal.querySelector("#schedule-type-select").onchange = function() {
        const post = allPosts.find(p => p.id == postId) || {};
        const combinedPost = {
          ...post,
          status: card.dataset.status || post.status || 'active',
          schedule_type: this.value,
          days_of_week: card.dataset.days_of_week || post.days_of_week || '',
          monthly_date: card.dataset.monthly_date || post.monthly_date || '',
          one_time_date: card.dataset.one_time_date || post.one_time_date || '',
          repeat_mode: card.dataset.repeat_mode || post.repeat_mode || 'unlimited',
          start_date: card.dataset.start_date || post.start_date || '',
          end_date: card.dataset.end_date || post.end_date || ''
        };
        showScheduleOptions(this.value, combinedPost);
      };

      // ×¡×’×•×¨ ×¢× ×× ×™××¦×™×”
      const closeModal = () => {
        modal.classList.add('hiding');
        modal.classList.remove('show');
        
        setTimeout(() => {
          modal.style.display = "none";
          modal.classList.remove('hiding');
        }, 400);
      };
      
      modal.querySelector("#close-status-modal").onclick = closeModal;
      
      // ××™×©×•×¨
      const applyBtn = modal.querySelector("#status-apply-btn");
      const cancelBtn = modal.querySelector("#status-cancel-btn");
      
      console.log('ğŸ”— ×§×™×©×•×¨ ×›×¤×ª×•×¨×™×:', {
        applyBtn: applyBtn,
        cancelBtn: cancelBtn,
        applyBtnExists: !!applyBtn,
        cancelBtnExists: !!cancelBtn
      });
      
      if (applyBtn) {
        applyBtn.onclick = function() {
          console.log('âœ… ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ××™×©×•×¨');
          saveStatusSettings(modal, card, postId);
        };
      } else {
        console.error('âŒ ×›×¤×ª×•×¨ ××™×©×•×¨ ×œ× × ××¦×!');
      }
      
      // ×‘×™×˜×•×œ ×¢× ×× ×™××¦×™×”
      if (cancelBtn) {
        cancelBtn.onclick = closeModal;
      } else {
        console.error('âŒ ×›×¤×ª×•×¨ ×‘×™×˜×•×œ ×œ× × ××¦×!');
      }
    };
  }

  // ×¤×•× ×§×¦×™×” ×œ×©××™×¨×ª ×”×’×“×¨×•×ª ×¡×˜×˜×•×¡ ×¢× ×‘×“×™×§×ª ×ª××¨×™×›×™×
  function saveStatusSettings(modal, card, postId) {
    const selectedStatus = modal.querySelector('input[name="status-choice"]:checked')?.value || 'active';
    let scheduleData = { status: selectedStatus };
    
    console.log('×©×•××¨ ×”×’×“×¨×•×ª ×¡×˜×˜×•×¡:', selectedStatus, '×œ×¤×•×¡×˜:', postId);
    
    // × ×§×” × ×ª×•× ×™ ×ª×–××•×Ÿ ×§×•×“××™× ×›×“×™ ×œ×× ×•×¢ ×‘×¢×™×•×ª
    if (selectedStatus !== "scheduled") {
      console.log('×× ×§×” × ×ª×•× ×™ ×ª×–××•×Ÿ ×›×™ ×”×¡×˜×˜×•×¡ ××™× ×• ××ª×•×–××Ÿ');
      scheduleData.schedule_type = '';
      scheduleData.days_of_week = '';
      scheduleData.monthly_date = '';
      scheduleData.one_time_date = '';
      scheduleData.repeat_mode = 'unlimited';
      scheduleData.start_date = '';
      scheduleData.end_date = '';
    } else {
      const scheduleType = modal.querySelector("#schedule-type-select").value;
      scheduleData.schedule_type = scheduleType;
      
      console.log('×¡×•×’ ×ª×–××•×Ÿ:', scheduleType);
      
      // ××¡×•×£ × ×ª×•× ×™ ×ª×–××•×Ÿ
      if (scheduleType === "weekly") {
        const daysCheckboxes = modal.querySelectorAll('.weekdays input:checked');
        const days = Array.from(daysCheckboxes).map(ch => parseInt(ch.value));
        console.log('×™××™ ×”×©×‘×•×¢ ×©× ×‘×—×¨×•:', days, '××ª×•×š checkboxes:', daysCheckboxes.length);
        
        // ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×¨×§ ×× × ×‘×—×¨×• ×™××™×
        if (days.length > 0) {
          const startDate = modal.querySelector('.start-date-input')?.value || '';
          const endDate = modal.querySelector('.end-date-input')?.value || '';
          
          console.log('×‘×•×“×§ ×›×¤×™×œ×•×ª ×¢×‘×•×¨ ×™××™×:', days);
          if (!validateWeeklyDaysAvailability(days, postId, startDate, endDate)) {
            console.log('×™××™ ×©×‘×•×¢ × ×“×—×• - ×¢×•×¦×¨ ×©××™×¨×”');
            return; // ×¢×¦×•×¨ ×©××™×¨×”
          }
        } else {
          console.log('×œ× × ×‘×—×¨×• ×™××™× ×‘×©×‘×•×¢ - ×××©×™×š ×¢× ×¨×©×™××” ×¨×™×§×”');
        }
        
        scheduleData.days_of_week = days.join(',');
        scheduleData.monthly_date = '';
        scheduleData.one_time_date = '';
      } else if (scheduleType === "monthly") {
        const monthlyDate = modal.querySelector('.monthly-date-input')?.value || '';
        console.log('×ª××¨×™×š ×—×•×“×©×™ ×©× ×‘×—×¨:', monthlyDate);
        if (monthlyDate) {
          // ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×œ×ª××¨×™×š ×—×•×“×©×™
          if (!validateDateAvailability(monthlyDate, postId, 'monthly')) {
            console.log('×ª××¨×™×š ×—×•×“×©×™ × ×“×—×”');
            return; // ×¢×¦×•×¨ ×©××™×¨×”
          }
        }
        scheduleData.monthly_date = monthlyDate;
        scheduleData.days_of_week = '';
        scheduleData.one_time_date = '';
      } else if (scheduleType === "one-time") {
        const oneTimeDate = modal.querySelector('.one-time-date-input')?.value || '';
        console.log('×ª××¨×™×š ×—×“-×¤×¢××™ ×©× ×‘×—×¨:', oneTimeDate);
        if (oneTimeDate) {
          // ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×œ×ª××¨×™×š ×—×“-×¤×¢××™
          if (!validateDateAvailability(oneTimeDate, postId, 'one-time')) {
            console.log('×ª××¨×™×š ×—×“-×¤×¢××™ × ×“×—×”');
            return; // ×¢×¦×•×¨ ×©××™×¨×”
          }
        }
        scheduleData.one_time_date = oneTimeDate;
        scheduleData.days_of_week = '';
        scheduleData.monthly_date = '';
      }
      
      scheduleData.repeat_mode = modal.querySelector('input[name="repeat-mode"]:checked')?.value || 'unlimited';
      scheduleData.start_date = modal.querySelector('.start-date-input')?.value || '';
      scheduleData.end_date = modal.querySelector('.end-date-input')?.value || '';
    }
    
    console.log('× ×ª×•× ×™ ×ª×–××•×Ÿ ×©×™×™×©××¨×•:', scheduleData);
    
    // ×¢×“×›×Ÿ UI
    const statusLabels = { active: "×¤×¢×™×œ", paused: "××•×©×‘×ª", scheduled: "××ª×•×–××Ÿ", finished: "×”×¡×ª×™×™×" };
    statusLabel.textContent = statusLabels[selectedStatus];
    
    // ×©××•×¨ ×‘-dataset ×©×œ ×”×›×¨×˜×™×¡
    Object.keys(scheduleData).forEach(key => {
      card.dataset[key] = scheduleData[key] || '';
    });
    
    console.log('×¢×“×›×•×Ÿ dataset ×”×›×¨×˜×™×¡:', Object.keys(scheduleData).map(key => `${key}: ${scheduleData[key]}`));
    
    // ×©××•×¨ ×œ×©×¨×ª ×¢× ×¢×“×›×•×Ÿ ×œ×™×™×‘ - ×ª×§×Ÿ ××ª ×”×‘×¢×™×” ×›××Ÿ
    const savePromise = autoSave(postId);
    if (savePromise && typeof savePromise.then === 'function') {
      savePromise.then(() => {
        // ×¢×“×›×•×Ÿ ×œ×™×™×‘ ×©×œ ×›×œ ×”×¤×•×¡×˜×™× ××—×¨×™ ×©×™× ×•×™ ×¡×˜×˜×•×¡
        console.log('×©××™×¨×” ×”×•×©×œ××” ×‘×”×¦×œ×—×” - ××ª×—×™×œ ×¢×“×›×•×Ÿ ×œ×™×™×‘ ××—×¨×™ ×©×™× ×•×™ ×¡×˜×˜×•×¡...');
        setTimeout(() => {
          refreshAllPosts();
        }, 500); // ×”××ª×Ÿ ×—×¦×™ ×©× ×™×™×” ×œ×•×•×“× ×©×”×©××™×¨×” ×”×•×©×œ××”
      }).catch(error => {
        console.error('×©×’×™××” ×‘×©××™×¨×ª ×”×¡×˜×˜×•×¡:', error);
      });
    } else {
      // ×× autoSave ×œ× ×”×—×–×™×¨ promise, ×¤×©×•×˜ ×¨×¢× ×Ÿ ××ª ×”×¤×•×¡×˜×™×
      console.log('autoSave ×œ× ×”×—×–×™×¨ promise, ××¨×¢× ×Ÿ ×™×©×™×¨×•×ª...');
      setTimeout(() => {
        refreshAllPosts();
      }, 500);
    }
    
    // ×¡×’×•×¨ ×¤×•×¤××¤ ×¢× ×× ×™××¦×™×” ×—×œ×§×”
    modal.classList.add('hiding');
    modal.classList.remove('show');
    
    setTimeout(() => {
      modal.style.display = "none";
      modal.classList.remove('hiding');
    }, 400);
    console.log('×¡×’×™×¨×ª modal ×•×”×©×œ××ª ×©××™×¨×ª ×¡×˜×˜×•×¡');
  }

  // ×¤×•× ×§×¦×™×” ×©××¦×™×’×” ×©×“×•×ª ×ª×–××•×Ÿ - ×”×ª×™×§×•×Ÿ ×”×¨××©×™ ×›××Ÿ!
  function showScheduleOptions(type, post) {
    const fields = document.getElementById("schedule-fields");
    let html = "";

    // ×•×“× ×©×™×© ×œ× ×• ×¢×¨×›×™× ×ª×§×™× ×™×
    const days = (post?.days_of_week || '').split(',').filter(Boolean);
    const repeatMode = post?.repeat_mode || 'unlimited';
    const startDate = post?.start_date || '';
    const endDate = post?.end_date || '';
    const monthlyDate = post?.monthly_date || '';
    const oneTimeDate = post?.one_time_date ? normalizeDate(post.one_time_date) : '';
    const normalizedStartDate = startDate ? normalizeDate(startDate) : '';
    const normalizedEndDate = endDate ? normalizeDate(endDate) : '';
    const normalizedMonthlyDate = monthlyDate ? normalizeDate(monthlyDate) : '';

    console.log('showScheduleOptions × ×§×¨× ×¢×:', {
      type,
      post: post?.id,
      days,
      repeatMode,
      startDate: normalizedStartDate,
      endDate: normalizedEndDate,
      monthlyDate: normalizedMonthlyDate,
      oneTimeDate
    });

    // ×¢×‘×•×¨ ×©×‘×•×¢×™ - ××¦×™×’×™× ×‘×—×™×¨×ª ×™××™× (×œ×œ× ×©×‘×ª)
    if (type === "weekly") {
      html += `<div style="margin-bottom:10px;padding:10px;background:#fff3cd;border-radius:5px;color:#856404;">
        <strong>×¤×¨×¡×•× ×©×‘×•×¢×™:</strong> ×”×¤×•×¡×˜ ×™×ª×¤×¨×¡× ×‘×™××™× ×©×ª×‘×—×¨ ×‘×›×œ ×©×‘×•×¢
        <br><small>×œ×“×•×’××”: ×× ×ª×‘×—×¨ "×©× ×™" ×•"×¨×‘×™×¢×™", ×”×¤×•×¡×˜ ×™×ª×¤×¨×¡× ×›×œ ×™×•× ×©× ×™ ×•×¨×‘×™×¢×™</small>
      </div>`;
      html += `<div style="margin-bottom:10px;">
        <div style="font-weight:bold;margin-bottom:5px;">×‘×—×¨ ×™××™× ×‘×©×‘×•×¢:</div>
        <div class="weekdays">
          ${['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™'].map((d,i) =>
            `<label style="margin-left:10px;"><input type="checkbox" value="${i}" ${days.includes(String(i)) ? 'checked' : ''} onchange="validateWeeklySelection(this, ${postId})"> ${d}</label>`
          ).join('')}
        </div>
        <small style="color:#666;">× ×™×ª×Ÿ ×œ×‘×—×•×¨ ××¡×¤×¨ ×™××™×. ×”×¤×•×¡×˜ ×™×ª×¤×¨×¡× ×‘×›×œ ×”×™××™× ×©×ª×‘×—×¨</small>
      </div>`;
    }

    // ×ª×–××•×Ÿ ×—×•×“×©×™
    if (type === "monthly") {
      html += `<div style="margin-bottom:10px;padding:10px;background:#d1ecf1;border-radius:5px;color:#0c5460;">
        <strong>×¤×¨×¡×•× ×—×•×“×©×™:</strong> ×”×¤×•×¡×˜ ×™×ª×¤×¨×¡× ×‘××•×ª×• ×ª××¨×™×š ×‘×›×œ ×—×•×“×©
        <br><small>×œ×“×•×’××”: ×× ×ª×‘×—×¨ 15/07/2025, ×”×¤×•×¡×˜ ×™×ª×¤×¨×¡× ×‘-15 ×©×œ ×›×œ ×—×•×“×©</small>
      </div>`;
      html += `<div style="margin-bottom:10px;">
        <label>×‘×—×¨ ×ª××¨×™×š ×œ×—×–×¨×” ×—×•×“×©×™×ª: 
          <input type="date" class="monthly-date-input" value="${normalizedMonthlyDate}" style="margin-right:5px;">
        </label>
        <br><small style="color:#666;">×¨×§ ×”×™×•× ×‘×—×•×“×© ×™×§×‘×¢ ××ª ×”×ª×–××•×Ÿ (×œ× ×”×—×•×“×© ×•×”×©× ×”)</small>
      </div>`;
    }

    // ×ª×–××•×Ÿ ×—×“ ×¤×¢××™
    if (type === "one-time") {
      html += `<div style="margin-bottom:10px;padding:10px;background:#f8d7da;border-radius:5px;color:#721c24;">
        <strong>×¤×¨×¡×•× ×—×“ ×¤×¢××™:</strong> ×”×¤×•×¡×˜ ×™×ª×¤×¨×¡× ×¨×§ ×¤×¢× ××—×ª ×‘×ª××¨×™×š ×©×ª×‘×—×¨
        <br><small>×œ××—×¨ ×”×¤×¨×¡×•×, ×”×¤×•×¡×˜ ×™×¢×‘×•×¨ ××•×˜×•××˜×™×ª ×œ×¡×˜×˜×•×¡ "×”×¡×ª×™×™×"</small>
      </div>`;
      html += `<div style="margin-bottom:10px;">
        <label>×ª××¨×™×š ×œ×¤×¨×¡×•× ×—×“ ×¤×¢××™: 
          <input type="date" class="one-time-date-input" value="${oneTimeDate}" style="margin-right:5px;">
        </label>
        <br><small style="color:#666;">×‘×—×¨ ××ª ×”×ª××¨×™×š ×”××“×•×™×§ ×‘×• ×ª×¨×¦×” ×©×”×¤×•×¡×˜ ×™×ª×¤×¨×¡×</small>
      </div>`;
    }

    // ×—×–×¨×•×ª (×œ× ×‘×—×“ ×¤×¢××™)
    if (type !== "one-time") {
      html += `
        <div style="margin-bottom:10px;">
          <div style="font-weight:bold;margin-bottom:5px;">×”×’×“×¨×•×ª ×ª×§×•×¤×ª ×¤×¨×¡×•×:</div>
          <label style="display:block;margin-bottom:5px;">
            <input type="radio" name="repeat-mode" value="unlimited" ${repeatMode === 'unlimited' ? 'checked' : ''}> ×œ×œ× ×”×’×‘×œ×ª ×–××Ÿ
            <div style="font-size:0.85em;color:#666;margin-right:20px;">×”×¤×•×¡×˜ ×™×ª×¤×¨×¡× ×œ×¤×™ ×”×ª×–××•×Ÿ ×œ×œ× ×”×’×‘×œ×ª ×–××Ÿ</div>
          </label>
          <label style="display:block;margin-bottom:5px;">
            <input type="radio" name="repeat-mode" value="until-date" ${repeatMode === 'until-date' ? 'checked' : ''}> ×¢×“ ×ª××¨×™×š ××•×’×“×¨
            <div style="font-size:0.85em;color:#666;margin-right:20px;">×”×¤×•×¡×˜ ×™×ª×¤×¨×¡× ×¨×§ ×¢×“ ×ª××¨×™×š ×©×ª×§×‘×¢</div>
          </label>
          <div class="repeat-dates-area" style="margin-top:10px;"></div>
        </div>
      `;
    }

    fields.innerHTML = html;

    // ×”×¦×’×ª ×©×“×•×ª ×ª××¨×™×›×™×
    if (type !== "one-time") {
      renderRepeatDatesArea(type, normalizedStartDate, normalizedEndDate);
      
      // ×××–×™×Ÿ ×œ×©×™× ×•×™ ×‘×—×–×¨×•×ª
      fields.querySelectorAll('input[name="repeat-mode"]').forEach(radio => {
        radio.onchange = () => renderRepeatDatesArea(type, normalizedStartDate, normalizedEndDate);
      });
    }

    // ×”×¤×¢×œ Flatpickr ×¢×œ ×©×“×•×ª ×”×ª××¨×™×š ×”×—×“×©×™×
    setTimeout(enableFlatpickrOnDates, 100);
  }

  function renderRepeatDatesArea(type, startDate, endDate) {
    const area = document.getElementById("schedule-fields").querySelector('.repeat-dates-area');
    if (!area) return;
    
    const selected = document.querySelector('input[name="repeat-mode"]:checked')?.value || 'unlimited';
    
    // × ×•×¨××œ×™×–×¦×™×” ×©×œ ×ª××¨×™×›×™×
    const normalizedStartDate = startDate ? normalizeDate(startDate) : '';
    const normalizedEndDate = endDate ? normalizeDate(endDate) : '';
    
    if (selected === 'unlimited') {
      if (type === "monthly") {
        area.innerHTML = '<small style="color:#666;">×”×¤×•×¡×˜ ×™×ª×¤×¨×¡× ×‘×›×œ ×—×•×“×© ×œ×œ× ×”×’×‘×œ×ª ×–××Ÿ</small>';
      } else {
        area.innerHTML = `<label>×ª××¨×™×š ×”×ª×—×œ×”: <input type="date" class="start-date-input" value="${normalizedStartDate}"></label>
        <br><small style="color:#666;">××ª×™ ×œ×”×ª×—×™×œ ××ª ×”×¤×¨×¡×•× ×”×©×‘×•×¢×™ (×× ×¨×™×§ - ×™×ª×—×™×œ ××™×“)</small>`;
      }
    } else {
      if (type === "monthly") {
        area.innerHTML = `<label>×ª××¨×™×š ×¡×™×•×: <input type="date" class="end-date-input" value="${normalizedEndDate}"></label>
        <br><small style="color:#666;">×¢×“ ××ª×™ ×œ×”××©×™×š ××ª ×”×¤×¨×¡×•× ×”×—×•×“×©×™</small>`;
      } else {
        area.innerHTML = `
          <label style="display:block;margin-bottom:5px;">×ª××¨×™×š ×”×ª×—×œ×”: <input type="date" class="start-date-input" value="${normalizedStartDate}"></label>
          <small style="color:#666;display:block;margin-bottom:8px;">××ª×™ ×œ×”×ª×—×™×œ ××ª ×”×¤×¨×¡×•× ×”×©×‘×•×¢×™</small>
          <label>×ª××¨×™×š ×¡×™×•×: <input type="date" class="end-date-input" value="${normalizedEndDate}"></label>
          <small style="color:#666;">×¢×“ ××ª×™ ×œ×”××©×™×š ××ª ×”×¤×¨×¡×•× ×”×©×‘×•×¢×™</small>
        `;
      }
    }
    
    // ×”×¤×¢×œ Flatpickr ×¢×œ ×©×“×•×ª ×—×“×©×™×
    setTimeout(enableFlatpickrOnDates, 100);
  }

  // ×¤×•× ×§×¦×™×” ×œ×©××™×¨×ª ×¤×•×¡×˜ ×¢× ×‘×“×™×§×ª ×ª××¨×™×›×™× ×•×¢×“×›×•×Ÿ ×œ×™×™×‘
  function savePostWithValidation(postId) {
    const postCard = document.querySelector(`.post-card-expanded-inner[data-post-id="${postId}"]`);
    if (!postCard) {
      console.error('×œ× × ××¦× ×¤×•×¡×˜ ×¢× ID:', postId);
      return Promise.reject('×¤×•×¡×˜ ×œ× × ××¦×');
    }
    
    // ×‘×“×™×§×ª ×ª××¨×™×›×™× ×¢×œ ×‘×¡×™×¡ ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™× ×‘×›×¨×˜×™×¡
    const currentStatus = postCard.dataset.status || 'active';
    const currentScheduleType = postCard.dataset.schedule_type || '';
    
    if (currentStatus === 'scheduled') {
      if (currentScheduleType === 'one-time') {
        const oneTimeDate = postCard.dataset.one_time_date || '';
        if (oneTimeDate) {
          const normalizedDate = normalizeDate(oneTimeDate);
          if (normalizedDate && !validateDateAvailability(normalizedDate, postId, 'one-time')) {
            showDateErrorMessage(`×”×ª××¨×™×š ${oneTimeDate} ×›×‘×¨ ×ª×¤×•×¡ ×¢×œ ×™×“×™ ×¤×•×¡×˜ ××—×¨!`);
            return Promise.reject('×ª××¨×™×š ×ª×¤×•×¡');
          }
        }
      }
      
      if (currentScheduleType === 'monthly') {
        const monthlyDate = postCard.dataset.monthly_date || '';
        if (monthlyDate) {
          const normalizedDate = normalizeDate(monthlyDate);
          if (normalizedDate && !validateDateAvailability(normalizedDate, postId, 'monthly')) {
            showDateErrorMessage(`×”×ª××¨×™×š ×”×—×•×“×©×™ ${monthlyDate} ×›×‘×¨ ×ª×¤×•×¡ ×¢×œ ×™×“×™ ×¤×•×¡×˜ ××—×¨!`);
            return Promise.reject('×ª××¨×™×š ×ª×¤×•×¡');
          }
        }
      }
    }
    
    // ×©××™×¨×” ×™×©×™×¨×”
    return savePostDirectly(postId, postCard).then(() => {
      // ×¢×“×›×•×Ÿ ×œ×™×™×‘ ×©×œ ×›×œ ×”×¤×•×¡×˜×™× ××—×¨×™ ×©××™×¨×” ××•×¦×œ×—×ª
      console.log('×©××™×¨×” ×”×•×©×œ××” ×‘×”×¦×œ×—×”, ××ª×—×™×œ ×¢×“×›×•×Ÿ ×œ×™×™×‘...');
      setTimeout(() => {
        refreshAllPosts();
      }, 300);
    }).catch(error => {
      console.error('×©×’×™××” ×‘×©××™×¨×ª ×”×¤×•×¡×˜:', error);
      throw error;
    });
  }
  
  // ×¤×•× ×§×¦×™×” ×œ×©××™×¨×” ×™×©×™×¨×” ×©×œ ×¤×•×¡×˜
  function savePostDirectly(postId, postCard) {
    const statusSpan = postCard.querySelector('.save-status');
    if (statusSpan) statusSpan.textContent = "ğŸ•“ ×©×•××¨...";
    
    const title = postCard.querySelector(".post-title-input").value;
    const text = postCard.querySelector(".post-textarea").value;
    const collectionId = postCard.querySelector(".group-collection-select").value;
    const publishTime = postCard.querySelector(".publish-time-input").value || '09:00';
    const images = Array.from(postCard.querySelectorAll(".media-preview img, .media-preview video")).map(el => el.dataset.path);
    const groups = Array.from(postCard.querySelectorAll('input[name="groups[]"]:checked')).map(input => input.value);

    console.log('ğŸ” ×©××™×¨×ª ×¤×•×¡×˜ ×™×©×™×¨×” - ××“×™×” ×©× ××¦×:', images);

    // ×¤×•× ×§×¦×™×” ×œ×”××¨×ª ×ª××¨×™×š ×-d/m/Y ×œ-YYYY-MM-DD
    function toMysqlDate(val) {
      if (!val) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
      const parts = val.split('/');
      if (parts.length === 3) {
        const [d, m, y] = parts;
        if (y && m && d) return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
      }
      return val;
    }

    const formData = new FormData();
    formData.append("id", postId);
    formData.append("title", title);
    formData.append("text", text);
    formData.append("collection_id", collectionId);
    formData.append("publish_time", publishTime);
    formData.append("hostname", hostname);
    images.forEach(img => formData.append("images[]", img));
    groups.forEach(group => formData.append("groups[]", group));
    
    // ×”×•×¡×£ ×©×“×•×ª ×¡×˜×˜×•×¡ ×•×ª×–××•×Ÿ
    formData.append("status", postCard.dataset.status || 'active');
    // ×©×œ×— schedule_type ×¨×§ ×× ×™×© ×¢×¨×š ×—×•×§×™ ××• ×‘×¨×™×¨×ª ××—×“×œ
    const validScheduleTypes = ['weekly','monthly','one-time'];
    let scheduleType = postCard.dataset.schedule_type;
    if (postCard.dataset.status === 'scheduled' && validScheduleTypes.includes(scheduleType)) {
      formData.append("schedule_type", scheduleType);
    } else if (postCard.dataset.status === 'scheduled') {
      formData.append("schedule_type", 'weekly'); // ×‘×¨×™×¨×ª ××—×“×œ
    }
    formData.append("days_of_week", postCard.dataset.days_of_week || '');
    formData.append("days_of_month", postCard.dataset.days_of_month || '');
    // ×”××¨×ª ×ª××¨×™×›×™× ×œ×¤×•×¨××˜ MySQL
    if (postCard.dataset.one_time_date) formData.append("one_time_date", toMysqlDate(postCard.dataset.one_time_date));
    if (postCard.dataset.monthly_date) formData.append("monthly_date", toMysqlDate(postCard.dataset.monthly_date));
    formData.append("repeat_mode", postCard.dataset.repeat_mode || 'unlimited');
    if (postCard.dataset.start_date) formData.append("start_date", toMysqlDate(postCard.dataset.start_date));
    if (postCard.dataset.end_date) formData.append("end_date", toMysqlDate(postCard.dataset.end_date));
    
    console.log('Saving post data (savePostDirectly):');
    for (let pair of formData.entries()) {
      console.log(pair[0] + ': ' + pair[1]);
    }

    return fetch("/wp-content/postify-api/update-post.php", { method: "POST", body: formData })
      .then(res => res.json())
      .then(data => {
        console.log('Server response (savePostDirectly):', data);
        if (data.success) {
          if (statusSpan) statusSpan.textContent = "âœ… × ×©××¨";
          
          // ×¢×“×›×Ÿ ××ª allPosts
          const post = allPosts.find(p => p.id == postId);
          if (post) {
            post.title = title;
            post.text = text;
            post.collection_id = collectionId;
            post.publish_time = publishTime; // âœ… ×”×•×¡×£ ×©×¢×ª ×¤×¨×¡×•×
            post.images = images;
            post.status = postCard.dataset.status || 'active';
            post.schedule_type = postCard.dataset.schedule_type || '';
            post.days_of_week = postCard.dataset.days_of_week || '';
            post.days_of_month = postCard.dataset.days_of_month || '';
            post.one_time_date = postCard.dataset.one_time_date || '';
            post.monthly_date = postCard.dataset.monthly_date || '';
            post.repeat_mode = postCard.dataset.repeat_mode || 'unlimited';
            post.start_date = postCard.dataset.start_date || '';
            post.end_date = postCard.dataset.end_date || '';
          }
          
          // ×¢×“×›×Ÿ ×ª×–××•×Ÿ Google Cloud ××—×¨×™ ×©××™×¨×” ××•×¦×œ×—×ª
          updateScheduleAfterTimeChange(postId);
          
          if (statusSpan) setTimeout(() => statusSpan.textContent = '', 3000);
          return data;
        } else {
          if (statusSpan) statusSpan.textContent = "âŒ ×©×’×™××”: " + (data.message || data.error || '×œ× ×™×“×•×¢');
          console.error('Save failed:', data);
          if (statusSpan) setTimeout(() => statusSpan.textContent = '', 3000);
          throw new Error(data.message || data.error || '×œ× ×™×“×•×¢');
        }
      })
      .catch(err => {
        console.error('Save error:', err);
        if (statusSpan) statusSpan.textContent = "âŒ ×©×’×™××” ×‘×©××™×¨×”";
        if (statusSpan) setTimeout(() => statusSpan.textContent = '', 3000);
        throw err;
      });
  }
  
  // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×œ×™×™×‘ ×©×œ ×›×œ ×”×¤×•×¡×˜×™×
  function refreshAllPosts() {
    console.log('××¢×“×›×Ÿ ××ª ×›×œ ×”×¤×•×¡×˜×™×...');
    
    // ×¨×¢× ×Ÿ ××ª allPosts ××”×©×¨×ª ×‘×××¦×¢×•×ª ×”-API ×”×§×™×™×
    fetch('/wp-content/postify-api/posts-data.php?hostname=' + encodeURIComponent(hostname))
      .then(response => response.json())
      .then(posts => {
        console.log('Posts refreshed from API:', posts);
        allPosts = posts;
        
        // ×¢×“×›×Ÿ ××ª ×ª×¦×•×’×ª ×”×¤×•×¡×˜×™×
        renderPosts(posts);
        
        // ×”×¤×¢×œ ××—×“×© ××ª Flatpickr ×¢×œ ×›×œ ×”×©×“×•×ª
        setTimeout(() => {
          refreshFlatpickrForAllPosts();
        }, 200);
        
        console.log('×”×¤×•×¡×˜×™× ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”');
      })
      .catch(error => {
        console.error('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¤×•×¡×˜×™×:', error);
      });
  }

  // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™ ×”×©××™×¨×” ×œ×©×™××•×© ×‘×¤×•× ×§×¦×™×” ×”××××ª×ª
  function updateSaveButtons() {
    const saveButtons = document.querySelectorAll('button[onclick*="savePost"]');
    
    saveButtons.forEach(button => {
      const onclickValue = button.getAttribute('onclick');
      if (onclickValue && onclickValue.includes('savePost(')) {
        const postIdMatch = onclickValue.match(/savePost\((\d+)\)/);
        if (postIdMatch) {
          const postId = postIdMatch[1];
          button.setAttribute('onclick', `savePostWithValidation(${postId})`);
        }
      }
    });
  }

  // ×”×¤×¢×œ ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™× ××“×™ ×¤×¢×
  setInterval(updateSaveButtons, 2000);

  // ×”×¢×œ××ª ××“×™×” (×ª××•× ×•×ª ×•×•×™×“××•)
  card.querySelector(".media-upload")?.addEventListener("change", function() {
    const files = Array.from(this.files);
    if (!files.length) return;
    
    files.forEach(file => {
      console.log('ğŸ“¤ Uploading file:', file.name, 'Type:', file.type);
      const fd = new FormData();
      fd.append("image", file); // ×”×©×¨×ª ××§×‘×œ ×’× ×•×™×“××• ×ª×—×ª ×”×©× "image"
      fetch("/wp-content/postify-api/upload-image.php", { method: "POST", body: fd })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const post = allPosts.find(p => p.id == postId);
            if (post) {
              post.images = post.images || [];
              post.images.push(data.path);
              console.log('ğŸ¬ ××“×™×” × ×•×¡×£ ×œ×¤×•×¡×˜', postId, '- ×ª××•× ×•×ª ×›×¢×ª:', post.images);
            }
            const wrapper = document.createElement("div");
            wrapper.style.cssText = "position:relative;width:90px;height:90px;overflow:hidden;border-radius:13px;background:#fff;box-shadow:0 2px 7px #0b27431a;";
            const isVideo = data.path.match(/\.(mp4|mov|avi|wmv|flv|webm)$/i);
            wrapper.innerHTML = `
              ${isVideo ? 
                `<video controls style="width:100%;height:100%;object-fit:cover;border-radius:12px;border:1px solid #ccc;display:block;background:#fafafa;" data-path="${data.path}">
                  <source src="/wp-content/postify-api/${data.path}" type="video/${data.path.split('.').pop()}">
                  ×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×ª×’×™×ª ×•×™×“××•.
                </video>` :
                `<img src="/wp-content/postify-api/${data.path}" data-path="${data.path}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;border:1px solid #ccc;display:block;background:#fafafa;">`
              }
              <span class="remove-btn" style="position:absolute;top:1px;right:1px;background:red;color:white;border-radius:50%;padding:2px 6px;cursor:pointer;font-weight:bold;font-size:12px;">Ã—</span>
            `;
            card.querySelector(".media-preview").appendChild(wrapper);
            wrapper.querySelector(".remove-btn").onclick = function() {
              if (post) {
                post.images = post.images.filter(img => img !== data.path);
              }
              // ××—×™×§×ª ×§×•×‘×¥ ××”×©×¨×ª
              fetch('/wp-content/postify-api/delete-image.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'path=' + encodeURIComponent(data.path)
              });
              wrapper.remove();
              autoSave(postId);
            };
            // âš¡ ×©××•×¨ ××™×™×“×™×ª ××—×¨×™ ×”×¢×œ××” ×›×“×™ ×œ×•×•×“× ×©×”××“×™×” × ×©××¨ ×‘×©×¨×ª
            console.log('ğŸ’¾ ×©×•××¨ ××“×™×” ××™×™×“×™×ª ×‘×©×¨×ª...');
            autoSave(postId).then(() => {
              console.log('âœ… ××“×™×” × ×©××¨ ×‘×©×¨×ª ×‘×”×¦×œ×—×”');
            }).catch(err => {
              console.error('âŒ ×©×’×™××” ×‘×©××™×¨×ª ××“×™×”:', err);
            });
          } else {
            // ×”×¦×’×ª ×”×•×“×¢×ª ×©×’×™××” ×œ××©×ª××©
            showUploadError(data.error || '×©×’×™××” ×‘×”×¢×œ××ª ×§×•×‘×¥');
          }
        })
        .catch(err => {
          showUploadError('×©×’×™××” ×›×œ×œ×™×ª ×‘×”×¢×œ××ª ×§×•×‘×¥');
          console.error('Upload error:', err);
        });

      // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×•×“×¢×ª ×©×’×™××” ×‘×•×œ×˜×ª
      function showUploadError(msg) {
        // ×”×¡×¨ ×”×•×“×¢×” ×§×•×“××ª ×× ×§×™×™××ª
        let old = document.getElementById('upload-error-msg');
        if (old) old.remove();
        const div = document.createElement('div');
        div.id = 'upload-error-msg';
        div.textContent = msg;
        div.style.cssText = 'position:fixed;top:30px;right:30px;z-index:9999;background:#dc3545;color:#fff;padding:15px 25px;border-radius:8px;font-weight:bold;box-shadow:0 4px 12px rgba(220,53,69,0.3);max-width:400px;white-space:pre-line;line-height:1.4;';
        document.body.appendChild(div);
        setTimeout(() => { if (div.parentNode) div.parentNode.removeChild(div); }, 6000);
      }
    });
    this.value = "";
  });

  // ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×•×ª
  card.querySelector(".save-post-btn")?.addEventListener('click', function() {
    // ×©×™××•×© ×‘×¤×•× ×§×¦×™×” ×¢× ×‘×“×™×§×ª ×ª××¨×™×›×™× ×•×¢×“×›×•×Ÿ ×œ×™×™×‘
    savePostWithValidation(postId);
  });

  card.querySelector(".delete-post-btn")?.addEventListener('click', function() {
    if (!confirm("×”×× ×œ××—×•×§ ××ª ×”×¤×•×¡×˜?")) return;
    // ××—×™×§×ª ×›×œ ×§×‘×¦×™ ×”××“×™×” ×©×œ ×”×¤×•×¡×˜ ××”×©×¨×ª (××¡×™× ×›×¨×•× ×™)
    const post = allPosts.find(p => p.id == postId);
    let deleteMediaPromise = Promise.resolve();
    if (post && post.images && post.images.length > 0) {
      const deletePromises = post.images.map(path =>
        fetch('/wp-content/postify-api/delete-image.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'path=' + encodeURIComponent(path)
        })
      );
      deleteMediaPromise = Promise.all(deletePromises);
    }
    deleteMediaPromise.then(() => {
      const fd = new FormData();
      fd.append("id", postId);
      fetch("/wp-content/postify-api/delete-post.php", { method: "POST", body: fd })
        .then(() => {
          const expandedCard = card.closest('.post-card-expanded');
          if (expandedCard) expandedCard.remove();
          const collapsedCard = document.querySelector(`.post-card-collapsed[data-post-id="${postId}"]`);
          if (collapsedCard) collapsedCard.remove();
          allPosts = allPosts.filter(p => p.id != postId);
        })
        .catch(err => console.error('Delete error:', err));
    });
  });

  card.querySelector(".clone-post-btn")?.addEventListener('click', function() {
    const fd = new FormData();
    fd.append("id", postId);
    fetch("/wp-content/postify-api/clone-post.php", { method: "POST", body: fd })
      .then(res => res.json())
      .then(() => loadPostsFromDB())
      .catch(err => console.error('Clone error:', err));
  });

  // AI upgrade
  card.querySelector(".ai-upgrade-btn")?.addEventListener("click", async function(e) {
    e.stopPropagation();
    const modal = document.getElementById("ai-upgrade-modal");
    modal.style.display = "flex";
    const modalContent = modal.querySelector("#ai-modal-content");
    const beforeAfterBtn = modal.querySelector("#ai-before-after-btn");
    
    modalContent.innerHTML = "â³ ××©×“×¨×’ ×˜×§×¡×˜...";
    beforeAfterBtn.style.display = "none";

    try {
      const formData = new FormData();
      formData.append("text", textarea.value);
      const res = await fetch("/wp-content/postify-api/ai-upgrade.php", { method: "POST", body: formData });
      const data = await res.json();

      const originalText = textarea.value;
      const upgradedText = data.upgraded || "âŒ ×©×’×™××” ×‘×©×“×¨×•×’";

      let showingOriginal = false;
      modalContent.innerHTML = formatAIText(upgradedText);
      beforeAfterBtn.style.display = "inline-block";
      beforeAfterBtn.textContent = "×œ×¤× ×™-××—×¨×™";

      beforeAfterBtn.onclick = function() {
        showingOriginal = !showingOriginal;
        modalContent.innerHTML = formatAIText(showingOriginal ? originalText : upgradedText);
        beforeAfterBtn.textContent = showingOriginal ? "×”×¦×’ ××—×¨×™" : "×œ×¤× ×™-××—×¨×™";
      };

      modal.querySelector("#ai-upgrade-cancel").onclick = () => { modal.style.display = "none"; };
      modal.querySelector("#ai-upgrade-apply").onclick = () => {
        if (upgradedText && upgradedText !== "âŒ ×©×’×™××” ×‘×©×“×¨×•×’") {
          textarea.value = upgradedText;
          modal.style.display = "none";
          textarea.dispatchEvent(new Event("input"));
          autoResizeTextarea(textarea);
        } else {
          modal.style.display = "none";
        }
      };
      
    } catch (e) {
      console.error('AI upgrade error:', e);
      modalContent.innerHTML = "âŒ ×©×’×™××” ×‘×©×“×¨×•×’";
    }
  });

  // ××—×™×§×ª ××“×™×” ×§×™×™××ª
  card.querySelectorAll(".remove-media-btn").forEach(btn => {
    btn.onclick = function() {
      const mediaElement = this.parentElement.querySelector('img, video');
      const mediaPath = mediaElement.dataset.path;
      const post = allPosts.find(p => p.id == postId);
      if (post) {
        post.images = post.images.filter(img => img !== mediaPath);
      }
      // ××—×™×§×ª ×§×•×‘×¥ ××”×©×¨×ª
      fetch('/wp-content/postify-api/delete-image.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'path=' + encodeURIComponent(mediaPath)
      });
      this.parentElement.remove();
      autoSave(postId);
    };
  });
}

// ×¤×•× ×§×¦×™×™×ª ×©××™×¨×” ××•×˜×•××˜×™×ª ×’×œ×•×‘×œ×™×ª
function autoSave(postId) {
  console.log('autoSave × ×§×¨××” ×¢× postId:', postId);
  
  // ××¦× ××ª ×”×›×¨×˜×™×¡
  const card = document.querySelector(`.post-card-expanded-inner[data-post-id="${postId}"]`);
  if (!card) {
    console.error('×œ× × ××¦× ×›×¨×˜×™×¡ ×¢× postId:', postId);
    return Promise.reject('×œ× × ××¦× ×›×¨×˜×™×¡');
  }
  
  const statusSpan = card.querySelector('.save-status');
  if (statusSpan) statusSpan.textContent = "ğŸ•“ ×©×•××¨...";
  
  const title = card.querySelector(".post-title-input").value;
  const text = card.querySelector(".post-textarea").value;
  const collectionId = card.querySelector(".group-collection-select").value;
  const publishTime = card.querySelector(".publish-time-input").value || '09:00';
  const images = Array.from(card.querySelectorAll(".media-preview img, .media-preview video")).map(el => el.dataset.path);
  const groups = Array.from(card.querySelectorAll('input[name="groups[]"]:checked')).map(input => input.value);

  console.log('ğŸ” ×©××™×¨×ª ×¤×•×¡×˜ - ××“×™×” ×©× ××¦×:', images);

  // ×¤×•× ×§×¦×™×” ×œ×”××¨×ª ×ª××¨×™×š ×-d/m/Y ×œ-YYYY-MM-DD
  function toMysqlDate(val) {
    if (!val) return '';
    if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
    const parts = val.split('/');
    if (parts.length === 3) {
      const [d, m, y] = parts;
      if (y && m && d) return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    }
    return val;
  }

  const formData = new FormData();
  formData.append("id", postId);
  formData.append("title", title);
  formData.append("text", text);
  formData.append("collection_id", collectionId);
  formData.append("publish_time", publishTime);
  formData.append("hostname", hostname);
  images.forEach(img => formData.append("images[]", img));
  groups.forEach(group => formData.append("groups[]", group));

  // ×”×•×¡×£ ×©×“×•×ª ×¡×˜×˜×•×¡ ×•×ª×–××•×Ÿ
  formData.append("status", card.dataset.status || 'active');
  const validScheduleTypes = ['weekly','monthly','one-time'];
  let scheduleType = card.dataset.schedule_type;
  if (card.dataset.status === 'scheduled' && validScheduleTypes.includes(scheduleType)) {
    formData.append("schedule_type", scheduleType);
  } else if (card.dataset.status === 'scheduled') {
    formData.append("schedule_type", 'weekly');
  }
  formData.append("days_of_week", card.dataset.days_of_week || '');
  formData.append("days_of_month", card.dataset.days_of_month || '');
  if (card.dataset.one_time_date) formData.append("one_time_date", toMysqlDate(card.dataset.one_time_date));
  if (card.dataset.monthly_date) formData.append("monthly_date", toMysqlDate(card.dataset.monthly_date));
  formData.append("repeat_mode", card.dataset.repeat_mode || 'unlimited');
  if (card.dataset.start_date) formData.append("start_date", toMysqlDate(card.dataset.start_date));
  if (card.dataset.end_date) formData.append("end_date", toMysqlDate(card.dataset.end_date));
  
  console.log('Saving post data (autoSave):');
  for (let pair of formData.entries()) {
    console.log(pair[0] + ': ' + pair[1]);
  }
  
  return fetch("/wp-content/postify-api/update-post.php", { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
      console.log('Server response (autoSave):', data);
      if (data.success) {
        if (statusSpan) statusSpan.textContent = "âœ… × ×©××¨";
        
        // ×¢×“×›×Ÿ ××ª allPosts - ×©××•×¨ ××“×™×” ×§×™×™××ª ×•××œ ×ª×—×œ×™×£ ××•×ª×”
        const post = allPosts.find(p => p.id == postId);
        if (post) {
          post.title = title;
          post.text = text;
          post.collection_id = collectionId;
          post.publish_time = publishTime; // âœ… ×”×•×¡×£ ×©×¢×ª ×¤×¨×¡×•×
          // âš ï¸ ×—×©×•×‘: ×©××•×¨ ××“×™×” ×¨×§ ×× ×™×© ×—×“×©×”, ××—×¨×ª ×”×©××¨ ××ª ×”×§×™×™××ª
          if (images && images.length > 0) {
            post.images = images;
            console.log('ğŸ“ ×¢×“×›×•×Ÿ ××“×™×” ×‘×¤×•×¡×˜:', post.id, '××“×™×” ×—×“×©×”:', images);
          } else {
            console.log('ğŸ“ ×œ× × ××¦××” ××“×™×” ×—×“×©×” - ××©××™×¨ ××ª ×”×§×™×™××ª ×‘×¤×•×¡×˜:', post.id);
          }
          // ××œ ×ª×¢×“×›×Ÿ images ×× ×–×” ×¨×™×§ - ×–×” ×¢×œ×•×œ ×œ××—×•×§ ××“×™×” ×©×”×•×¢×œ×ª×” ×–×” ×¢×ª×”
          post.status = card.dataset.status || 'active';
          post.schedule_type = card.dataset.schedule_type || '';
          post.days_of_week = card.dataset.days_of_week || '';
          post.days_of_month = card.dataset.days_of_month || '';
          post.one_time_date = card.dataset.one_time_date || '';
          post.monthly_date = card.dataset.monthly_date || '';
          post.repeat_mode = card.dataset.repeat_mode || 'unlimited';
          post.start_date = card.dataset.start_date || '';
          post.end_date = card.dataset.end_date || '';
          
          console.log('ğŸ“ ×¢×“×›×•×Ÿ ×¤×•×¡×˜ ×‘-allPosts:', post.id, '××“×™×” ×¡×•×¤×™×ª:', post.images);
        }
        
        // ×¨×¢× ×Ÿ Flatpickr ×œ×›×œ ×”×¤×•×¡×˜×™×
        refreshFlatpickrForAllPosts();
        
        // ×¢×“×›×Ÿ ×ª×–××•×Ÿ Google Cloud ××—×¨×™ ×©××™×¨×” ××•×¦×œ×—×ª
        updateScheduleAfterTimeChange(postId);
        
        if (statusSpan) setTimeout(() => statusSpan.textContent = '', 3000);
        return data;
      } else {
        if (statusSpan) statusSpan.textContent = "âŒ ×©×’×™××”: " + (data.message || data.error || '×œ× ×™×“×•×¢');
        console.error('Save failed:', data);
        if (statusSpan) setTimeout(() => statusSpan.textContent = '', 3000);
        throw new Error(data.message || data.error || '×œ× ×™×“×•×¢');
      }
    })
    .catch(err => {
      console.error('Save error:', err);
      if (statusSpan) statusSpan.textContent = "âŒ ×©×’×™××” ×‘×©××™×¨×”";
      if (statusSpan) setTimeout(() => statusSpan.textContent = '', 3000);
      throw err;
    });
}

// ×”×•×¡×£ ×¤×•× ×§×¦×™×” ×’×œ×•×‘×œ×™×ª ×œ××—×™×§×ª ×¤×•×¡×˜ ××”×›×¨×˜×™×¡×™×” ×”×¡×’×•×¨×”
window.deleteCollapsedPost = function(postId, btn) {
  if (!confirm("×”×× ×œ××—×•×§ ××ª ×”×¤×•×¡×˜?")) return;
  
  const fd = new FormData();
  fd.append("id", postId);
  fetch("/wp-content/postify-api/delete-post.php", { method: "POST", body: fd })
    .then(() => {
      const card = btn.closest('.post-card-collapsed');
      if (card) card.remove();
      
      allPosts = allPosts.filter(p => p.id != postId);
      
      const expanded = document.getElementById('expand-post-' + postId);
      if (expanded) expanded.remove();
    })
    .catch(err => console.error('Delete error:', err));
};

// ×›×¤×ª×•×¨ ×”×•×¡×¤×ª ×¤×•×¡×˜ ×—×“×©
document.getElementById("add-post-btn").onclick = function() {
  fetch("/wp-content/postify-api/add-post.php", { method: "POST" })
    .then(res => res.json())
    .then(() => loadPostsFromDB())
    .catch(err => console.error('Add post error:', err));
};

// ×”×¤×¢×œ ××ª Flatpickr ×¢×œ ×›×œ input[type="date"]
function enableFlatpickrOnDates() {
  const dateInputs = document.querySelectorAll('input[type="date"]:not(.flatpickr-input)');
  
  dateInputs.forEach(input => {
    const postCard = input.closest('.post-card-expanded-inner');
    if (!postCard) return;
    
    const postId = postCard.dataset.postId;
    
    // ×–×™×”×•×™ ×¡×•×’ ×”×ª×–××•×Ÿ ×œ×¤×™ ×”×©×“×”
    let scheduleType = 'one-time';
    if (input.classList.contains('monthly-date-input')) {
      scheduleType = 'monthly';
    } else if (input.classList.contains('one-time-date-input')) {
      scheduleType = 'one-time';
    } else if (input.classList.contains('start-date-input')) {
      scheduleType = 'weekly';
    } else if (input.classList.contains('end-date-input')) {
      scheduleType = 'weekly';
    }
    
    flatpickr(input, {
      dateFormat: "d/m/Y",
      locale: {
        firstDayOfWeek: 1
      },
      minDate: "today",
      disable: function(date) {
        // ×‘×“×™×§×” ×œ×›×œ ×©×“×•×ª ×”×ª××¨×™×š
        if (scheduleType !== 'one-time' && scheduleType !== 'monthly' && scheduleType !== 'weekly') return false;
        
        // ×”××¨ ×ª××¨×™×š ×œ×¤×•×¨××˜ ×ª×§× ×™
        const dateStr = date.getFullYear() + '-' + 
          String(date.getMonth() + 1).padStart(2, '0') + '-' + 
          String(date.getDate()).padStart(2, '0');
        
        // ×‘×“×™×§×” ×™×©×™×¨×” ×× ×™×© ×”×ª× ×’×©×•×ª ×¢× ×¤×•×¡×˜×™× ××—×¨×™×
        const isConflicted = isDateConflicted(dateStr, postId, scheduleType);
        console.log(`ğŸ“… Flatpickr ×‘×•×“×§ ×ª××¨×™×š ${dateStr}: ${isConflicted ? '×—×¡×•×' : '×–××™×Ÿ'}`);
        return isConflicted;
      },
      onChange: function(selectedDates, dateStr, instance) {
        if (selectedDates.length === 0) return;
        
        console.log('×ª××¨×™×š × ×‘×—×¨:', dateStr, '×¡×•×’:', scheduleType, '×¤×•×¡×˜:', postId);
        
        // ×‘×“×™×§×” × ×•×¡×¤×ª ×‘×¢×ª ×‘×—×™×¨×ª ×”×ª××¨×™×š
        if (!validateDateAvailability(dateStr, postId, scheduleType)) {
          console.log('×ª××¨×™×š × ×“×—×” - ×× ×§×” ×‘×—×™×¨×”');
          instance.clear();
          return;
        }
        
        // ×¢×“×›×Ÿ ××ª ×”× ×ª×•× ×™× ×‘×›×¨×˜×™×¡
        if (scheduleType === 'one-time') {
          postCard.dataset.one_time_date = dateStr;
        } else if (scheduleType === 'monthly') {
          postCard.dataset.monthly_date = dateStr;
        } else if (scheduleType === 'weekly') {
          // ×œ×ª××¨×™×›×™ ×”×ª×—×œ×” ×•×¡×™×•× ×‘×©×‘×•×¢×™
          if (input.classList.contains('start-date-input')) {
            postCard.dataset.start_date = dateStr;
          } else if (input.classList.contains('end-date-input')) {
            postCard.dataset.end_date = dateStr;
          }
        }
        
        console.log('×ª××¨×™×š ××•×©×¨ - ××¢×“×›×Ÿ Flatpickr ××—×¨×™×');
        // ×¢×“×›×Ÿ ××™×™×“×™×ª ××ª ×›×œ ×”×¤×•×¡×˜×™× ×”××—×¨×™×
        setTimeout(() => {
          refreshFlatpickrForAllPosts();
        }, 100);
      }
    });
  });
}

// ×”×¤×¢×œ Flatpickr ××“×™ ×¤×¢× ×¢×œ ×©×“×•×ª ×—×“×©×™×
setInterval(enableFlatpickrOnDates, 1000);

// ×¤×•× ×§×¦×™×•×ª ×œ× ×™×”×•×œ ×ª××¨×™×›×™× ×ª×¤×•×¡×™× - ××•×¨×—×‘ ×œ×›×œ ×¡×•×’×™ ×”×ª×–××•×Ÿ ×•×œ×›×¤×™×œ×•×™×•×ª
function getOccupiedDates(excludePostId = null) {
  console.log('××—×¤×© ×ª××¨×™×›×™× ×ª×¤×•×¡×™×, ××ª×¢×œ× ××¤×•×¡×˜:', excludePostId);
  console.log('×›×œ ×”×¤×•×¡×˜×™×:', allPosts);
  
  const occupiedDates = new Set();
  const currentDate = new Date();
  
  allPosts.forEach(post => {
    console.log(`×‘×•×“×§ ×¤×•×¡×˜ ${post.id}:`, post);
    
    if (excludePostId && post.id == excludePostId) {
      console.log(`×“×•×œ×’ ×¢×œ ×¤×•×¡×˜ ${post.id} (× ×•×›×—×™)`);
      return; // ×“×œ×’ ×¢×œ ×”×¤×•×¡×˜ ×”× ×•×›×—×™
    }
    
    if (post.status !== 'scheduled') {
      console.log(`×“×•×œ×’ ×¢×œ ×¤×•×¡×˜ ${post.id} - ×œ× ××ª×¤×¨×¡× (${post.status})`);
      return; // ×¨×§ ×¤×•×¡×˜×™× ××ª×•×–×× ×™×
    }
    
    console.log(`×¤×•×¡×˜ ${post.id} ××ª×•×–××Ÿ:`, post.schedule_type);
    
    // ×ª×–××•×Ÿ ×—×“-×¤×¢××™
    if (post.schedule_type === 'one-time' && post.one_time_date) {
      const normalizedDate = normalizeDate(post.one_time_date);
      console.log(`×¤×•×¡×˜ ${post.id} ×—×“-×¤×¢××™:`, post.one_time_date, '->', normalizedDate);
      if (normalizedDate) occupiedDates.add(normalizedDate);
    }
    
    // ×ª×–××•×Ÿ ×—×•×“×©×™ - ×›×•×œ×œ ×›×¤×™×œ×•×™×•×ª ×‘××•×ª×• ×™×•× ×‘×—×•×“×©
    if (post.schedule_type === 'monthly' && post.monthly_date) {
      const normalizedDate = normalizeDate(post.monthly_date);
      console.log(`×¤×•×¡×˜ ${post.id} ×—×•×“×©×™:`, post.monthly_date, '->', normalizedDate);
      if (normalizedDate) {
        const baseDate = new Date(normalizedDate);
        if (!isNaN(baseDate.getTime())) {
          const targetDay = baseDate.getDate();
          
          // ×”×•×¡×£ ×ª××¨×™×›×™× ×œ×©× ×” ×”×§×¨×•×‘×” ×¢×‘×•×¨ ××•×ª×• ×™×•× ×‘×—×•×“×©
          for (let i = 0; i < 12; i++) {
            const monthlyDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + i, targetDay);
            if (monthlyDate >= currentDate) { // ×¨×§ ×ª××¨×™×›×™× ×¢×ª×™×“×™×™×
              const formattedDate = monthlyDate.getFullYear() + '-' + 
                String(monthlyDate.getMonth() + 1).padStart(2, '0') + '-' + 
                String(monthlyDate.getDate()).padStart(2, '0');
              occupiedDates.add(formattedDate);
              console.log(`×”×•×¡×£ ×ª××¨×™×š ×—×•×“×©×™: ${formattedDate}`);
            }
          }
        }
      }
    }
    
    // ×ª×–××•×Ÿ ×©×‘×•×¢×™ - ×›×•×œ×œ ×›×¤×™×œ×•×™×•×ª ×‘××•×ª× ×™××™×
    if (post.schedule_type === 'weekly' && post.days_of_week) {
      const daysOfWeek = post.days_of_week.split(',').filter(Boolean).map(d => parseInt(d));
      console.log(`×¤×•×¡×˜ ${post.id} ×©×‘×•×¢×™ - ×™××™×:`, daysOfWeek);
      
      // ×—×™×©×•×‘ ×ª××¨×™×›×™× ×©×‘×•×¢×™×™× ×œ×©× ×” ×”×§×¨×•×‘×”
      const startDate = post.start_date ? new Date(normalizeDate(post.start_date)) : currentDate;
      const endDate = post.end_date ? new Date(normalizeDate(post.end_date)) : new Date(currentDate.getTime() + 365 * 24 * 60 * 60 * 1000);
      
      let checkDate = new Date(Math.max(startDate.getTime(), currentDate.getTime())); // ×”×ª×—×œ ××”×™×•× ××• ××ª××¨×™×š ×”×”×ª×—×œ×”
      while (checkDate <= endDate) {
        const dayOfWeek = checkDate.getDay();
        if (daysOfWeek.includes(dayOfWeek)) {
          const formattedDate = checkDate.getFullYear() + '-' + 
            String(checkDate.getMonth() + 1).padStart(2, '0') + '-' + 
            String(checkDate.getDate()).padStart(2, '0');
          occupiedDates.add(formattedDate);
          console.log(`×”×•×¡×£ ×ª××¨×™×š ×©×‘×•×¢×™: ${formattedDate}`);
        }
        checkDate.setDate(checkDate.getDate() + 1);
      }
    }
  });
  
  const result = Array.from(occupiedDates);
  console.log('×ª××¨×™×›×™× ×ª×¤×•×¡×™× ×¡×”"×›:', result);
  return result;
}

// ×¤×•× ×§×¦×™×” ××“×•×™×§×ª ×œ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª ×ª××¨×™×›×™×
function isDateConflicted(targetDate, excludePostId, currentScheduleType) {
  console.log('ğŸ” ×‘×•×“×§ ×”×ª× ×’×©×•×ª ×¢×‘×•×¨ ×ª××¨×™×š:', targetDate, '×¤×•×¡×˜ × ×•×›×—×™:', excludePostId, '×¡×•×’:', currentScheduleType);
  
  const normalizedTarget = normalizeDate(targetDate);
  if (!normalizedTarget) {
    console.log('âŒ ×ª××¨×™×š ×œ× ×ª×§×™×Ÿ');
    return false;
  }
  
  const targetDateObj = new Date(normalizedTarget);
  const targetDay = targetDateObj.getDay(); // ×™×•× ×‘×©×‘×•×¢ (0-6)
  const targetDayOfMonth = targetDateObj.getDate(); // ×™×•× ×‘×—×•×“×© (1-31)
  
  console.log('ğŸ“… ×× ×•×ª×— ×ª××¨×™×š:', normalizedTarget, '×™×•× ×‘×©×‘×•×¢:', targetDay, '×™×•× ×‘×—×•×“×©:', targetDayOfMonth);
  
  // ×‘×“×™×§×” ××•×œ ×›×œ ×”×¤×•×¡×˜×™× ×”×§×™×™××™×
  for (const post of allPosts) {
    if (post.id == excludePostId || post.status !== 'scheduled') {
      continue; // ×“×œ×’ ×¢×œ ×”×¤×•×¡×˜ ×”× ×•×›×—×™ ××• ×œ× ××ª×•×–×× ×™×
    }
    
    console.log(`ğŸ” ×‘×•×“×§ ×¤×•×¡×˜ ${post.id} (${post.schedule_type}):`, post.title || '×œ×œ× ×©×');
    
    // ×‘×“×™×§×” ××•×œ ×¤×•×¡×˜ ×—×“-×¤×¢××™
    if (post.schedule_type === 'one-time' && post.one_time_date) {
      const postDate = normalizeDate(post.one_time_date);
      if (postDate === normalizedTarget) {
        console.log(`âš ï¸ ×”×ª× ×’×©×•×ª ×¢× ×¤×•×¡×˜ ×—×“-×¤×¢××™ ${post.id} ×‘×ª××¨×™×š ${postDate}`);
        return true;
      }
    }
    
    // ×‘×“×™×§×” ××•×œ ×¤×•×¡×˜ ×—×•×“×©×™
    if (post.schedule_type === 'monthly' && post.monthly_date) {
      const postDate = normalizeDate(post.monthly_date);
      if (postDate) {
        const postDayOfMonth = new Date(postDate).getDate();
        
        // ×”×ª× ×’×©×•×ª ×× ×–×” ××•×ª×• ×™×•× ×‘×—×•×“×©
        if (postDayOfMonth === targetDayOfMonth) {
          console.log(`âš ï¸ ×”×ª× ×’×©×•×ª ×¢× ×¤×•×¡×˜ ×—×•×“×©×™ ${post.id} - ×™×•× ${postDayOfMonth} ×‘×—×•×“×©`);
          return true;
        }
      }
    }
    
    // ×‘×“×™×§×” ××•×œ ×¤×•×¡×˜ ×©×‘×•×¢×™
    if (post.schedule_type === 'weekly' && post.days_of_week) {
      const daysOfWeek = post.days_of_week.split(',').filter(Boolean).map(d => parseInt(d));
      const targetDay = new Date(normalizedTarget).getDay();
      if (daysOfWeek.includes(targetDay)) {
        // ×‘×“×•×§ ×× ×”×ª××¨×™×š × ××¦× ×‘×˜×•×•×— ×”×ª×–××•×Ÿ ×”×©×‘×•×¢×™
        const currentDate = new Date();
        const startDate = post.start_date ? new Date(normalizeDate(post.start_date)) : currentDate;
        const endDate = post.end_date ? new Date(normalizeDate(post.end_date)) : new Date(currentDate.getTime() + 365 * 24 * 60 * 60 * 1000);
        
        if (targetDateObj >= startDate && targetDateObj <= endDate) {
          console.log(`âš ï¸ ×”×ª× ×’×©×•×ª ×¢× ×¤×•×¡×˜ ×©×‘×•×¢×™ ${post.id} - ×™×•× ${targetDay} ×‘×©×‘×•×¢`);
          return true;
        }
      }
    }
  }
  
  console.log('âœ… ××™×Ÿ ×”×ª× ×’×©×•×ª - ×ª××¨×™×š ×–××™×Ÿ');
  return false;
}

function normalizeDate(dateStr) {
  if (!dateStr) return null;
  
  // ×× ×›×‘×¨ ×‘×¤×•×¨××˜ YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
    return dateStr;
  }
  
  // ×× ×‘×¤×•×¨××˜ d/m/Y
  const parts = dateStr.split('/');
  if (parts.length === 3) {
    const [d, m, y] = parts;
    if (y && m && d) {
      return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    }
  }
  
  return null;
}

// ×¤×•× ×§×¦×™×” ×œ×”××¨×ª ×ª××¨×™×š ×œ×¤×•×¨××˜ ×™×©×¨××œ×™ (dd/mm/yyyy)
function formatDateToIsraeli(dateStr) {
  if (!dateStr) return '';
  
  let date;
  
  // ×× ×›×‘×¨ ×‘×¤×•×¨××˜ ×™×©×¨××œ×™
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
    return dateStr;
  }
  
  // ×× ×‘×¤×•×¨××˜ YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
    const [year, month, day] = dateStr.split('-');
    return `${parseInt(day)}/${parseInt(month)}/${year}`;
  }
  
  // × ×¡×” ×œ×¤×¨×© ×›×ª××¨×™×š ×¨×’×™×œ
  date = new Date(dateStr);
  if (!isNaN(date.getTime())) {
    const day = date.getDate();
    const month = date.getMonth() + 1;
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }
  
  return dateStr; // ×”×—×–×¨ ×›××• ×©×–×” ×× ×œ× ×”×¦×œ×—× ×• ×œ×¤×¨×©
}

// ×¤×•× ×§×¦×™×” ×œ×”××¨×ª ×™×•× ×‘×©×‘×•×¢ ×œ××¡×¤×¨ ×œ×©× ×™×©×¨××œ×™
function getDayNameInHebrew(dayNumber) {
  const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
  return dayNames[dayNumber] || '';
}

function showDateErrorMessage(message) {
  // ×”×¡×¨ ×”×•×“×¢×” ×§×•×“××ª ×× ×§×™×™××ª
  const existingError = document.querySelector('.date-error-message');
  if (existingError) existingError.remove();
  
  // ×¦×•×¨ ×”×•×“×¢×ª ×©×’×™××” ×—×“×©×”
  const errorDiv = document.createElement('div');
  errorDiv.className = 'date-error-message';
  errorDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #dc3545;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    z-index: 10000;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    max-width: 400px;
    white-space: pre-line;
    line-height: 1.4;
  `;
  errorDiv.textContent = message;
  document.body.appendChild(errorDiv);
  
  // ×”×¡×¨ ××—×¨×™ 6 ×©× ×™×•×ª (×™×•×ª×¨ ×–××Ÿ ×œ×”×•×“×¢×•×ª ××¨×•×›×•×ª)
  setTimeout(() => {
    if (errorDiv.parentNode) {
      errorDiv.parentNode.removeChild(errorDiv);
    }
  }, 6000);
}

function validateDateAvailability(selectedDate, currentPostId, scheduleType) {
  console.log('×‘×•×“×§ ×–××™× ×•×ª ×ª××¨×™×š:', selectedDate, '×¤×•×¡×˜:', currentPostId, '×¡×•×’:', scheduleType);
  
  const normalizedDate = normalizeDate(selectedDate);
  if (!normalizedDate) {
    console.log('×ª××¨×™×š ×œ× ×ª×§×™×Ÿ');
    return true;
  }
  
  // ×”×©×ª××© ×‘×¤×•× ×§×¦×™×” ×”××“×•×™×§×ª ×œ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª
  const isConflicted = isDateConflicted(normalizedDate, currentPostId, scheduleType);
  
  if (isConflicted) {
    // ×’×œ×” ××” ×¡×•×’ ×”×¤×•×¡×˜ ×”××ª× ×’×©
    const conflictType = getConflictType(normalizedDate, currentPostId);
    
    // ×”×•×“×¢×ª ×©×’×™××” ××•×ª×××ª ×œ×¤×™ ×¡×•×’ ×”×ª×–××•×Ÿ
    let errorMessage;
    if (scheduleType === 'one-time') {
      const israeliDate = formatDateToIsraeli(selectedDate);
      errorMessage = `×”×ª××¨×™×š ${israeliDate} ×›×‘×¨ ×ª×¤×•×¡ ×¢×œ ×™×“×™ ×¤×•×¡×˜ ${conflictType}!`;
    } else if (scheduleType === 'monthly') {
      const selectedDay = new Date(normalizedDate).getDate();
      errorMessage = `×™×•× ${selectedDay} ×‘×—×•×“×© ×›×‘×¨ ×ª×¤×•×¡ ×¢×œ ×™×“×™ ×¤×•×¡×˜ ${conflictType}!`;
    } else if (scheduleType === 'weekly') {
      const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
      const selectedDayName = dayNames[new Date(normalizedDate).getDay()];
      errorMessage = `×™×•× ${selectedDayName} ×›×‘×¨ ×ª×¤×•×¡ ×¢×œ ×™×“×™ ×¤×•×¡×˜ ${conflictType}!`;
    } else {
      const israeliDate = formatDateToIsraeli(selectedDate);
      errorMessage = `×”×ª××¨×™×š ${israeliDate} ×›×‘×¨ ×ª×¤×•×¡ ×¢×œ ×™×“×™ ×¤×•×¡×˜ ${conflictType}!`;
    }
    
    showDateErrorMessage(errorMessage);
    return false;
  }
  
  return true;
}

// ×¤×•× ×§×¦×™×” ×œ×–×™×”×•×™ ×¡×•×’ ×”×¤×•×¡×˜ ×”××ª× ×’×©
function getConflictType(targetDate, excludePostId) {
  const normalizedTarget = normalizeDate(targetDate);
  
  for (const post of allPosts) {
    if (post.id == excludePostId || post.status !== 'scheduled') continue;
    
    if (post.schedule_type === 'one-time' && post.one_time_date) {
      const postDate = normalizeDate(post.one_time_date);
      if (postDate === normalizedTarget) {
        return '×—×“-×¤×¢××™';
      }
    }
    
    if (post.schedule_type === 'monthly' && post.monthly_date) {
      const postDate = normalizeDate(post.monthly_date);
      if (postDate && new Date(postDate).getDate() === new Date(normalizedTarget).getDate()) {
        return '×—×•×“×©×™';
      }
    }
    
    if (post.schedule_type === 'weekly' && post.days_of_week) {
      const daysOfWeek = post.days_of_week.split(',').filter(Boolean).map(d => parseInt(d));
      const targetDay = new Date(normalizedTarget).getDay();
      if (daysOfWeek.includes(targetDay)) {
        // ×‘×“×™×§×” ×× ×”×ª××¨×™×š × ×•×¤×œ ×‘×˜×•×•×— ×”×ª×–××•×Ÿ ×”×©×‘×•×¢×™
        const currentDate = new Date();
        const startDate = post.start_date ? new Date(normalizeDate(post.start_date)) : currentDate;
        const endDate = post.end_date ? new Date(normalizeDate(post.end_date)) : new Date(currentDate.getTime() + 365 * 24 * 60 * 60 * 1000);
        
        if (targetDateObj >= startDate && targetDateObj <= endDate) {
          return '×©×‘×•×¢×™';
        }
      }
    }
  }
  
  return '××—×¨';
}

// ×¤×•× ×§×¦×™×” × ×•×¡×¤×ª ×œ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª ×‘×™×Ÿ ×™××™ ×©×‘×•×¢
function validateWeeklyDaysAvailability(selectedDays, currentPostId, startDate, endDate) {
  console.log('×‘×•×“×§ ×–××™× ×•×ª ×™××™ ×©×‘×•×¢:', selectedDays, '×¤×•×¡×˜:', currentPostId);
  
  if (!selectedDays || selectedDays.length === 0) {
    console.log('××™×Ÿ ×™××™× × ×‘×—×¨×™× - ×××©×¨ ××•×˜×•××˜×™×ª');
    return true; // ××™×Ÿ ×™××™× × ×‘×—×¨×™×, ××™×Ÿ ×‘×¢×™×”
  }
  
  // ×‘×“×™×§×” ×™×©×™×¨×” ××•×œ ×›×œ ×”×¤×•×¡×˜×™× ×”×©×‘×•×¢×™×™× ×”××—×¨×™×
  const conflicts = [];
  
  allPosts.forEach(post => {
    if (currentPostId && post.id == currentPostId) return; // ×“×œ×’ ×¢×œ ×”×¤×•×¡×˜ ×”× ×•×›×—×™
    if (post.status !== 'scheduled' || post.schedule_type !== 'weekly') return;
    
    if (post.days_of_week) {
      const otherDays = post.days_of_week.split(',').filter(Boolean).map(d => parseInt(d));
      console.log(`×¤×•×¡×˜ ${post.id} ×©×‘×•×¢×™ ×¢× ×™××™×:`, otherDays);
      
      // ×‘×“×™×§×” ×× ×™×© ×—×¤×™×¤×” ×‘×™××™ ×”×©×‘×•×¢
      const overlap = selectedDays.filter(day => otherDays.includes(day));
      if (overlap.length > 0) {
        const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
        const conflictDayNames = overlap.map(d => dayNames[d]).join(', ');
        conflicts.push(`×¤×•×¡×˜ "${post.title || '×œ×œ× ×©×'}" ×›×‘×¨ ××©×ª××© ×‘×™××™×: ${conflictDayNames}`);
        console.log(`×”×ª× ×’×©×•×ª × ××¦××” ×¢× ×¤×•×¡×˜ ${post.id} ×‘×™××™×:`, overlap);
      }
    }
  });
  
  // ×‘×“×™×§×” ××•×œ ×¤×•×¡×˜×™× ××¡×•×’×™× ××—×¨×™× ×‘×××¦×¢×•×ª ×”×¤×•× ×§×¦×™×” ×”××“×•×™×§×ª
  const currentDate = new Date();
  const checkStartDate = startDate ? new Date(normalizeDate(startDate)) : currentDate;
  const checkEndDate = endDate ? new Date(normalizeDate(endDate)) : new Date(currentDate.getTime() + 90 * 24 * 60 * 60 * 1000); // 3 ×—×•×“×©×™×
  
  let checkDate = new Date(checkStartDate);
  const dateConflicts = [];
  
  while (checkDate <= checkEndDate && dateConflicts.length < 5) { // ×‘×•×“×§ ×¨×§ 5 ×”×ª× ×’×©×•×™×•×ª ×¨××©×•× ×•×ª
    const dayOfWeek = checkDate.getDay();
    if (selectedDays.includes(dayOfWeek)) {
      const formattedDate = checkDate.getFullYear() + '-' + 
        String(checkDate.getMonth() + 1).padStart(2, '0') + '-' + 
        String(checkDate.getDate()).padStart(2, '0');
      
      // ×”×©×ª××© ×‘×¤×•× ×§×¦×™×” ×”××“×•×™×§×ª ×œ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª
      if (isDateConflicted(formattedDate, currentPostId, 'weekly')) {
        dateConflicts.push(formattedDate);
      }
    }
    checkDate.setDate(checkDate.getDate() + 1);
  }
  
  // ×”×›× ×ª ×”×•×“×¢×ª ×©×’×™××”
  if (conflicts.length > 0 || dateConflicts.length > 0) {
    let errorMessage = '';
    
    if (conflicts.length > 0) {
      errorMessage += conflicts.join('\n');
    }
    
    if (dateConflicts.length > 0) {
      if (errorMessage) errorMessage += '\n\n';
      const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
      const selectedDayNames = selectedDays.map(d => dayNames[d]).join(', ');
      const conflictDatesFormatted = dateConflicts.map(date => {
        const d = new Date(date);
        return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
      }).join(', ');
      
      errorMessage += `×”×™××™× ${selectedDayNames} ××ª× ×’×©×™× ×¢× ×¤×•×¡×˜×™× ××—×¨×™× ×‘×ª××¨×™×›×™×: ${conflictDatesFormatted}`;
    }
    
    showDateErrorMessage(errorMessage);
    return false;
  }
  
  return true;
}

// ×¤×•× ×§×¦×™×” ×’×œ×•×‘×œ×™×ª ×œ×‘×“×™×§×ª ×‘×—×™×¨×ª ×™××™ ×©×‘×•×¢
window.validateWeeklySelection = function(checkbox, postId) {
  console.log('×‘×•×“×§ ×‘×—×™×¨×ª ×™×•× ×©×‘×•×¢:', checkbox.value, '×¤×•×¡×˜:', postId, '××¡×•××Ÿ:', checkbox.checked);
  
  if (!checkbox.checked) return; // ×× ×‘×•×˜×œ ×”×¡×™××•×Ÿ, ××™×Ÿ ×‘×¢×™×”
  
  const selectedDay = parseInt(checkbox.value);
  const modal = document.getElementById("status-modal");
  const startDateInput = modal.querySelector('.start-date-input');
  const endDateInput = modal.querySelector('.end-date-input');
  
  // ×§×‘×œ ×ª××¨×™×›×™ ×”×ª×—×œ×” ×•×¡×™×•×
  const startDate = startDateInput ? startDateInput.value : '';
  const endDate = endDateInput ? endDateInput.value : '';
  
  // ×‘×“×™×§×” ×× ×”×™×•× ×©× ×‘×—×¨ ××ª× ×’×© ×¢× ×¤×•×¡×˜×™× ××—×¨×™×
  if (!validateSingleWeeklyDay(selectedDay, postId, startDate, endDate)) {
    checkbox.checked = false; // ×‘×˜×œ ××ª ×”×‘×—×™×¨×”
    return;
  }
};

// ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ×™×•× ×‘×•×“×“ ×‘×ª×–××•×Ÿ ×©×‘×•×¢×™
function validateSingleWeeklyDay(dayOfWeek, currentPostId, startDate, endDate) {
  console.log('×‘×•×“×§ ×™×•× ×©×‘×•×¢:', dayOfWeek, '×¤×•×¡×˜:', currentPostId);
  
  // ×—×™×©×•×‘ ×ª××¨×™×›×™× ×¢×ª×™×“×™×™× ×œ×¤×™ ×”×™×•× ×©× ×‘×—×¨
  const currentDate = new Date();
  const checkStartDate = startDate ? new Date(normalizeDate(startDate)) : currentDate;
  const checkEndDate = endDate ? new Date(normalizeDate(endDate)) : new Date(currentDate.getTime() + 365 * 24 * 60 * 60 * 1000);
  
  let checkDate = new Date(checkStartDate);
  const conflicts = [];
  
  while (checkDate <= checkEndDate && conflicts.length < 3) { // ×‘×•×“×§ ×¨×§ 3 ×”×ª× ×’×©×•×™×•×ª ×¨××©×•× ×•×ª
    if (checkDate.getDay() === dayOfWeek) {
      const formattedDate = checkDate.getFullYear() + '-' + 
        String(checkDate.getMonth() + 1).padStart(2, '0') + '-' + 
        String(checkDate.getDate()).padStart(2, '0');
      
      // ×”×©×ª××© ×‘×¤×•× ×§×¦×™×” ×”××“×•×™×§×ª ×œ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª
      if (isDateConflicted(formattedDate, currentPostId, 'weekly')) {
        conflicts.push(formattedDate);
      }
    }
    checkDate.setDate(checkDate.getDate() + 1);
  }
  
  if (conflicts.length > 0) {
    const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
    const conflictDatesFormatted = conflicts.map(date => {
      const d = new Date(date);
      return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
    }).join(', ');
    
    showDateErrorMessage(`×™×•× ${dayNames[dayOfWeek]} ××ª× ×’×© ×¢× ×¤×•×¡×˜×™× ××—×¨×™× ×‘×ª××¨×™×›×™×: ${conflictDatesFormatted}`);
    return false;
  }
  
  return true;
}

// ×¤×•× ×§×¦×™×” ×œ×¨×¢× ×•×Ÿ Flatpickr ×‘×›×œ ×”×¤×•×¡×˜×™×
  function refreshFlatpickrForAllPosts() {
    console.log('ğŸ”„ ××¨×¢× ×Ÿ Flatpickr ×œ×›×œ ×”×¤×•×¡×˜×™×...');
    console.log('ğŸ“Š ××¦×‘ allPosts ×œ×¤× ×™ ×¨×¢× ×•×Ÿ:', allPosts.map(p => ({id: p.id, images: p.images})));
    
    // ×”×¡×¨ ×›×œ instances ×§×™×™××™× ×©×œ Flatpickr
    document.querySelectorAll('.flatpickr-input').forEach(input => {
      if (input._flatpickr) {
        input._flatpickr.destroy();
      }
    });
    
    // ×”×¤×¢×œ ××—×“×© Flatpickr ×¢×œ ×›×œ ×”×©×“×•×ª
    setTimeout(() => {
      enableFlatpickrOnDates();
    }, 50);
  }

// ×¤×•× ×§×¦×™×•×ª ×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡
function applyStatusFilter() {
  const selectedStatuses = Array.from(document.querySelectorAll('.status-filter:checked')).map(cb => cb.value);
  const allCards = document.querySelectorAll('.post-card-collapsed');
  
  allCards.forEach(card => {
    const cardStatus = card.getAttribute('data-status') || 'active';
    if (selectedStatuses.includes(cardStatus)) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
      // ×¡×’×•×¨ ××ª ×”×›×¨×˜×™×¡ ×”××¤×•×¨×˜ ×× ×”×•× ×¤×ª×•×—
      const expandedCard = document.getElementById('expand-post-' + card.getAttribute('data-post-id'));
      if (expandedCard) {
        expandedCard.style.display = 'none';
      }
    }
  });
}

function initStatusFilters() {
  console.log('Initializing status filters...');
  
  // ×”×•×¡×£ event listeners ×œ×›×œ checkbox ×©×œ ×”×¡×™× ×•×Ÿ
  const checkboxes = document.querySelectorAll('.status-filter');
  console.log('Found checkboxes:', checkboxes.length);
  
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', applyStatusFilter);
  });
  
  // ×›×¤×ª×•×¨ "× ×§×” ×”×›×œ"
  const clearBtn = document.getElementById('clear-filters');
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      document.querySelectorAll('.status-filter').forEach(cb => cb.checked = false);
      applyStatusFilter();
    });
  }
  
  // ×›×¤×ª×•×¨ "×‘×—×¨ ×”×›×œ"
  const selectAllBtn = document.getElementById('select-all-filters');
  if (selectAllBtn) {
    selectAllBtn.addEventListener('click', () => {
      document.querySelectorAll('.status-filter').forEach(cb => cb.checked = true);
      applyStatusFilter();
    });
  }
  
  // ×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×ª×¤×¨×™×˜ ×”×¡×™× ×•×Ÿ
  const filterToggle = document.getElementById('filter-toggle');
  const filterDropdown = document.getElementById('filter-dropdown');
  
  console.log('Filter toggle found:', !!filterToggle);
  console.log('Filter dropdown found:', !!filterDropdown);
  
  if (filterToggle && filterDropdown) {
    filterToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      const isVisible = filterDropdown.style.display === 'block';
      filterDropdown.style.display = isVisible ? 'none' : 'block';
      
      console.log('Toggle clicked, dropdown display:', filterDropdown.style.display);
      
      // ×©× ×” ××ª ×”×—×¥
      const arrow = filterToggle.querySelector('span');
      if (arrow) {
        arrow.textContent = isVisible ? 'â–¼' : 'â–²';
      }
    });
    
    // ×¡×’×•×¨ ××ª ×”×ª×¤×¨×™×˜ ×›×©×œ×•×—×¦×™× ××—×•×¥ ×œ×•
    document.addEventListener('click', (e) => {
      if (!filterToggle.contains(e.target) && !filterDropdown.contains(e.target)) {
        filterDropdown.style.display = 'none';
        const arrow = filterToggle.querySelector('span');
        if (arrow) {
          arrow.textContent = 'â–¼';
        }
      }
    });
  }
  
  // ×”×¤×¢×œ ×¡×™× ×•×Ÿ ×¨××©×•× ×™
  applyStatusFilter();
}

// ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ ×”×’×“×¨×•×ª ×¤×¨×¡×•×
// ×©×™× ×œ×‘: ×¢×“×›×Ÿ ××ª ×›×ª×•×‘×ª ×”×©×¨×ª ×-'your-website.com' ×œ×›×ª×•×‘×ª ×”××ª×¨ ×©×œ×š
const SERVER_URL = 'https://postify.co.il/wp-content/postify-api'; // ğŸ”¥ ×›×ª×•×‘×ª ×”×©×¨×ª ×”××¢×•×“×›× ×ª!

function initSettingsDropdown() {
  console.log('Initializing settings dropdown...');
  
  const settingsToggle = document.getElementById('settings-toggle');
  const settingsDropdown = document.getElementById('settings-dropdown');
  const saveSettingsBtn = document.getElementById('save-settings');
  const cancelSettingsBtn = document.getElementById('cancel-settings');
  
  console.log('Settings elements found:', {
    toggle: !!settingsToggle,
    dropdown: !!settingsDropdown,
    saveBtn: !!saveSettingsBtn,
    cancelBtn: !!cancelSettingsBtn
  });
  
  if (settingsToggle && settingsDropdown) {
    // ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×ª×¤×¨×™×˜ ×”×’×“×¨×•×ª
    settingsToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      const isVisible = settingsDropdown.style.display === 'block';
      settingsDropdown.style.display = isVisible ? 'none' : 'block';
      
      console.log('Settings toggle clicked, dropdown display:', settingsDropdown.style.display);
      
      // ×©× ×” ××ª ×”×—×¥
      const arrow = settingsToggle.querySelector('span');
      if (arrow) {
        arrow.textContent = isVisible ? 'â–¼' : 'â–²';
      }
      
      // ×˜×¢×Ÿ ×”×’×“×¨×•×ª × ×•×›×—×™×•×ª ×‘×¤×ª×™×—×ª ×”×ª×¤×¨×™×˜
      if (!isVisible) {
        loadCurrentSettings();
      }
    });
    
    // ×¡×’×•×¨ ××ª ×”×ª×¤×¨×™×˜ ×›×©×œ×•×—×¦×™× ××—×•×¥ ×œ×•
    document.addEventListener('click', (e) => {
      if (!settingsToggle.contains(e.target) && !settingsDropdown.contains(e.target)) {
        settingsDropdown.style.display = 'none';
        const arrow = settingsToggle.querySelector('span');
        if (arrow) {
          arrow.textContent = 'â–¼';
        }
      }
    });
  }
  
  // ×›×¤×ª×•×¨ ×©××™×¨×ª ×”×’×“×¨×•×ª
  if (saveSettingsBtn) {
    saveSettingsBtn.addEventListener('click', async () => {
      console.log('Save settings clicked');
      await saveUserSettings();
    });
  }
  
  // ×›×¤×ª×•×¨ ×‘×™×˜×•×œ
  if (cancelSettingsBtn) {
    cancelSettingsBtn.addEventListener('click', () => {
      console.log('Cancel settings clicked');
      settingsDropdown.style.display = 'none';
      const arrow = settingsToggle.querySelector('span');
      if (arrow) {
        arrow.textContent = 'â–¼';
      }
    });
  }
}

// ×˜×¢×™× ×ª ×”×’×“×¨×•×ª × ×•×›×—×™×•×ª ××”×©×¨×ª
async function loadCurrentSettings() {
  try {
    console.log('Loading current settings...');
    // ×§×‘×œ ××ª ×©× ×”××—×©×‘
    const hostname = await getHostname();
    console.log('Hostname:', hostname);
    // ×¢×“×›×Ÿ ××ª ×”×ª×¦×•×’×” ×©×œ ×”-hostname
    const hostnameDisplay = document.getElementById('current-hostname-display');
    if (hostnameDisplay) {
      hostnameDisplay.textContent = hostname;
    }
    const apiUrl = `${SERVER_URL}/get-user-data.php?hostname=${hostname}`;
    console.log('Fetching from:', apiUrl);
    // ×§×‘×œ ×”×’×“×¨×•×ª ××”×©×¨×ª
    const response = await fetch(apiUrl);
    const data = await response.json();
    if (data.user_settings) {
      const settings = data.user_settings;
      // ××œ× ××ª ×”×©×“×•×ª ×‘×˜×•×¤×¡
      document.getElementById('max-posts-per-day').value = settings.max_posts_per_day || 1;
      document.getElementById('max-publications-per-day').value = settings.max_publications_per_day || 50;
      console.log('Settings loaded successfully:', settings);
    } else {
      // ×‘×¨×™×¨×ª ××—×“×œ ×—×“×©×”
      document.getElementById('max-posts-per-day').value = 1;
      document.getElementById('max-publications-per-day').value = 50;
      console.log('Using default settings: 1 post/day, 50 publications/day');
    }
  } catch (error) {
    console.error('Error loading settings:', error);
    showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×’×“×¨×•×ª', 'error');
  }
}

// ×©××™×¨×ª ×”×’×“×¨×•×ª ×œ×©×¨×ª
async function saveUserSettings() {
  try {
    console.log('Saving user settings...');
    
    // ×§×‘×œ ××ª ×©× ×”××—×©×‘
    const hostname = await getHostname();
    
    // ×§×‘×œ ×¢×¨×›×™× ××”×˜×•×¤×¡
    const settings = {
      hostname: hostname,
      max_posts_per_day: parseInt(document.getElementById('max-posts-per-day').value) || 5,
      max_publications_per_day: parseInt(document.getElementById('max-publications-per-day').value) || 15
    };
    
    console.log('Settings to save:', settings);
    
    const apiUrl = `${SERVER_URL}/update-user-settings.php`;
    console.log('Saving to:', apiUrl);
    
    // ×©×œ×— ×œ×©×¨×ª
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(settings)
    });
    
    console.log('Response status:', response.status);
    console.log('Response headers:', [...response.headers.entries()]);
    console.log('Response ok:', response.ok);
    
    if (!response.ok) {
      throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
    }
    
    let result;
    try {
      result = await response.json();
      console.log('Response data:', result);
    } catch (parseError) {
      console.error('Failed to parse JSON response:', parseError);
      const textResponse = await response.text();
      console.log('Raw response:', textResponse);
      throw new Error('×”×©×¨×ª ×”×—×–×™×¨ ×ª×’×•×‘×” ×œ× ×ª×§×™× ×”');
    }
    
    if (result.success === true) {
      showNotification('×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”! âœ…', 'success');
      
      // ×¡×’×•×¨ ××ª ×”×ª×¤×¨×™×˜
      document.getElementById('settings-dropdown').style.display = 'none';
      const arrow = document.getElementById('settings-toggle').querySelector('span');
      if (arrow) {
        arrow.textContent = 'â–¼';
      }
      
      console.log('Settings saved successfully');
    } else {
      console.error('Server error details:', result);
      if (result.debug_info) {
        console.log('Debug info:', result.debug_info);
        
        // ×—×¤×© ××ª ×”-hostname ×©×œ× ×• ×‘××¢×¨×š (×× ×§×™×™×)
        const ourHostname = result.debug_info.received_hostname;
        console.log('Looking for hostname:', ourHostname);
        console.log('Affected rows:', result.debug_info.affected_rows);
        
        if (result.debug_info.all_hostnames_in_db) {
          console.log('All hostnames in DB:', result.debug_info.all_hostnames_in_db);
          result.debug_info.all_hostnames_in_db.forEach((host, index) => {
            console.log(`Host ${index + 1}:`, host);
            if (host.hostname === ourHostname) {
              console.log('*** FOUND MATCH! ***', host);
            }
          });
        }
      }
      throw new Error(result.error || '×©×’×™××” ×œ× ×™×“×•×¢×”');
    }
  } catch (error) {
    console.error('Error saving settings:', error);
    showNotification('×©×’×™××” ×‘×©××™×¨×ª ×”×’×“×¨×•×ª: ' + error.message, 'error');
  }
}

// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×•×“×¢×•×ª ×œ××©×ª××©
function showNotification(message, type = 'info') {
  // ×¦×•×¨ ××œ×× ×˜ ×”×•×“×¢×”
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    font-weight: bold;
    max-width: 300px;
    animation: slideIn 0.3s ease;
  `;
  
  notification.textContent = message;
  document.body.appendChild(notification);
  
  // ×”×¡×¨ ××ª ×”×”×•×“×¢×” ××—×¨×™ 3 ×©× ×™×•×ª
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// ×”×•×¡×£ CSS ×¢×‘×•×¨ ×× ×™××¦×™×•×ª ×”×”×•×“×¢×•×ª
const notificationStyle = document.createElement('style');
notificationStyle.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(notificationStyle);

// ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª ×©× ×”××—×©×‘ - ××©×ª××©×ª ×‘××•×ª×• API ×›××• ×”×§×•×“ ×”×§×™×™×
async function getHostname() {
  try {
    const response = await fetch('/wp-content/postify-api/get-hostname.php');
    if (!response.ok) {
      throw new Error(`HTTP Error: ${response.status}`);
    }
    const hostname = await response.text();
    const trimmedHostname = hostname.trim();
    console.log('Hostname from API:', trimmedHostname);
    return trimmedHostname;
  } catch (error) {
    console.error('Error getting hostname:', error);
    throw error;
  }
}

// ×”×¤×¢×œ ××ª ×¤×•× ×§×¦×™×•×ª ×”×¡×™× ×•×Ÿ ××—×¨×™ ×˜×¢×™× ×ª ×”×“×£
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM Content Loaded - initializing filters and settings');
  setTimeout(() => {
    if (!window.statusFiltersInitialized) {
      initStatusFilters();
      window.statusFiltersInitialized = true;
    }
    
    if (!window.settingsInitialized) {
      initSettingsDropdown();
      window.settingsInitialized = true;
    }
  }, 100);
});
</script>

</body>
</html>